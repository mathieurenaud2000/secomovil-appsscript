<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, shrink-to-fit=no">
  <title>SecoMovil</title>
  <style>
    .btn-noir[data-spinner="1"]{
      position:relative;
      color:transparent !important;
      text-shadow:none !important;
    }
    .btn-noir[data-spinner="1"] > *{ visibility:hidden; }
    .btn-noir[data-spinner="1"]::before{
      content:"";
      position:absolute;
      inset:0;
      margin:auto;
      width:calc(28px * var(--fix));
      height:calc(28px * var(--fix));
      border-radius:50%;
      border:calc(12px * var(--fix)) solid rgba(255,255,255,0.35);
      border-top-color:#fff;
      animation: btnNoirSpin 0.9s linear infinite;
      pointer-events:none;
    }
    @keyframes btnNoirSpin{
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    window.secoSetBlackButtonLoading = function(btn, isLoading){
      if (!btn) return;
      if (isLoading){
        if (btn.dataset.spinner === '1') return;
        btn.disabled = true;
        btn.dataset.spinner = '1';
      } else {
        btn.disabled = false;
        btn.removeAttribute('data-spinner');
      }
    };

    const pageInit = {
  inicio: function(){
    (function(){
        const card = document.getElementById('card1');
        const btnDel = document.getElementById('btnDel');
        const btnConfirm = document.getElementById('btnConfirm');
        const btnDelay = document.getElementById('btnDelay');
        const heureText = document.getElementById('heureText');
        const sectorText = document.getElementById('sectorText');
        const clienteText = document.getElementById('clienteText');
        const direccionText = document.getElementById('direccionText');
        const notaText = document.getElementById('notaText');
        const extraText = document.getElementById('extraText');
        const timeConfirmTitle = document.getElementById('timeConfirmTitle');
        const btnNuevoPedido = document.getElementById('btnNuevoPedido');
        const btnVentaDirecta = document.getElementById('btnVentaDirecta');
        const btnPedidosDelDia = document.getElementById('btnPedidosDelDia');
        const btnRegistrarGasto = document.getElementById('btnRegistrarGasto');
        const btnCerrarElDia = document.getElementById('btnCerrarElDia');
        const btnConfiguracion = document.getElementById('btnConfiguracion');
        const cardLoading = document.getElementById('cardLoading');
        const editCell = card ? card.querySelector('.edit-cell') : null;
        const cardEmptyText = document.getElementById('cardEmptyText');
    
        const overlay = document.getElementById('ddOverlay');
        const overlayList = document.getElementById('ddOverlayList');
    
        const ICONS = {
          trash:   "https://lh3.googleusercontent.com/d/1NEwXtWZqpIJlto9dPs49xKhq3oOqwpXH",
          xgray:   "https://lh3.googleusercontent.com/d/15wgAEpPLmV12eD0dFTr4dD9yZugrNiCs",
          checkBlk:"https://lh3.googleusercontent.com/d/1CiREwW0rHzmdha8SqKtDEqr9iPNW21eG",
          checkW:  "https://lh3.googleusercontent.com/d/1kIWQWxgpGWgRbdiBcm_X1BpwFZkUwX5l"
        };
    
        let normalHeight = null;
        let currentHour = null;
        let pendingHour = null;
        let pedidoActual = null;
        let actionOrigin = null;
        let processingActionBtn = null;
        let topActionEnCours = false;
    
        function captureNormalHeight(){
          const wasConfirm       = card.classList.contains('is-confirm');
          const wasDeleted       = card.classList.contains('is-deleted');
          const wasTimeConfirm   = card.classList.contains('is-timeconfirm');
          const wasDeliveryConf  = card.classList.contains('is-deliveryconfirm');
          const wasDelivered     = card.classList.contains('is-delivered');
    
          card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-deliveryconfirm','is-delivered');
          card.style.height = '';
          normalHeight = card.offsetHeight;
          card.style.height = normalHeight + 'px';
    
          if (wasDeleted) card.classList.add('is-deleted');
          else if (wasDelivered) card.classList.add('is-delivered');
          else if (wasDeliveryConf) card.classList.add('is-deliveryconfirm');
          else if (wasTimeConfirm) card.classList.add('is-timeconfirm');
          else if (wasConfirm) card.classList.add('is-confirm');
        }
    
        function lockToNormalHeight(){
          if (!normalHeight) captureNormalHeight();
          card.style.height = normalHeight + 'px';
        }
    
        function setNormal(){
          card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-deliveryconfirm','is-delivered','is-empty');
          btnDel.querySelector('img').src = ICONS.trash;
          btnConfirm.querySelector('img').src = ICONS.checkW;
          card.style.height = '';
          captureNormalHeight();
          actionOrigin = null;
          clearActionProcessing();
        }
    
        function setConfirm(){
          clearActionProcessing();
          lockToNormalHeight();
          card.classList.add('is-confirm');
          card.classList.remove('is-deleted','is-timeconfirm','is-deliveryconfirm','is-delivered');
          btnDel.querySelector('img').src = ICONS.xgray;
          btnConfirm.querySelector('img').src = ICONS.checkBlk;
          actionOrigin = btnDel;
          setActionProcessing(btnDel, true, false);
        }
    
        function setDeleted(){
          lockToNormalHeight();
          card.classList.add('is-deleted');
          card.classList.remove('is-confirm','is-timeconfirm','is-deliveryconfirm','is-delivered');
        }
    
        function setTimeConfirm(){
          if (!pendingHour) return;
          clearActionProcessing();
          lockToNormalHeight();
          timeConfirmTitle.textContent = pendingHour;
          card.classList.add('is-timeconfirm');
          card.classList.remove('is-confirm','is-deleted','is-deliveryconfirm','is-delivered');
          btnDel.querySelector('img').src = ICONS.xgray;
          btnConfirm.querySelector('img').src = ICONS.checkBlk;
          actionOrigin = btnDelay;
          setActionProcessing(btnDelay, true, false);
        }
    
        function setDeliveryConfirm(){
          clearActionProcessing();
          lockToNormalHeight();
          card.classList.add('is-deliveryconfirm');
          card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-delivered');
          btnDel.querySelector('img').src = ICONS.xgray;
          btnConfirm.querySelector('img').src = ICONS.checkBlk;
          actionOrigin = btnConfirm;
          setActionProcessing(btnConfirm, true, false);
        }
    
        function setDelivered(){
          lockToNormalHeight();
          card.classList.add('is-delivered');
          card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-deliveryconfirm');
        }
    
        function setButtonLoading(btn, isLoading){
          if (!btn) return;
          var loadingColor = 'rgba(255,255,255,0.5)';
          if (isLoading){
            if (!btn.dataset.originalColor){
              var computed = window.getComputedStyle ? getComputedStyle(btn).color : btn.style.color;
              btn.dataset.originalColor = computed || '';
            }
            btn.disabled = true;
            btn.style.color = loadingColor;
          } else {
            btn.disabled = false;
            btn.style.color = btn.dataset.originalColor || '';
          }
        }
    
        function setHalfLoading(el, isLoading){
          if (!el) return;
          if (isLoading){
            el.dataset.loading = '1';
            el.classList.add('is-loading');
            el.style.pointerEvents = 'none';
          } else {
            el.dataset.loading = '0';
            el.classList.remove('is-loading');
            el.style.pointerEvents = '';
          }
        }

        function setEditLoading(isLoading){
          if (!editCell) return;
          editCell.classList.toggle('is-editloading', !!isLoading);
        }
    
        function setCardLoading(isLoading){
          if (!card || !cardLoading) return;
          if (isLoading){
            card.classList.add('is-loading');
          } else {
            card.classList.remove('is-loading');
          }
        }

        function setConfirmButtonLoading(isLoading){
          // Gestion du spinner local sur le bouton de confirmation en bas de la carte
          if (!btnConfirm) return;
          if (isLoading){
            btnConfirm.classList.add('is-loading-confirm');
            btnConfirm.disabled = true;
          } else {
            btnConfirm.classList.remove('is-loading-confirm');
            btnConfirm.disabled = false;
          }
        }

        function setButtonWaiting(btn, isWaiting){
          if (!btn) return;
          btn.classList.toggle('is-waiting', !!isWaiting);
          btn.disabled = !!isWaiting;
        }

        function setActionProcessing(btn, isProcessing, lockButton){
          if (!btn) return;
          const icon = btn.querySelector('.act-icon');
          if (!icon) return;
          const shouldLock = lockButton !== false;
          if (isProcessing){
            icon.classList.add('is-processing');
            if (shouldLock) btn.disabled = true;
            processingActionBtn = btn;
          } else {
            icon.classList.remove('is-processing');
            if (shouldLock) btn.disabled = false;
            if (processingActionBtn === btn){
              processingActionBtn = null;
            }
          }
        }

        function clearActionProcessing(){
          if (processingActionBtn){
            setActionProcessing(processingActionBtn, false);
          }
        }

        function bindNavigationButton(btn, pageName, startFn, endFn){
          if (!btn) return;
          btn.addEventListener('click', function(){
            if (btn.dataset.navLoading === '1') return;
            btn.dataset.navLoading = '1';
            if (startFn) startFn(btn);
            loadPage(pageName, function(){
              btn.dataset.navLoading = '0';
              if (endFn) endFn(btn);
            });
          });
        }

        function bindTopHalfAction(btn, pageName){
          if (!btn) return;
          btn.addEventListener('click', function(){
            if (topActionEnCours) return;
            topActionEnCours = true;
            setHalfLoading(btn, true);
            loadPage(pageName, function(){
              setHalfLoading(btn, false);
              topActionEnCours = false;
            });
          });
        }
    
        function formatHour(hora){
          if (!hora) return '--:--';
    
          if (hora instanceof Date){
            return `${hora.getHours()}:${hora.getMinutes().toString().padStart(2, '0')}`;
          }
    
          const raw = String(hora).trim();
          const direct = raw.match(/(\d{1,2}):(\d{2})/);
          if (direct){
            return `${Number(direct[1])}:${direct[2]}`;
          }
    
          const parsed = new Date(raw);
          if (!isNaN(parsed.getTime())){
            return `${parsed.getHours()}:${parsed.getMinutes().toString().padStart(2, '0')}`;
          }
    
          return raw;
        }
    
        function formatMoney(value){
          if (typeof value !== 'number' || !isFinite(value)) return null;
          return value.toFixed(2).replace('.', ',');
        }
    
        function renderPedido(pedido){
          card.style.display = '';

          if (!pedido){
            pedidoActual = null;
            card.classList.add('is-empty');
            card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-deliveryconfirm','is-delivered');
            heureText.textContent = '--:--';
            sectorText.textContent = '—';
            clienteText.textContent = '—';
            direccionText.textContent = '—';
            notaText.textContent = '';
            extraText.textContent = '';
            currentHour = '--:--';
            if (cardEmptyText){
              cardEmptyText.innerHTML = 'Sin pedido<br>Pendiente';
            }
            clearActionProcessing();
            lockToNormalHeight();
            return;
          }

          card.classList.remove('is-empty');
          const sector = pedido.cliente && pedido.cliente.sector ? pedido.cliente.sector : '—';
          const nombre = pedido.cliente && pedido.cliente.nombre ? pedido.cliente.nombre.toUpperCase() : '—';
          const direccion = pedido.cliente && pedido.cliente.direccion ? pedido.cliente.direccion : '—';
          const notas = pedido.notas ? `Nota : ${pedido.notas}` : '';
    
          const cantidadValida = typeof pedido.cantidad === 'number' && isFinite(pedido.cantidad) && pedido.cantidad > 0;
          const totalValido = typeof pedido.total === 'number' && isFinite(pedido.total);
          let resumenExtra = '';
          if (cantidadValida && totalValido){
            const unitPrice = pedido.total / pedido.cantidad;
            const cantidadTxt = `${pedido.cantidad} seco${pedido.cantidad === 1 ? '' : 's'}`;
            const unitTxt = formatMoney(unitPrice);
            const totalTxt = formatMoney(pedido.total);
            if (unitTxt && totalTxt){
              resumenExtra = `${cantidadTxt} x ${unitTxt} $ = ${totalTxt} $`;
            }
          }
    
          pedidoActual = pedido;
          const horaFormateada = formatHour(pedido.horaEntrega);
          heureText.textContent = horaFormateada;
          sectorText.textContent = sector || '—';
          clienteText.textContent = nombre || '—';
          direccionText.textContent = direccion || '—';
          notaText.textContent = notas;
          extraText.textContent = resumenExtra;
          currentHour = horaFormateada;
          setNormal();
          captureNormalHeight();
        }
    
        function cargarProximoPedido(){
          card.classList.remove('is-deleted','is-delivered');
          setCardLoading(true);
          google.script.run
            .withSuccessHandler(function(resp){
              if (resp && resp.ok && resp.data){
                renderPedido(resp.data.pedido);
              } else {
                renderPedido(null);
              }
              setCardLoading(false);
            })
            .withFailureHandler(function(){ renderPedido(null); setCardLoading(false); })
            .getProximaEntrega();
        }
    
        function actualizarEstado(estado){
          if (!pedidoActual || !pedidoActual.idPedido) return;
          const processingBtn = actionOrigin || btnConfirm;
          setCardLoading(true);
          setButtonLoading(btnConfirm, true);
          setConfirmButtonLoading(true);
          setActionProcessing(processingBtn, true);
          google.script.run
            .withSuccessHandler(function(){
              setActionProcessing(processingBtn, false);
              setButtonLoading(btnConfirm, false);
              setConfirmButtonLoading(false);
              setNormal();
              cargarProximoPedido();
            })
            .withFailureHandler(function(){
              setActionProcessing(processingBtn, false);
              setButtonLoading(btnConfirm, false);
              setConfirmButtonLoading(false);
              setCardLoading(false);
            })
            .actualizarEstadoPedido({ idPedido: pedidoActual.idPedido, estado: estado });
        }

        function actualizarHora(nuevaHora){
          if (!pedidoActual || !pedidoActual.idPedido || !nuevaHora) return;
          const processingBtn = actionOrigin || btnConfirm;
          setCardLoading(true);
          setButtonLoading(btnConfirm, true);
          setConfirmButtonLoading(true);
          setActionProcessing(processingBtn, true);
          google.script.run
            .withSuccessHandler(function(resp){
              setActionProcessing(processingBtn, false);
              setButtonLoading(btnConfirm, false);
              setConfirmButtonLoading(false);
              if (resp && resp.ok && resp.data && resp.data.pedido){
                renderPedido(resp.data.pedido);
              }
              setNormal();
              setCardLoading(false);
            })
            .withFailureHandler(function(){
              setActionProcessing(processingBtn, false);
              setButtonLoading(btnConfirm, false);
              setConfirmButtonLoading(false);
              setNormal();
              setCardLoading(false);
            })
            .cambiarHoraPedido({ idPedido: pedidoActual.idPedido, nuevaHora: nuevaHora });
        }
    
        btnDel.addEventListener('click', function(e){
          e.stopPropagation();
          if (!pedidoActual) return;
          if (card.classList.contains('is-confirm') || card.classList.contains('is-timeconfirm') || card.classList.contains('is-deliveryconfirm')){
            setNormal();
          } else {
            setConfirm();
          }
        });
    
        btnConfirm.addEventListener('click', function(e){
          e.stopPropagation();
          if (!pedidoActual) return;
          if (card.classList.contains('is-confirm')){
            actualizarEstado('Cancelado');
          } else if (card.classList.contains('is-timeconfirm')){
            if (pendingHour){
              actualizarHora(pendingHour);
              pendingHour = null;
            }
          } else if (card.classList.contains('is-deliveryconfirm')){
            actualizarEstado('Entregado');
          } else {
            setDeliveryConfirm();
          }
        });
    
        card.addEventListener('click', function(){
          if (card.classList.contains('is-deleted') || card.classList.contains('is-delivered')){
            setNormal();
          }
        });
    
        function pad(n){ return n<10 ? '0'+n : ''+n; }
        function buildTimes(){
          const out=[];
          for(let h=6; h<=18; h++){
            for(let m=0; m<60; m+=5){
              if(h===18 && m>55) break;
              out.push(h+":"+pad(m));
            }
          }
          return out;
        }
    
        function openHoursOverlay(){
          if (!pedidoActual) return;
          overlayList.innerHTML = '';
    
          function markSelectedOption(optionEl){
            overlayList.querySelectorAll('.dd-grid-option.is-selected').forEach(function(node){
              node.classList.remove('is-selected');
            });
            if (optionEl){
              optionEl.classList.add('is-selected');
            }
          }
    
          const selectedHour = pendingHour || currentHour;

          const ph = document.createElement('li');
          ph.className = 'dd-grid-option placeholder';
          ph.textContent = 'Heure';
          ph.addEventListener('click', () => closeOverlay());
          overlayList.appendChild(ph);
    
          const times = buildTimes();
          let col = 1;
          let rowCount = 0;
    
          times.forEach((txt, idx) => {
            const li = document.createElement('li');
            li.className = 'dd-grid-option';
            li.dataset.col = String(col);
            li.textContent = txt;
            li.addEventListener('click', () => {
              pendingHour = txt;
              markSelectedOption(li);
              requestAnimationFrame(() => {
                setTimeout(() => {
                  closeOverlay();
                  setTimeConfirm();
                }, 80);
              });
            });
            overlayList.appendChild(li);

            if (selectedHour && txt === selectedHour){
              markSelectedOption(li);
            }

            col = (col % 3) + 1;
            if ((idx+1) % 3 === 0){
              rowCount++;
              if (rowCount === 4 && idx < times.length - 1){
                const sep = document.createElement('li');
                sep.className = 'dd-grid-sep-black';
                overlayList.appendChild(sep);
                rowCount = 0;
              }
            }
          });
    
          overlay.setAttribute('data-open','true');
          document.body.style.overflow = 'hidden';
        }
    
        function closeOverlay(){
          overlay.removeAttribute('data-open');
          document.body.style.overflow = '';
          if (!pendingHour && actionOrigin === btnDelay){
            clearActionProcessing();
            actionOrigin = null;
          }
        }
    
        btnDelay.addEventListener('click', function(e){
          e.stopPropagation();
          if (!pedidoActual) return;
          setActionProcessing(btnDelay, true, false);
          actionOrigin = btnDelay;
          openHoursOverlay();
        });
    
        overlay.addEventListener('click', function(e){
          if (e.target === overlay) closeOverlay();
        });
    
        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && overlay.getAttribute('data-open')){
            closeOverlay();
          }
        });

        function prepararCtxEditarPedido(){
          if (!pedidoActual) return null;
          var ctx = {
            origen: 'inicio',
            pedidoId: pedidoActual.idPedido || '',
            pedido: pedidoActual,
            cliente: pedidoActual.cliente || null,
            idContacto: (pedidoActual.cliente && pedidoActual.cliente.idCliente) ? pedidoActual.cliente.idCliente : ''
          };
          window.SECO_CTX = ctx;
          return ctx;
        }

        if (editCell){
          editCell.addEventListener('click', function(){
            if (!pedidoActual || editCell.dataset.editing === '1') return;
            editCell.dataset.editing = '1';
            setEditLoading(true);
            prepararCtxEditarPedido();
            if (pedidoActual) {
              window.SECO_CTX = window.SECO_CTX || {};
              window.SECO_CTX.pedidoEnEdicion = pedidoActual;
            }
            loadPage('editarPedido', function(){
              setEditLoading(false);
              editCell.dataset.editing = '0';
            });
          });
        }
    
        function applyScaleFix(){
          let cssW = window.innerWidth;
          let screenW = Math.min(window.screen.width, window.screen.height);
          if (cssW >= 960 && cssW <= 1024){
            let fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
          setTimeout(captureNormalHeight, 0);
        }
    
        bindTopHalfAction(btnNuevoPedido, 'nuevoPedido');
        bindTopHalfAction(btnVentaDirecta, 'ventaDirecta');
        bindNavigationButton(btnPedidosDelDia, 'pedidosDelDia', (btn) => setButtonWaiting(btn, true), (btn) => setButtonWaiting(btn, false));
        bindNavigationButton(btnRegistrarGasto, 'registrarGasto', (btn) => setButtonWaiting(btn, true), (btn) => setButtonWaiting(btn, false));
        bindNavigationButton(btnCerrarElDia, 'cerrarElDia', (btn) => setButtonWaiting(btn, true), (btn) => setButtonWaiting(btn, false));
        bindNavigationButton(btnConfiguracion, 'configuracionDelSistema', (btn) => setButtonWaiting(btn, true), (btn) => setButtonWaiting(btn, false));
    
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', ()=>{
            currentHour = heureText.textContent.trim();
            applyScaleFix();
            captureNormalHeight();
            setCardLoading(true);
            cargarProximoPedido();
          });
        } else {
          currentHour = heureText.textContent.trim();
          applyScaleFix();
          captureNormalHeight();
          setCardLoading(true);
          cargarProximoPedido();
        }
    
        window.addEventListener('resize', ()=>{
          applyScaleFix();
          if (!card.classList.contains('is-confirm') &&
              !card.classList.contains('is-deleted') &&
              !card.classList.contains('is-timeconfirm') &&
              !card.classList.contains('is-deliveryconfirm') &&
              !card.classList.contains('is-delivered') &&
              !card.classList.contains('is-empty')){
            captureNormalHeight();
          } else {
            lockToNormalHeight();
          }
        });
    
      })();
  },

  nuevoPedido: function(){
    function applyScaleFix(){
          var cssW = window.innerWidth || document.documentElement.clientWidth;
          var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
          if (cssW >= 960 && cssW <= 1024) {
            var fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
        }
    
        function sizeHeaderImage(){
          var img = document.getElementById('headerImg');
          var wrap = document.querySelector('.wrapper');
          if (!img || !wrap) return;
          var w = Math.floor(wrap.clientWidth);
          if (w > 0){
            img.style.width = w + 'px';
            img.style.maxWidth = '100%';
            img.removeAttribute('height');
          }
        }
    
        var overlay     = document.getElementById('ddOverlay');
        var overlayList = document.getElementById('ddOverlayList');
        var contactBtn  = document.getElementById('contactBtn');
        var btnOK       = document.getElementById('btnOK');
        var btnVolver   = document.getElementById('btnVolverInicio');

        var contactosOpciones = [];
        var contactoSeleccionado = null;
        var ctxCache = null;

        function setPedidoIdHeaderDesdeValor(idPedido){
          var cont = document.getElementById('pedidoIdHeader');
          if (!cont) return;

          var txt = cont.querySelector('#pedidoIdTexto');
          var loader = cont.querySelector('.pedido-id-loader');

          var valor = (idPedido || '').toString().trim();
          var tieneValor = !!valor;

          if (txt){
            txt.textContent = valor;
            txt.style.display = tieneValor ? '' : 'none';
          }

          if (loader){
            loader.style.display = tieneValor ? 'none' : '';
          }
        }
    
        function setButtonLoading(btn, isLoading){
          if (!btn) return;
          if (isLoading){
            if (!btn.dataset.originalColor){
              var computed = window.getComputedStyle ? getComputedStyle(btn).color : btn.style.color;
              btn.dataset.originalColor = computed || '';
            }
            btn.disabled = true;
            btn.style.color = 'rgba(255,255,255,0.5)';
          } else {
            btn.disabled = false;
            btn.style.color = btn.dataset.originalColor || '';
          }
        }

        function setButtonSpinner(btn, isLoading, color){
          if (!btn) return;
          if (btn.classList.contains('btn-noir')){
            if (isLoading){
              window.secoSetBlackButtonLoading(btn, true);
            } else {
              window.secoSetBlackButtonLoading(btn, false);
            }
            return;
          }
          if (isLoading){
            if (!btn.dataset.originalHtml){
              btn.dataset.originalHtml = btn.innerHTML;
            }
            btn.innerHTML = '<span class="btn-spinner' + (color === 'black' ? ' black' : '') + '" aria-hidden="true"></span>';
            btn.disabled = true;
          } else {
            btn.disabled = false;
            if (btn.dataset.originalHtml){
              btn.innerHTML = btn.dataset.originalHtml;
              delete btn.dataset.originalHtml;
            }
          }
        }

        function obtenerCtxServidor(){
          if (ctxCache) return ctxCache;
          if (typeof window !== 'undefined' && window.SECO_CTX) {
            ctxCache = window.SECO_CTX;
            return ctxCache;
          }
          return null;
        }
    
        function cuandoCtxListo(callback, intento){
          var ctx = obtenerCtxServidor();
          if (ctx) {
            callback(ctx);
            return;
          }
          var intentoActual = intento || 0;
          if (intentoActual >= 50) return; // ~4s
          setTimeout(function(){
            cuandoCtxListo(callback, intentoActual + 1);
          }, 80);
        }
    
        function construirOpcionesContactos(){
          var ctx = obtenerCtxServidor();
          if (!ctx) return;
          var clientes = Array.isArray(ctx.clientes) ? ctx.clientes : [];
          var opciones = [{ label: 'Nuevo contacto', isNuevo: true }];
    
          clientes.forEach(function(cli){
            opciones.push({
              label: cli && cli.nombre ? cli.nombre : 'Contacto',
              idCliente: (cli && cli.idCliente) ? cli.idCliente : '',
              cliente: cli || null
            });
          });
    
          contactosOpciones = opciones;
        }
    
        function actualizarEstadoBtnOK(){
          var habilitado = !!contactoSeleccionado;
          btnOK.disabled = !habilitado;
          btnOK.classList.toggle('btn-noir', habilitado);
          btnOK.classList.toggle('btn-desactive', !habilitado);
        }
    
        contactBtn.addEventListener('click', function(){
          cuandoCtxListo(function(){
            construirOpcionesContactos();
            overlayList.innerHTML = "";
    
            contactosOpciones.forEach(function(opt){
              var li = document.createElement('li');
              li.className = "dd-overlay-option";
              li.textContent = opt.label;
              li.dataset.isNuevo = opt.isNuevo ? '1' : '0';
              li.addEventListener('click', function(){
                contactoSeleccionado = opt;
                contactBtn.querySelector('.dd-label').textContent = opt.label;
                contactBtn.removeAttribute('data-placeholder');
                overlay.setAttribute('data-open','false');
                document.body.style.overflow = '';
                actualizarEstadoBtnOK();
              });
              overlayList.appendChild(li);
            });
    
            overlay.setAttribute('data-open','true');
            document.body.style.overflow = 'hidden';
          });
        });
    
        overlay.addEventListener('click', function(e){
          if (e.target === overlay){
            overlay.setAttribute('data-open','false');
            document.body.style.overflow = '';
          }
        });
    
        // ===== BRANCHEMENT OK → NUEVO CONTACTO ou REGISTRAR PEDIDO =====
        btnOK.addEventListener('click', function(){
          if (btnOK.disabled) return;
          setButtonSpinner(btnOK, true);

          var ctx = obtenerCtxServidor() || {};
          var pedidoId = ctx.idPedido || ctx.pedidoId || '';

          var payload = Object.assign({}, ctx, {
            origen: 'nuevoPedido',
            pedidoId: pedidoId || '',
            idPedido: pedidoId || '',
            clienteNombre: '',
            idCliente: '',
            idContacto: ctx.idContacto || ctx.nextIdCliente || ''
          });

          if (contactoSeleccionado && contactoSeleccionado.isNuevo){
            // Ouvrir la page NUEVO CONTACTO
            window.SECO_CTX = payload;
            ctxCache = payload;
            loadPage('nuevoContacto');
          } else {
            var cli = contactoSeleccionado && contactoSeleccionado.cliente ? contactoSeleccionado.cliente : null;
            payload.clienteNombre = contactoSeleccionado ? contactoSeleccionado.label : '';
            payload.idCliente = (contactoSeleccionado && contactoSeleccionado.idCliente) ? contactoSeleccionado.idCliente : '';
            payload.cliente = cli;
            // Ouvrir directement la page REGISTRAR PEDIDO pour ce client
            payload.idContacto = payload.idCliente;
            window.SECO_CTX = payload;
            ctxCache = payload;
            loadPage('registrarPedido');
          }
        });
    
        if (btnVolver){
          btnVolver.addEventListener('click', function(){
            setButtonSpinner(btnVolver, true, 'black');
            loadPage('inicio', function(){
              setButtonSpinner(btnVolver, false, 'black');
            });
          });
        }
    
        function init(){
          applyScaleFix();
          sizeHeaderImage();

          if (window.google && google.script && google.script.run){
            google.script.run
              .withSuccessHandler(function(resp){
                if (resp && resp.ok && resp.data){
                  window.SECO_CTX = resp.data;
                  ctxCache = resp.data;

                  setPedidoIdHeaderDesdeValor(resp.data.idPedido);

                  construirOpcionesContactos();
                  actualizarEstadoBtnOK();
                } else {
                  setPedidoIdHeaderDesdeValor('');
                }
              })
              .withFailureHandler(function(){
                setPedidoIdHeaderDesdeValor('');
              })
              .initNuevoPedido();
          } else {
            setPedidoIdHeaderDesdeValor('');
          }
        }
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
    
        window.addEventListener('resize', function(){
          applyScaleFix();
          sizeHeaderImage();
        });
  },

  nuevoContacto: function(){
    function applyScaleFix(){
          var cssW = window.innerWidth || document.documentElement.clientWidth;
          var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
          if (cssW >= 960 && cssW <= 1024) {
            var fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
        }
    
        function sizeHeaderImage(){
          var img = document.getElementById('headerImg');
          var wrap = document.querySelector('.wrapper');
          if (!img || !wrap) return;
          var w = Math.floor(wrap.clientWidth);
          if (w > 0){
            img.style.width = w + 'px';
            img.style.maxWidth = '100%';
            img.removeAttribute('height');
          }
        }
    
        /* Références des champs pour la validation */
        var overlay      = document.getElementById('ddOverlay');
        var overlayList  = document.getElementById('ddOverlayList');
        var sectorBtn    = document.getElementById('sectorBtn');
        var btnGuardar   = document.getElementById('btnGuardar');
        var btnVolverIni = document.getElementById('btnVolverInicio');
    
        var nombreEl   = document.getElementById('nombre');
        var dirEl      = document.getElementById('direccion');
        var notaEl     = document.getElementById('nota');
        var whatsappEl = document.getElementById('whatsapp');

        var ctxCache = null;
        var sectoresOpciones = [];

        function setButtonLoading(btn, isLoading){
          if (!btn) return;
          if (isLoading){
            if (!btn.dataset.originalColor){
              var computed = window.getComputedStyle ? getComputedStyle(btn).color : btn.style.color;
              btn.dataset.originalColor = computed || '';
            }
            btn.disabled = true;
            btn.style.color = 'rgba(255,255,255,0.5)';
          } else {
            btn.disabled = false;
            btn.style.color = btn.dataset.originalColor || '';
          }
        }

        function setButtonSpinner(btn, isLoading, color){
          if (!btn) return;
          if (btn.classList.contains('btn-noir')){
            if (isLoading){
              window.secoSetBlackButtonLoading(btn, true);
            } else {
              window.secoSetBlackButtonLoading(btn, false);
            }
            return;
          }
          if (isLoading){
            if (!btn.dataset.originalHtml){
              btn.dataset.originalHtml = btn.innerHTML;
            }
            btn.innerHTML = '<span class="btn-spinner' + (color === 'black' ? ' black' : '') + '" aria-hidden="true"></span>';
            btn.disabled = true;
          } else {
            btn.disabled = false;
            if (btn.dataset.originalHtml){
              btn.innerHTML = btn.dataset.originalHtml;
              delete btn.dataset.originalHtml;
            }
          }
        }
    
        function obtenerCtxServidor(){
          if (ctxCache) return ctxCache;
          if (typeof window !== 'undefined' && window.SECO_CTX) {
            ctxCache = window.SECO_CTX;
            return ctxCache;
          }
          return null;
        }
    
        function cuandoCtxListo(callback, intento){
          var ctx = obtenerCtxServidor();
          if (ctx) {
            callback(ctx);
            return;
          }
          var intentoActual = (intento || 0);
          if (intentoActual >= 50) return; // ~4s max si 80ms
          setTimeout(function(){
            cuandoCtxListo(callback, intentoActual + 1);
          }, 80);
        }
    
        function setContactoIdDesdeCtx(ctx){
          var idEl = document.getElementById('contactoId');
          if (!idEl || !ctx) return;
          var txtEl = document.getElementById('contactoIdTexto');
          var loaderEl = idEl.querySelector('.pedido-id-loader');
          var idContacto = (ctx && (ctx.idContacto || ctx.nextIdCliente)) ? (ctx.idContacto || ctx.nextIdCliente) : '';
          var tiene = !!idContacto;

          if (txtEl){
            txtEl.textContent = idContacto;
            txtEl.style.display = tiene ? '' : 'none';
          }
          if (loaderEl){
            loaderEl.style.display = tiene ? 'none' : '';
          }
        }
    
        function esWhatsappValido(valor){
          var limpio = (valor || '').toString().trim();
          return /^\d{7,15}$/.test(limpio);
        }
    
        function validarWhatsappCampo(){
          var errorEl = document.getElementById('whatsappError');
          if (!errorEl) return esWhatsappValido(whatsappEl.value);
    
          var valor = (whatsappEl.value || '').toString().trim();
          if (!valor){
            errorEl.textContent = '';
            return false;
          }
    
          var valido = esWhatsappValido(valor);
          errorEl.textContent = valido ? '' : 'Número de WhatsApp inválido';
          return valido;
        }
    
        function champsRemplis(){
          var nomOK    = nombreEl.value.trim()   !== '';
          var dirOK    = dirEl.value.trim()      !== '';
          var waOK     = esWhatsappValido(whatsappEl.value);
          var sectorOK = !sectorBtn.hasAttribute('data-placeholder');
          // Nota est optionnel → non pris en compte
          return nomOK && dirOK && waOK && sectorOK;
        }
    
        function majBoutonGuardar(){
          var waValido = validarWhatsappCampo();
          if (champsRemplis() && waValido){
            btnGuardar.disabled = false;
            btnGuardar.classList.remove('btn-desactive');
            btnGuardar.classList.add('btn-noir');
          } else {
            btnGuardar.disabled = true;
            btnGuardar.classList.remove('btn-noir');
            btnGuardar.classList.add('btn-desactive');
          }
        }

        function cargarSectoresDesdeServidor(callback) {
          google.script.run
            .withSuccessHandler(function(resp) {
              if (resp && resp.ok && Array.isArray(resp.sectores)) {
                sectoresOpciones = resp.sectores
                  .map(function(sec){ return (sec && sec.nombre) ? sec.nombre : sec; })
                  .filter(Boolean);
              } else {
                sectoresOpciones = [];
              }
              if (typeof callback === 'function') callback();
            })
            .withFailureHandler(function() {
              sectoresOpciones = [];
              if (typeof callback === 'function') callback();
            })
            .listarSectores();
        }

        /* Dropdown simple pour "Sector" */
        function openSectorDropdown(){
          if (!sectoresOpciones.length) {
            cargarSectoresDesdeServidor(function(){
              if (sectoresOpciones.length) openSectorDropdown();
            });
            return;
          }

          overlayList.innerHTML = "";

          sectoresOpciones.forEach(function(txt){
            var li = document.createElement('li');
            li.className = "dd-overlay-option";
            li.textContent = txt;
            li.addEventListener('click', function(){
              sectorBtn.querySelector('.dd-label').textContent = txt;
              sectorBtn.removeAttribute('data-placeholder');
              overlay.setAttribute('data-open','false');
              document.body.style.overflow = '';
              majBoutonGuardar();
            });
            overlayList.appendChild(li);
          });
    
          overlay.setAttribute('data-open','true');
          document.body.style.overflow = 'hidden';
        }
    
        sectorBtn.addEventListener('click', openSectorDropdown);
    
        overlay.addEventListener('click', function(e){
          if (e.target === overlay){
            overlay.setAttribute('data-open','false');
            document.body.style.overflow = '';
          }
        });
    
        /* Écouteurs sur les champs pour activer/désactiver GUARDAR */
        ['input','change'].forEach(function(ev){
          nombreEl.addEventListener(ev, majBoutonGuardar);
          dirEl.addEventListener(ev, majBoutonGuardar);
          // notaEl est optionnel → pas nécessaire dans la logique d'activation
          whatsappEl.addEventListener(ev, majBoutonGuardar);
        });
    
        /* Clic sur GUARDAR : créer le client puis ouvrir registrarPedido */
        btnGuardar.addEventListener('click', function(){
          if (btnGuardar.disabled) return;
    
          var whatsappValido = validarWhatsappCampo();
          if (!whatsappValido){
            whatsappEl.focus();
            return;
          }
    
          var sectorText = sectorBtn.querySelector('.dd-label')
            ? sectorBtn.querySelector('.dd-label').textContent.trim()
            : '';
    
          var ctxActual = obtenerCtxServidor();
    
          var datosCliente = {
            idContacto: (ctxActual && ctxActual.idContacto) ? ctxActual.idContacto : '',
            pedidoId:   (ctxActual && ctxActual.pedidoId) ? ctxActual.pedidoId : '',
            nombre:    nombreEl.value.trim(),
            direccion: dirEl.value.trim(),
            telefono:  whatsappEl.value.trim(),
            sector:    sectorText,
            nota:      notaEl.value.trim()
          };

          setButtonSpinner(btnGuardar, true);
          if (btnVolverIni) btnVolverIni.disabled = true;

          google.script.run
            .withSuccessHandler(function(resp){
              if (!resp || (!resp.ok && !resp.success) || !resp.data || !resp.data.cliente){
                setButtonSpinner(btnGuardar, false);
                if (btnVolverIni) btnVolverIni.disabled = false;
                var msg = (resp && resp.error) ? resp.error : 'Error al crear el cliente.';
                alert(msg);
                return;
              }

              var cliente = resp.data.cliente; // { idCliente, nombre, telefono, direccion, sector, nota }

              var ctxNuevoPedido = obtenerCtxServidor() || {};

              var pedidoIdNuevo = (resp.data && (resp.data.pedidoId || resp.data.idPedido))
                ? (resp.data.pedidoId || resp.data.idPedido)
                : (ctxNuevoPedido.pedidoId || ctxNuevoPedido.idPedido || datosCliente.pedidoId || '');

              var payload = Object.assign({}, ctxNuevoPedido, {
                origen: 'nuevoContacto',
                pedidoId: pedidoIdNuevo,
                idPedido: pedidoIdNuevo,
                idContacto: (resp.data && resp.data.idContacto) ? resp.data.idContacto : (ctxNuevoPedido.idContacto || datosCliente.idContacto || ''),
                clienteNombre: (resp.data && resp.data.clienteNombre) ? resp.data.clienteNombre : (cliente.nombre || ''),
                cliente: cliente
              });

              window.SECO_CTX = payload;
              ctxCache = payload;

              loadPage('registrarPedido');
            })
            .withFailureHandler(function(err){
              setButtonSpinner(btnGuardar, false);
              if (btnVolverIni) btnVolverIni.disabled = false;
              var msg = (err && err.message) ? err.message : 'Error al crear el cliente.';
              alert(msg);
            })
            .registrarNuevoContacto(datosCliente, ctxActual);
        });
    
        /* Clic sur VOLVER AL INICIO : reset + abrirInicio() */
        btnVolverIni.addEventListener('click', function(){
          setButtonSpinner(btnVolverIni, true, 'black');
          if (btnGuardar) btnGuardar.disabled = true;
          // Effacer les champs
          nombreEl.value   = '';
          dirEl.value      = '';
          notaEl.value     = '';
          whatsappEl.value = '';
    
          // Réinitialiser le dropdown Sector
          sectorBtn.setAttribute('data-placeholder', 'true');
          var lbl = sectorBtn.querySelector('.dd-label');
          if (lbl){
            lbl.textContent = 'Elegir un sector';
          }

          majBoutonGuardar();

          window.SECO_CTX = null;
          ctxCache = null;

          // Ouvrir la page inicio.html côté serveur
          loadPage('inicio');
        });
    
        function init(){
          applyScaleFix();
            sizeHeaderImage();

          cuandoCtxListo(function(ctx){
            ctxCache = ctx;
            setContactoIdDesdeCtx(ctx);
            majBoutonGuardar();
          });

          cargarSectoresDesdeServidor();
          majBoutonGuardar();
        }
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
    
        window.addEventListener('resize', function(){
          applyScaleFix();
          sizeHeaderImage();
        });
  },

  editarContacto: function(){
    function applyScaleFix(){
          var cssW = window.innerWidth || document.documentElement.clientWidth;
          var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
          if (cssW >= 960 && cssW <= 1024) {
            var fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
        }
    
        function sizeHeaderImage(){
          var img = document.getElementById('headerImg');
          var wrap = document.querySelector('.wrapper');
          if (!img || !wrap) return;
          var w = Math.floor(wrap.clientWidth);
          if (w > 0){
            img.style.width = w + 'px';
            img.style.maxWidth = '100%';
            img.removeAttribute('height');
          }
        }
    
        var overlay      = document.getElementById('ddOverlay');
        var overlayList  = document.getElementById('ddOverlayList');
        var sectorBtn    = document.getElementById('sectorBtn');
        var btnGuardar   = document.getElementById('btnGuardar');
        var btnVolverIni = document.getElementById('btnVolverInicio');
    
        var nombreEl   = document.getElementById('nombre');
        var dirEl      = document.getElementById('direccion');
        var notaEl     = document.getElementById('nota');
        var whatsappEl = document.getElementById('whatsapp');
    
        var ctxCache = null;
        var sectoresOpciones = [];
    
        function obtenerCtxServidor(){
          if (ctxCache) return ctxCache;
          if (typeof window !== 'undefined' && window.SECO_CTX){
            ctxCache = window.SECO_CTX;
            return ctxCache;
          }
          return null;
        }
    
        function cuandoCtxListo(callback, intento){
          var ctx = obtenerCtxServidor();
          if (ctx){
            callback(ctx);
            return;
          }
          var intentoActual = intento || 0;
          if (intentoActual >= 50) return;
          setTimeout(function(){
            cuandoCtxListo(callback, intentoActual + 1);
          }, 80);
        }
    
        function setContactoIdDesdeCtx(ctx){
          var idEl = document.getElementById('contactoId');
          if (!idEl || !ctx) return;
          var idContacto = (ctx.idContacto || (ctx.cliente && ctx.cliente.idCliente) || '').toString();
          if (idContacto){
            idEl.textContent = idContacto;
          }
        }
    
        function sincronizarSectoresDesdeCtx(ctx){
          var sectores = Array.isArray(ctx && ctx.sectores) ? ctx.sectores : [];
          sectoresOpciones = sectores
            .map(function(sec){ return (sec && sec.nombre) ? sec.nombre : sec; })
            .filter(Boolean);
    
          var dataEl = sectorBtn && sectorBtn.parentNode ? sectorBtn.parentNode.querySelector('.dd-data') : null;
          if (dataEl){
            dataEl.textContent = JSON.stringify(sectoresOpciones);
          }
        }
    
        function esWhatsappValido(valor){
          var limpio = (valor || '').toString().trim();
          return /^\d{7,15}$/.test(limpio);
        }
    
        function validarWhatsappCampo(){
          var errorEl = document.getElementById('whatsappError');
          if (!errorEl) return esWhatsappValido(whatsappEl.value);
    
          var valor = (whatsappEl.value || '').toString().trim();
          if (!valor){
            errorEl.textContent = '';
            return false;
          }
    
          var valido = esWhatsappValido(valor);
          errorEl.textContent = valido ? '' : 'Número de WhatsApp inválido';
          return valido;
        }
    
        function champsRemplis(){
          var nomOK    = nombreEl.value.trim()   !== '';
          var dirOK    = dirEl.value.trim()      !== '';
          var waOK     = esWhatsappValido(whatsappEl.value);
          var sectorOK = !sectorBtn.hasAttribute('data-placeholder');
          return nomOK && dirOK && waOK && sectorOK;
        }
    
        function majBoutonGuardar(){
          var waValido = validarWhatsappCampo();
          if (champsRemplis() && waValido){
            btnGuardar.disabled = false;
            btnGuardar.classList.remove('btn-desactive');
            btnGuardar.classList.add('btn-noir');
          } else {
            btnGuardar.disabled = true;
            btnGuardar.classList.remove('btn-noir');
            btnGuardar.classList.add('btn-desactive');
          }
        }
    
        function poblarFormularioDesdeCtx(ctx){
          if (!ctx) return;
    
          var cliente = ctx.cliente || {};
          nombreEl.value   = cliente.nombre || '';
          dirEl.value      = cliente.direccion || '';
          notaEl.value     = cliente.nota || '';
          whatsappEl.value = cliente.telefono || cliente.whatsapp || '';
    
          var sector = cliente.sector || '';
          var lbl = sectorBtn.querySelector('.dd-label');
          if (sector && lbl){
            lbl.textContent = sector;
            sectorBtn.removeAttribute('data-placeholder');
          }
    
          setContactoIdDesdeCtx(ctx);
        }
    
        function openSectorDropdown(){
          if (!sectoresOpciones.length) {
            cuandoCtxListo(function(ctx){
              sincronizarSectoresDesdeCtx(ctx);
              openSectorDropdown();
            });
            return;
          }
    
          overlayList.innerHTML = "";
    
          sectoresOpciones.forEach(function(txt){
            var li = document.createElement('li');
            li.className = "dd-overlay-option";
            li.textContent = txt;
            li.addEventListener('click', function(){
              sectorBtn.querySelector('.dd-label').textContent = txt;
              sectorBtn.removeAttribute('data-placeholder');
              overlay.setAttribute('data-open','false');
              document.body.style.overflow = '';
              majBoutonGuardar();
            });
            overlayList.appendChild(li);
          });
    
          overlay.setAttribute('data-open','true');
          document.body.style.overflow = 'hidden';
        }
    
        sectorBtn.addEventListener('click', openSectorDropdown);
    
        overlay.addEventListener('click', function(e){
          if (e.target === overlay){
            overlay.setAttribute('data-open','false');
            document.body.style.overflow = '';
          }
        });
    
        ['input','change'].forEach(function(ev){
          nombreEl.addEventListener(ev, majBoutonGuardar);
          dirEl.addEventListener(ev, majBoutonGuardar);
          whatsappEl.addEventListener(ev, majBoutonGuardar);
        });
    
        btnGuardar.addEventListener('click', function(){
          if (btnGuardar.disabled) return;

          var waValido = validarWhatsappCampo();
          if (!waValido){
            whatsappEl.focus();
            return;
          }

          secoSetBlackButtonLoading(btnGuardar, true);

          var sectorText = sectorBtn.querySelector('.dd-label')
            ? sectorBtn.querySelector('.dd-label').textContent.trim()
            : '';
    
          var ctxActual = obtenerCtxServidor() || {};
    
          var datosCliente = {
            idContacto: (ctxActual && (ctxActual.idContacto || (ctxActual.cliente && ctxActual.cliente.idCliente))) || '',
            pedidoId:   (ctxActual && ctxActual.pedidoId) ? ctxActual.pedidoId : '',
            nombre:    nombreEl.value.trim(),
            direccion: dirEl.value.trim(),
            telefono:  whatsappEl.value.trim(),
            sector:    sectorText,
            nota:      notaEl.value.trim()
          };

          google.script.run
            .withSuccessHandler(function(resp){
              if (!resp || !resp.ok || !resp.data || !resp.data.ctx){
                var msg = (resp && resp.error) ? resp.error : 'Error al actualizar el contacto.';
                alert(msg);
                return;
              }
              loadPage('registrarPedido');
            })
            .withFailureHandler(function(err){
              secoSetBlackButtonLoading(btnGuardar, false);
              var msg = (err && err.message) ? err.message : 'Error al actualizar el contacto.';
              alert(msg);
            })
            .actualizarContactoDesdeEditar(datosCliente, ctxActual);
        });
    
        btnVolverIni.addEventListener('click', function(){
          loadPage('inicio');
        });
    
        function init(){
          applyScaleFix();
          sizeHeaderImage();
    
          cuandoCtxListo(function(ctx){
            sincronizarSectoresDesdeCtx(ctx);
            poblarFormularioDesdeCtx(ctx);
            majBoutonGuardar();
          });
        }
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
    
        window.addEventListener('resize', function(){
          applyScaleFix();
          sizeHeaderImage();
        });
  },

  editarPedido: function(){
    var ctx = (typeof window !== 'undefined' && window.SECO_CTX) ? window.SECO_CTX : {};
    var pedido = ctx && ctx.pedidoEnEdicion ? ctx.pedidoEnEdicion : null;

    var overlay      = document.getElementById('ddOverlay');
    var overlayList  = document.getElementById('ddOverlayList');
    var btnVolver    = document.getElementById('btnVolver');
    var btnRegistrar = document.getElementById('btnRegistrar');
    var pedidoIdEl   = document.getElementById('pedidoId');
    var contactEditBtn   = document.querySelector('.contact-edit');

    var overlayListRef = null;
    var currentDropdown = null;
    var contactEditLoading = false;

    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var avail = Math.floor(wrapper.clientWidth);
      if (avail > 0) {
        img.style.width = avail + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    function buildTimes(){
      const out=[];
      for(let h=6;h<=18;h++){
        for(let m=0;m<60;m+=5){
          if(h===18 && m>55) break;
          out.push(String(h).padStart(2,"0")+":"+String(m).padStart(2,"0"));
        }
      }
      return out;
    }

    function normalizarHora(h) {
      if (!h) return '';
      const raw = String(h).trim();

      // Format H:MM ou HH:MM
      const m = raw.match(/(\d{1,2}):(\d{2})/);
      if (m) {
        const hh = m[1].padStart(2, "0");
        const mm = m[2];
        return hh + ":" + mm;
      }

      // Format ISO ou Date()
      const d = new Date(raw);
      if (!isNaN(d.getTime())) {
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return hh + ":" + mm;
      }

      return raw;
    }

          function formatFechaEtiqueta(raw){
        if (!raw) return "";

        var meses = ["Ene.","Feb.","Mar.","Abr.","May.","Jun.","Jul.","Ago.","Sep.","Oct.","Nov.","Dic."];
        var dias  = ["Domingo","Lunes","Martes","Miercoles","Jueves","Viernes","Sabado"];

        var d = null;
        var s = String(raw).trim();

        // Format DD/MM/YYYY
        var mSlash = s.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        if (mSlash){
          var dd = parseInt(mSlash[1], 10);
          var mm = parseInt(mSlash[2], 10) - 1;
          var yyyy = parseInt(mSlash[3], 10);
          d = new Date(yyyy, mm, dd); // LOCAL, pas UTC
        } else {
          // Format YYYY-MM-DD
          var mDash = s.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (mDash){
            var yyyy2 = parseInt(mDash[1], 10);
            var mm2   = parseInt(mDash[2], 10) - 1;
            var dd2   = parseInt(mDash[3], 10);
            d = new Date(yyyy2, mm2, dd2); // LOCAL, pas UTC
          } else {
            // Fallback: laisser le moteur essayer
            var dIso = new Date(s);
            if (!isNaN(dIso.getTime())){
              d = dIso;
            }
          }
        }

        if (!d || isNaN(d.getTime())) return raw;

        var dow = dias[d.getDay()];
        var day = d.getDate();
        var mes = meses[d.getMonth()];

        return dow + ", " + day + " de " + mes;
      }


    function buildDatesStartingTomorrow(count){
      const res = [];
      const hoy = new Date();
      for (let i = 1; i <= count; i++){
        const d = new Date(hoy);
        d.setDate(hoy.getDate() + i);
        const dd  = String(d.getDate()).padStart(2,"0");
        const mm  = String(d.getMonth()+1).padStart(2,"0");
        const yyyy = d.getFullYear();
        const etiqueta = formatFechaEtiqueta(yyyy + "-" + mm + "-" + dd);
        res.push(etiqueta);
      }
      return res;
    }

    function updatePrecioYBoton(){
      var precioBase = 1.00;
      var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
      var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
      var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
      var btn        = document.getElementById('btnRegistrar');
      var precioEl   = document.getElementById('precioValor');

      function isFilled(dd){
        if (!dd) return false;
        var button = dd.querySelector('.dd-button');
        var val = dd.dataset.value || '';
        var isPlaceholder = button && button.getAttribute('data-placeholder') === 'true';
        return !isPlaceholder && val !== '';
      }

      var cantidad = 1;
      if (ddCantidad){
        var raw = ddCantidad.dataset.value || '';
        var m = raw.match(/^(\d+)/);
        if (m) cantidad = parseInt(m[1],10);
      }
      if (!isFinite(cantidad) || cantidad < 1) cantidad = 1;

      var total = precioBase * cantidad;
      if (precioEl){
        var txt = total.toFixed(2).replace('.', ',') + ' $';
        precioEl.textContent = txt;
      }

      var ok = isFilled(ddFecha) && isFilled(ddHora) && isFilled(ddCantidad);
      if (btn){
        btn.disabled = !ok;
        btn.classList.toggle('btn-noir', ok);
        btn.classList.toggle('btn-desactive', !ok);
      }
    }

    var overlayRef, overlayListEl;

    function openOverlayFor(dropdown){
      overlayRef = overlay;
      overlayListEl = overlayList || document.getElementById('ddOverlayList');
      if (!overlayRef || !overlayListEl || !dropdown) return;

      currentDropdown = dropdown;
      overlayListEl.className = 'dd-overlay-list';
      overlayListEl.innerHTML = "";

      var button = dropdown.querySelector('.dd-button');
      var label  = dropdown.querySelector('.dd-label');

      var variant = dropdown.dataset.listVariant || 'fullscreen';

      if (variant === 'grid3'){
        overlayListEl.classList.add('grid3');

        var phText = dropdown.dataset.ph || label.textContent.trim() || 'Heure';
        var ph = document.createElement('li');
        ph.className = 'dd-grid-option placeholder';
        ph.textContent = phText;
        ph.addEventListener('click', function(){
          label.textContent = phText;
          button.setAttribute('data-placeholder','true');
          dropdown.dataset.value = '';
          closeOverlay();
          setTimeout(()=>button.focus({preventScroll:true}),0);
          updatePrecioYBoton();
        });
        overlayListEl.appendChild(ph);

        var times = buildTimes();
        var perRow = 3, groupRows = 4, groupSize = perRow * groupRows;
        var col = 1;
        const ddHora = document.querySelector('.dropdown[data-name="hora"]');
        const rawSelected = ddHora ? (ddHora.dataset.value || '') : '';
        const horaSeleccionada = normalizarHora(rawSelected);

        times.forEach(function(txt, idx){
          var li = document.createElement('li');
          li.className = 'dd-grid-option';
          li.textContent = txt;
          li.setAttribute('role','option');
          li.dataset.col = String(col);

          if (normalizarHora(txt) === horaSeleccionada) {
            li.classList.add('is-selected');
          }

          li.addEventListener('click', function(){
            label.textContent = txt;
            button.removeAttribute('data-placeholder');
            dropdown.dataset.value = txt;
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            updatePrecioYBoton();
          });
          overlayListEl.appendChild(li);

          col = (col % 3) + 1;

          var pos = idx + 1;
          if (pos % groupSize === 0 && pos < times.length){
            var sep = document.createElement('li');
            sep.className = 'dd-grid-sep-black';
            overlayListEl.appendChild(sep);
          }
        });

      } else {
        var dataEl = dropdown.querySelector('.dd-data');
        var items = [];
        if (dataEl) {
          try { items = JSON.parse(dataEl.textContent.trim() || "[]"); } catch(e){ items = []; }
        }

        var placeholderText = dropdown.dataset.ph || label.textContent.trim() || 'Seleccionar';
        var liPh = document.createElement('li');
        liPh.className = 'dd-overlay-option placeholder';
        liPh.setAttribute('role','option');
        liPh.textContent = placeholderText;
        liPh.addEventListener('click', function(){
          label.textContent = placeholderText;
          button.setAttribute('data-placeholder','true');
          dropdown.dataset.value = '';
          closeOverlay();
          setTimeout(()=>button.focus({preventScroll:true}),0);
          updatePrecioYBoton();
        });
        overlayListEl.appendChild(liPh);

        items.forEach(function(txt){
          var li = document.createElement('li');
          li.className = 'dd-overlay-option';
          li.setAttribute('role','option');
          li.textContent = txt;
          li.addEventListener('click', function(){
            label.textContent = txt;
            button.removeAttribute('data-placeholder');
            dropdown.dataset.value = txt;
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            updatePrecioYBoton();
          });
          overlayListEl.appendChild(li);
        });
      }

      document.getElementById('ddOverlay').setAttribute('data-open','true');
      document.body.style.overflow = 'hidden';
    }

    function closeOverlay(){
      document.getElementById('ddOverlay').setAttribute('data-open','false');
      document.body.style.overflow = '';
      currentDropdown = null;
    }

    function setupDropdown(dropdown){
      var button = dropdown.querySelector('.dd-button');
      var label  = dropdown.querySelector('.dd-label');

      var phText = label.textContent.trim() || 'Seleccionar';
      dropdown.dataset.ph = phText;
      if (!dropdown.dataset.value){
        dropdown.dataset.value = '';
      }

      button.addEventListener('click', function(){
        openOverlayFor(dropdown);
      });
      button.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          openOverlayFor(dropdown);
        }
      });
    }

    function initDropdowns(){
      document.querySelectorAll('.dropdown').forEach(setupDropdown);
      overlayListRef = document.getElementById('ddOverlayList');

      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape' && document.getElementById('ddOverlay').getAttribute('data-open') === 'true'){
          closeOverlay();
        }
      });

      document.getElementById('ddOverlay').addEventListener('click', function(e){
        if (e.target === e.currentTarget) closeOverlay();
      });
    }

    function buildDatesAndCantidad(){
      var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
      var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');

      if (ddFecha){
        var dataElF = ddFecha.querySelector('.dd-data');
        if (dataElF){
          const fechas = buildDatesStartingTomorrow(7);
          const fechaPedidoRaw = pedido && (pedido.fechaEntrega || pedido.fecha || pedido.fecha_entrega);
          const fechaPedidoFmt = fechaPedidoRaw ? formatFechaEtiqueta(fechaPedidoRaw) : '';

          if (fechaPedidoFmt && fechas.indexOf(fechaPedidoFmt) === -1){
            fechas.unshift(fechaPedidoFmt);
          }

          dataElF.textContent = JSON.stringify(fechas);

          var btnF = ddFecha.querySelector('.dd-button');
          var labF = ddFecha.querySelector('.dd-label');
          var valorInicial = fechaPedidoFmt || (fechas.length ? fechas[0] : '');

          if (valorInicial){
            if (labF) labF.textContent = valorInicial;
            if (btnF) btnF.removeAttribute('data-placeholder');
            ddFecha.dataset.value = valorInicial;
          }
        }
      }

      if (ddCantidad){
        var dataElC = ddCantidad.querySelector('.dd-data');
        if (dataElC){
          var items = [];
          for (var i = 1; i <= 10; i++){
            items.push(i + (i === 1 ? ' seco' : ' secos'));
          }
          dataElC.textContent = JSON.stringify(items);
          if (items.length){
            var btnC = ddCantidad.querySelector('.dd-button');
            var labC = ddCantidad.querySelector('.dd-label');
            var cantidadPedido = pedido && pedido.cantidad ? Number(pedido.cantidad) : null;
            var cantidadTxt = cantidadPedido && items[cantidadPedido - 1] ? items[cantidadPedido - 1] : items[0];
            if (labC) labC.textContent = cantidadTxt;
            if (btnC) btnC.removeAttribute('data-placeholder');
            ddCantidad.dataset.value = cantidadTxt;
          }
        }
      }

      updatePrecioYBoton();
    }

    function setDefaultHoraOuDesdePedido(){
      const horaRaw = pedido.horaEntrega;
      const horaNorm = normalizarHora(horaRaw);

      const ddHora = document.querySelector('.dropdown[data-name="hora"]');
      if (ddHora) {
        ddHora.dataset.value = horaNorm;
        const lbl = ddHora.querySelector('.dd-label');
        const btn = ddHora.querySelector('.dd-button');
        if (lbl) lbl.textContent = horaNorm;
        if (btn) btn.removeAttribute('data-placeholder');
      }

      updatePrecioYBoton();
    }

    function poblarContacto(){
      var cliente = (pedido && pedido.cliente) || (ctx && ctx.cliente) || {};
      var nombre = cliente.nombre || '';
      var partes = nombre.split(' ');
      var headerLines = document.querySelectorAll('.contact-top .txt-body div');
      if (headerLines.length){
        headerLines[0].textContent = partes.shift() || nombre || 'Contacto';
        if (headerLines[1]){
          headerLines[1].textContent = partes.join(' ');
        }
      }

      var notaRow = document.querySelector('[data-role="nota-row"]');
      var notaSep = document.querySelector('[data-role="nota-sep-below"]');
      var notaBody = notaRow ? notaRow.querySelector('.txt-body') : null;
      var notaValor = (pedido && (pedido.notas || pedido.nota)) || cliente.nota || '';
      var notaTexto = (notaValor || '').trim();
      var mostrarNota = notaTexto !== '';

      document.querySelectorAll('.contact-card .label').forEach(function(lbl){
        var key = lbl.textContent.trim().toLowerCase();
        var target = lbl.nextElementSibling;
        if (!target) return;
        if (key === 'sector') target.textContent = cliente.sector || '—';
        else if (key === 'direccion') target.textContent = (pedido && pedido.direccion) || cliente.direccion || '—';
        else if (key === 'nota') return;
        else if (key === 'whatsapp') target.textContent = (cliente.telefono || cliente.whatsapp || (pedido && pedido.whatsapp)) || '—';
      });

      if (notaBody){
        notaBody.textContent = notaTexto;
      }

      if (notaRow){
        notaRow.style.display = mostrarNota ? '' : 'none';
      }
      if (notaSep){
        notaSep.style.display = mostrarNota ? '' : 'none';
      }

      if (pedidoIdEl){
        var pedidoId = (pedido && (pedido.idPedido || pedido.pedidoId || pedido.id_pedido || pedido.id)) || (ctx && ctx.pedidoId);
        if (pedidoId) pedidoIdEl.textContent = pedidoId;
      }
    }

    function bindActions(){
      if (btnVolver){
        btnVolver.addEventListener('click', function(){
          loadPage('inicio');
        });
      }

      if (contactEditBtn){
        contactEditBtn.addEventListener('click', function(){
          if (contactEditLoading) return;
          contactEditLoading = true;
          contactEditBtn.classList.add('is-loading');
          var cliente = (pedido && pedido.cliente) || (ctx && ctx.cliente) || {};
          window.SECO_CTX = {
            origen: 'editarPedido',
            pedidoId: (pedido && (pedido.idPedido || pedido.pedidoId)) || (ctx && ctx.pedidoId) || '',
            idContacto: cliente.idCliente || (ctx && ctx.idContacto) || '',
            cliente: cliente,
            pedido: pedido || (ctx && ctx.pedido)
          };
          loadPage('editarContacto', function(){
            contactEditLoading = false;
            contactEditBtn.classList.remove('is-loading');
          });
        });
      }
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      poblarContacto();
      initDropdowns();
      buildDatesAndCantidad();
      setDefaultHoraOuDesdePedido();
      bindActions();
    }

    init();

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  registrarPedido: function() {
      var ctx = (typeof window !== 'undefined' && window.SECO_CTX) ? window.SECO_CTX : {};
      var clienteActual = ctx.cliente || null;
      var sectoresCtx = Array.isArray(ctx.sectores) ? ctx.sectores : [];
      var overlay, overlayList, currentDropdown = null;
      var contactEditBtn = document.getElementById('btnEditarContacto');
      var btnRegistrar = document.getElementById('btnRegistrar');
      var btnVolver = document.getElementById('btnVolver');

      function applyScaleFix(){
          var cssW = window.innerWidth || document.documentElement.clientWidth;
          var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
          if (cssW >= 960 && cssW <= 1024) {
            var fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
        }

        function sizeHeaderImage(){
          var img = document.getElementById('headerImg');
          var wrap = document.querySelector('.wrapper');
          if (!img || !wrap) return;
          var w = Math.floor(wrap.clientWidth);
          if (w > 0){
            img.style.width = w + 'px';
            img.style.maxWidth = '100%';
            img.removeAttribute('height');
          }
        }

      function obtenerElementoSector(){
        var labels = document.querySelectorAll('.contact-card .label');
        for (var i = 0; i < labels.length; i++) {
          var lbl = labels[i];
          if ((lbl.textContent || '').toString().trim().toLowerCase() !== 'sector') continue;

          var contenedor = lbl.parentElement;
          if (contenedor) {
            var txtBody = contenedor.querySelector('.txt-body');
            if (txtBody && txtBody.textContent) {
              return txtBody;
            }
          }

          var siguiente = lbl.nextElementSibling;
          if (siguiente && siguiente.classList.contains('txt-body') && siguiente.textContent) {
            return siguiente;
          }
        }
        return null;
      }

      function obtenerSectorDesdePagina(){
        var el = obtenerElementoSector();
        return el && el.textContent ? el.textContent.trim() : '';
      }

      function construirSectorPrices(){
        var sectores = Array.isArray(sectoresCtx) ? sectoresCtx : [];
        var tabla = {};

        sectores.forEach(function(sec){
          var nombre = (sec && sec.nombre) ? sec.nombre.toString().trim() : '';
          var precioValido = (sec && typeof sec.precio === 'number' && !isNaN(sec.precio))
            ? Number(sec.precio)
            : null;

          if (!nombre || precioValido === null) return;
          tabla[nombre.toLowerCase()] = precioValido;
        });

        return tabla;
      }

      function getPrecioBaseDesdeCtx(){
        if (ctx && typeof ctx.precioBase === 'number' && !isNaN(ctx.precioBase)){
          return Number(ctx.precioBase);
        }

        var sectorTexto = (obtenerSectorDesdePagina() || '').toString().trim().toLowerCase();
        var sectorPrices = construirSectorPrices();

        if (sectorTexto && Object.prototype.hasOwnProperty.call(sectorPrices, sectorTexto)) {
          return sectorPrices[sectorTexto];
        }

        return 0;
      }

      function obtenerCantidadSeleccionada(){
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
        if (!ddCantidad) return 0;
        var raw = ddCantidad.dataset.value || '';
        var m = raw.match(/^(\d+)/);
        if (m){
          var n = parseInt(m[1], 10);
          if (!isNaN(n) && n > 0) return n;
        }
        return 0;
      }

      function dropdownTieneValor(dropdown){
        if (!dropdown) return false;
        var button = dropdown.querySelector('.dd-button');
        var isPlaceholder = button && button.getAttribute('data-placeholder') === 'true';
        var val = dropdown.dataset.value || '';
        return !isPlaceholder && val !== '';
      }

      function sincronizarBotonRegistrar(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
        var btn        = document.getElementById('btnRegistrar');

        var ok = dropdownTieneValor(ddFecha) && dropdownTieneValor(ddHora) && dropdownTieneValor(ddCantidad);
        if (btn){
          btn.disabled = !ok;
          btn.classList.toggle('btn-noir', ok);
          btn.classList.toggle('btn-desactive', !ok);
        }
      }

      function actualizarPrecio(){
        var precioBase = getPrecioBaseDesdeCtx();
        var cantidad = dropdownTieneValor(document.querySelector('.dropdown[data-name="cantidad"]'))
          ? obtenerCantidadSeleccionada()
          : 0;
        var total = precioBase * cantidad;

        var precioEl = document.getElementById('precioValor');
        if (precioEl){
          var txt = (cantidad && precioBase ? total : 0).toFixed(2).replace('.', ',') + ' $';
          precioEl.textContent = txt;
          var isPlaceholder = !cantidad || !precioBase;
          precioEl.style.color = isPlaceholder ? 'rgba(0,0,0,0.25)' : '#000';
        }

        sincronizarBotonRegistrar();
      }

      function observarCambiosSector(){
        var sectorEl = obtenerElementoSector();
        if (!sectorEl || typeof MutationObserver !== 'function') return;

        var obs = new MutationObserver(function(){
          actualizarPrecio();
        });

        obs.observe(sectorEl, { childList: true, characterData: true, subtree: true });
      }

      function formatFechaEtiqueta(raw){
        if (!raw) return "";

        var meses = ["Ene.","Feb.","Mar.","Abr.","May.","Jun.","Jul.","Ago.","Sep.","Oct.","Nov.","Dic."];
        var dias  = ["Domingo","Lunes","Martes","Miercoles","Jueves","Viernes","Sabado"];

        var d = null;

        // 1) Si on reçoit déjà un objet Date
        if (raw instanceof Date){
          d = raw;
        } else {
          var s = String(raw).trim();

          // 2) Format dd/mm/yyyy → on le parse en local
          var m1 = s.match(/(\d{2})\/(\d{2})\/(\d{4})/);
          if (m1){
            var dd1  = parseInt(m1[1], 10);
            var mm1  = parseInt(m1[2], 10) - 1;
            var yy1  = parseInt(m1[3], 10);
            d = new Date(yy1, mm1, dd1);
          } else {
            // 3) Format yyyy-mm-dd → on le parse aussi en local (et surtout PAS new Date(s))
            var mIso = s.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (mIso){
              var yy2 = parseInt(mIso[1], 10);
              var mm2 = parseInt(mIso[2], 10) - 1;
              var dd2 = parseInt(mIso[3], 10);
              d = new Date(yy2, mm2, dd2);
            } else {
              // 4) Dernier recours : new Date(s) (pour d’autres formats éventuels)
              var dIso = new Date(s);
              if (!isNaN(dIso.getTime())){
                d = dIso;
              }
            }
          }
        }

        if (!d || isNaN(d.getTime())) return raw;

        var dow = dias[d.getDay()];
        var day = d.getDate();
        var mes = meses[d.getMonth()];

        return dow + ", " + day + " de " + mes;
      }


      function buildTimes(){
        const out=[];
        for(let h=6;h<=18;h++){
          for(let m=0;m<60;m+=5){
            if(h===18 && m>55) break;
            out.push(String(h).padStart(2,"0")+":"+String(m).padStart(2,"0"));
          }
        }
        return out;
      }

      function normalizarHora(h) {
        if (!h) return '';
        const raw = String(h).trim();
        const m = raw.match(/(\d{1,2}):(\d{2})/);
        if (m) {
          const hh = m[1].padStart(2, "0");
          const mm = m[2];
          return hh + ":" + mm;
        }
        return '';
      }

      function buildDatesStartingTomorrow(count){
        const res = [];
        const hoy = new Date();
        for (let i = 1; i <= count; i++){
          const d = new Date(hoy);
          d.setDate(hoy.getDate() + i);
          const dd  = String(d.getDate()).padStart(2,"0");
          const mm  = String(d.getMonth()+1).padStart(2,"0");
          const yyyy = d.getFullYear();
          const etiqueta = formatFechaEtiqueta(yyyy + "-" + mm + "-" + dd);
          res.push(etiqueta);
        }
        return res;
      }

      function setButtonSpinner(btn, isLoading, color){
        if (!btn) return;
        if (btn.classList.contains('btn-noir')){
          if (isLoading){
            window.secoSetBlackButtonLoading(btn, true);
          } else {
            window.secoSetBlackButtonLoading(btn, false);
          }
          return;
        }
        if (isLoading){
          if (!btn.dataset.originalHtml){
            btn.dataset.originalHtml = btn.innerHTML;
          }
          btn.innerHTML = '<span class="btn-spinner' + (color === 'black' ? ' black' : '') + '" aria-hidden="true"></span>';
          btn.disabled = true;
        } else {
          btn.disabled = false;
          if (btn.dataset.originalHtml){
            btn.innerHTML = btn.dataset.originalHtml;
            delete btn.dataset.originalHtml;
          }
        }
      }

      function openOverlayFor(dropdown){
        currentDropdown = dropdown;
        overlayList.className = 'dd-overlay-list';
        overlayList.innerHTML = "";

        var button = dropdown.querySelector('.dd-button');
        var label  = dropdown.querySelector('.dd-label');

        var variant = dropdown.dataset.listVariant || 'fullscreen';

        if (variant === 'grid3'){
          overlayList.classList.add('grid3');

          var phText = dropdown.dataset.ph || label.textContent.trim() || 'Heure';
          var ph = document.createElement('li');
          ph.className = 'dd-grid-option placeholder';
          ph.textContent = phText;
          ph.addEventListener('click', function(){
            label.textContent = phText;
            button.setAttribute('data-placeholder','true');
            dropdown.dataset.value = '';
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            actualizarPrecio();
          });
          overlayList.appendChild(ph);

          var times = buildTimes();
          var selectedHora = normalizarHora(dropdown.dataset.value || label.textContent || '');
          var perRow = 3, groupRows = 4, groupSize = perRow * groupRows;
          var col = 1;

          times.forEach(function(txt, idx){
            var li = document.createElement('li');
            li.className = 'dd-grid-option';
            li.textContent = txt;
            li.setAttribute('role','option');
            if (normalizarHora(txt) === selectedHora) {
              li.classList.add('is-selected');
            }

            li.dataset.col = String(col);

            li.addEventListener('click', function(){

              // --- Flash visuel immédiat sur mobile ---
              li.classList.add('is-tapflash');
              setTimeout(() => li.classList.remove('is-tapflash'), 120);
              // ----------------------------------------
              label.textContent = txt;
              button.removeAttribute('data-placeholder');
              dropdown.dataset.value = txt;
              closeOverlay();
              setTimeout(()=>button.focus({preventScroll:true}),0);
              actualizarPrecio();
            });
            overlayList.appendChild(li);

            col = (col % 3) + 1;

            var pos = idx + 1;
            if (pos % groupSize === 0 && pos < times.length){
              var sep = document.createElement('li');
              sep.className = 'dd-grid-sep-black';
              overlayList.appendChild(sep);
            }
          });

        } else {
          var dataEl = dropdown.querySelector('.dd-data');
          var items = [];
          if (dataEl) {
            try { items = JSON.parse(dataEl.textContent.trim()); } catch(e){ items = []; }
          }

          var placeholderText = dropdown.dataset.ph || label.textContent.trim() || 'Lorem ipsum';
          var liPh = document.createElement('li');
          liPh.className = 'dd-overlay-option placeholder';
          liPh.setAttribute('role','option');
          liPh.textContent = placeholderText;
          liPh.addEventListener('click', function(){
            label.textContent = placeholderText;
            button.setAttribute('data-placeholder','true');
            dropdown.dataset.value = '';
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            actualizarPrecio();
          });
          overlayList.appendChild(liPh);

          items.forEach(function(txt){
            var li = document.createElement('li');
            li.className = 'dd-overlay-option';
            li.setAttribute('role','option');
            li.textContent = txt;
            li.addEventListener('click', function(){
              label.textContent = txt;
              button.removeAttribute('data-placeholder');
              dropdown.dataset.value = txt;
              closeOverlay();
              setTimeout(()=>button.focus({preventScroll:true}),0);
              actualizarPrecio();
            });
            overlayList.appendChild(li);
          });
        }

        document.getElementById('ddOverlay').setAttribute('data-open','true');
        document.body.style.overflow = 'hidden';
      }

      function closeOverlay(){
        document.getElementById('ddOverlay').setAttribute('data-open','false');
        document.body.style.overflow = '';
        currentDropdown = null;
      }

      function setupDropdown(dropdown){
        var button = dropdown.querySelector('.dd-button');
        var label  = dropdown.querySelector('.dd-label');

        var phText = label.textContent.trim() || 'Seleccionar';
        dropdown.dataset.ph = phText;
        if (!dropdown.dataset.value){
          dropdown.dataset.value = '';
        }

        button.addEventListener('click', function(){
          openOverlayFor(dropdown);
        });
        button.addEventListener('keydown', function(e){
          if (e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            openOverlayFor(dropdown);
          }
        });
      }

      function initDropdowns(){
        document.querySelectorAll('.dropdown').forEach(setupDropdown);
        overlayList = document.getElementById('ddOverlayList');

        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && document.getElementById('ddOverlay').getAttribute('data-open') === 'true'){
            closeOverlay();
          }
        });

        document.getElementById('ddOverlay').addEventListener('click', function(e){
          if (e.target === e.currentTarget) closeOverlay();
        });
      }

      function setDropdownValue(dropdown, labelText, valueText, isPlaceholder){
        if (!dropdown) return;
        var btn = dropdown.querySelector('.dd-button');
        var lab = dropdown.querySelector('.dd-label');
        if (lab && labelText !== undefined) lab.textContent = labelText;
        if (btn){
          if (isPlaceholder){
            btn.setAttribute('data-placeholder','true');
          } else {
            btn.removeAttribute('data-placeholder');
          }
        }
        dropdown.dataset.value = valueText || '';
      }

            function inicializarFechaCantidadHora(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');

        // ===== FECHA =====
        if (ddFecha){
          var dataElF = ddFecha.querySelector('.dd-data');
          var fechas = [];

          // Construire la liste à partir d'AUJOURD'HUI (7 jours)
          var hoy = new Date();
          for (var i = 0; i < 7; i++){
            var d = new Date(hoy);
            d.setDate(hoy.getDate() + i);

            var yyyy = String(d.getFullYear());
            var mm   = String(d.getMonth() + 1).padStart(2, "0");
            var dd   = String(d.getDate()).padStart(2, "0");
            var iso  = yyyy + "-" + mm + "-" + dd;

            fechas.push(formatFechaEtiqueta(iso));
          }

          if (dataElF){
            dataElF.textContent = JSON.stringify(fechas);
          }

          var preferida = null;

          if (ctx && ctx.origen === 'registrarPedido' && ctx.fechaSeleccionada){
            // Retour après editarContacto → on respecte la date déjà choisie
            preferida = ctx.fechaSeleccionada;
          } else if (fechas.length){
            // Arrivée "normale" → on force DEMAIN = 2e élément si disponible
            if (fechas.length > 1){
              preferida = fechas[1]; // demain
            } else {
              preferida = fechas[0]; // fallback: aujourd'hui si un seul élément
            }
            ctx.fechaSeleccionada = preferida;
            window.SECO_CTX = ctx;
          }

          if (preferida){
            setDropdownValue(ddFecha, preferida, preferida, false);
          }
        }

        // ===== CANTIDAD =====
        if (ddCantidad){
          var dataElC = ddCantidad.querySelector('.dd-data');
          if (dataElC){
            var items = [];
            for (var i = 1; i <= 10; i++){
              items.push(i + (i === 1 ? ' seco' : ' secos'));
            }
            dataElC.textContent = JSON.stringify(items);

            var seleccion = ctx.cantidadSeleccionada || items[0] || '';
            if (seleccion){
              setDropdownValue(ddCantidad, seleccion, seleccion, false);
            }
          }
        }

        // ===== HORA =====
        if (ddHora){
          var seleccionHora = normalizarHora(ctx.horaSeleccionada);
          var phHora = ddHora.dataset.ph || 'Hora de entrega';
          setDropdownValue(ddHora, seleccionHora || phHora, seleccionHora, !seleccionHora);
          if (!seleccionHora && ddHora.querySelector('.dd-button')){
            ddHora.querySelector('.dd-button').setAttribute('data-placeholder','true');
          }
        }

        actualizarPrecio();
      }

      function poblarContacto(){
        var nombreEl = document.getElementById('contactoNombre');
        var sublineEl = document.getElementById('contactoSubline');
        var sectorEl = document.getElementById('contactoSector');
        var dirEl = document.getElementById('contactoDireccion');
        var dirExtraEl = document.getElementById('contactoDireccionExtra');
        var notaEl = document.getElementById('contactoNota');
        var waEl = document.getElementById('contactoWhatsapp');

        var cliente = clienteActual || {};
        var nombre = cliente.nombre || ctx.clienteNombre || '';
        var partes = nombre.split(' ');
        var nombrePrincipal = partes.shift() || nombre || 'Contacto';
        var subline = partes.join(' ');
        var whatsappTexto = (cliente.telefono || cliente.whatsapp || '').toString().trim();

        if (nombreEl) nombreEl.textContent = nombrePrincipal;
        if (sublineEl) sublineEl.textContent = subline;
        if (sectorEl) sectorEl.textContent = cliente.sector || '—';

        if (dirEl) dirEl.textContent = cliente.direccion || '—';
        if (dirExtraEl){
          var extra = cliente.direccionExtra || '';
          dirExtraEl.textContent = extra;
          dirExtraEl.style.display = extra ? '' : 'none';
        }

        if (notaEl){
          var nota = cliente.nota || '';
          notaEl.textContent = nota;
          var notaRow = notaEl.parentElement;
          if (notaRow) notaRow.style.display = nota ? '' : 'none';
          var sepBelow = notaRow ? notaRow.parentElement.querySelector('[data-role="nota-sep-below"]') : null;
          if (sepBelow) sepBelow.style.display = nota ? '' : 'none';
        }

        if (waEl) waEl.textContent = whatsappTexto || '—';

        var idEl = document.getElementById('pedidoId');
        if (idEl && ctx && ctx.pedidoId){
          idEl.textContent = ctx.pedidoId;
        }

        var contactCard = document.getElementById('contactoCard');
        if (contactCard){
          contactCard.removeAttribute('data-loading');
          contactCard.classList.remove('is-loading');
          contactCard.classList.remove('loading');

          var loader = contactCard.querySelector('.contact-card-loader');
          if (loader) loader.style.display = 'none';

          var contenido = contactCard.querySelectorAll(':scope > *:not(.contact-card-loader)');
          contenido.forEach(function(el){
            el.style.removeProperty('visibility');
            el.style.removeProperty('opacity');
          });
        }
      }

      function cargarClienteDesdeServidor(){
        var idContacto = (ctx && (ctx.idContacto || (ctx.cliente && ctx.cliente.idCliente))) || '';
        if (!idContacto){
          poblarContacto();
          actualizarPrecio();
          return;
        }

        google.script.run
          .withSuccessHandler(function(resp){
            if (resp && resp.ok && resp.data && resp.data.cliente){
              clienteActual = resp.data.cliente;
              sectoresCtx = Array.isArray(resp.data.sectores) ? resp.data.sectores : sectoresCtx;
              ctx.cliente = clienteActual;
              ctx.sectores = sectoresCtx;
              window.SECO_CTX = ctx;
            }
            poblarContacto();
            actualizarPrecio();
          })
          .withFailureHandler(function(){
            poblarContacto();
            actualizarPrecio();
          })
          .obtenerClientePorId({ idContacto: idContacto });
      }

      function guardarCtxSeleccion(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');

        ctx.fechaSeleccionada = ddFecha ? (ddFecha.dataset.value || '') : '';
        ctx.horaSeleccionada = ddHora ? (ddHora.dataset.value || '') : '';
        ctx.cantidadSeleccionada = ddCantidad ? (ddCantidad.dataset.value || '') : '';
        window.SECO_CTX = ctx;
      }

      function construirPayloadRegistro(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
        var fechaTexto = '';
        var horaTexto  = '';

        if (ddFecha){
          fechaTexto = ddFecha.dataset.value || '';
          if (!fechaTexto){
            var lf = ddFecha.querySelector('.dd-label');
            if (lf && lf.textContent) fechaTexto = lf.textContent.trim();
          }
        }

        if (ddHora){
          horaTexto = ddHora.dataset.value || '';
          if (!horaTexto){
            var lh = ddHora.querySelector('.dd-label');
            if (lh && lh.textContent) horaTexto = lh.textContent.trim();
          }
        }

        var cantidad = obtenerCantidadSeleccionada();
        var unitPrice = getPrecioBaseDesdeCtx();
        var totalCalc = unitPrice * cantidad;

        var cliente = clienteActual || ctx.cliente || {};

        var payload = {
          origen: 'registrarPedido',
          cliente: cliente,
          clienteNombre: (cliente && cliente.nombre) || ctx.clienteNombre || '',
          whatsapp: (cliente.telefono || cliente.whatsapp || ctx.whatsapp || '').toString().trim(),
          direccion: (cliente.direccion || ctx.direccion || '').toString().trim(),
          sector: (cliente.sector || ctx.sector || obtenerSectorDesdePagina() || '').toString().trim(),
          nota: (cliente.nota || ctx.nota || '').toString().trim(),
          fechaTexto: fechaTexto,
          hora: horaTexto,
          cantidad: cantidad,
          precioUnitario: unitPrice,
          totalCalculado: totalCalc,
          pedidoId: (ctx.pedidoId || '').toString().trim(),
          idContacto: (ctx.idContacto || cliente.idCliente || '').toString().trim()
        };

        return payload;
      }

      function bindEditarContacto(){
        if (!contactEditBtn) return;
        contactEditBtn.addEventListener('click', function(){
          if (contactEditBtn.disabled) return;
          contactEditBtn.disabled = true;
          contactEditBtn.classList.add('is-loading');
          guardarCtxSeleccion();
          window.SECO_CTX = Object.assign({}, ctx, {
            origen: 'registrarPedido',
            pedidoId: ctx.pedidoId || '',
            idContacto: (ctx && ctx.idContacto) || (clienteActual && clienteActual.idCliente) || '',
            cliente: clienteActual,
            fechaSeleccionada: ctx.fechaSeleccionada,
            horaSeleccionada: ctx.horaSeleccionada,
            cantidadSeleccionada: ctx.cantidadSeleccionada
          });
          loadPage('editarContacto', function(){
            contactEditBtn.disabled = false;
            contactEditBtn.classList.remove('is-loading');
          });
        });
      }

      function init(){
        applyScaleFix();
        sizeHeaderImage();
        initDropdowns();
        inicializarFechaCantidadHora();
        observarCambiosSector();
        bindEditarContacto();
        cargarClienteDesdeServidor();

        if (btnVolver){
          btnVolver.addEventListener('click', function(){
            if (btnVolver.disabled) return;
            setButtonSpinner(btnVolver, true, 'black');
            guardarCtxSeleccion();
            loadPage('inicio', function(){
              setButtonSpinner(btnVolver, false, 'black');
            });
          });
        }

        if (btnRegistrar){
          btnRegistrar.addEventListener('click', function(){
            if (btnRegistrar.disabled) return;
            setButtonSpinner(btnRegistrar, true);
            guardarCtxSeleccion();
            var payload = construirPayloadRegistro();

            google.script.run
              .withSuccessHandler(function(resp){
                setButtonSpinner(btnRegistrar, false);
                if (resp && resp.ok){
                  loadPage('pedidoRegistrado');
                } else if (window.alert){
                  var msg = (resp && resp.error) ? resp.error : 'Error al registrar el pedido.';
                  alert(msg);
                }
              })
              .withFailureHandler(function(){
                setButtonSpinner(btnRegistrar, false);
                if (window.alert){
                  alert('Error al registrar el pedido.');
                }
              })
              .registrarPedidoDesdeRegistrar(payload);
          });
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else { init(); }

      window.addEventListener('resize', function(){
        applyScaleFix();
        sizeHeaderImage();
      });
  },
  
  pedidoRegistrado: function() {
    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrap = document.querySelector('.wrapper');
      if (!img || !wrap) return;
      var w = Math.floor(wrap.clientWidth);
      if (w > 0){
        img.style.width = w + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    // Normalisation des nombres à partir de SECO_CTX
    function getPedidoNormalizado(){
      var ctx = window.SECO_CTX || {};
      var p = ctx.pedido || ctx || {};

      var rawCantidad = p.cantidad;
      if (!(typeof rawCantidad === 'number' && isFinite(rawCantidad))) {
        // fallback si on a un texte du style "2 secos"
        if (p.cantidadSeleccionada){
          var m = String(p.cantidadSeleccionada).match(/^(\d+)/);
          if (m) rawCantidad = parseInt(m[1], 10);
        }
      }
      var cantidad = (typeof rawCantidad === 'number' && isFinite(rawCantidad) && rawCantidad > 0)
        ? rawCantidad
        : 1;

      var rawUnit = p.precioUnitario;
      if (!(typeof rawUnit === 'number' && isFinite(rawUnit) && rawUnit >= 0)) {
        if (typeof p.precioBase === 'number' && isFinite(p.precioBase)) {
          rawUnit = p.precioBase;
        }
      }
      var unitPrice = (typeof rawUnit === 'number' && isFinite(rawUnit) && rawUnit >= 0)
        ? rawUnit
        : 0;

      var rawTotal = p.total;
      if (!(typeof rawTotal === 'number' && isFinite(rawTotal) && rawTotal >= 0)) {
        rawTotal = unitPrice * cantidad;
      }
      var total = (typeof rawTotal === 'number' && isFinite(rawTotal) && rawTotal >= 0)
        ? rawTotal
        : 0;

      return {
        pedidoId:      p.pedidoId || '',
        nombre:        p.clienteNombre || (p.cliente && p.cliente.nombre) || '',
        sector:        p.sector || '',
        direccion:     p.direccion || '',
        nota:          p.nota || '',
        whatsapp:      p.whatsapp || (p.cliente && (p.cliente.whatsapp || p.cliente.telefono)) || '',
        fechaEntrega:  p.fechaEntrega || '',
        horaEntrega:   p.horaEntrega || '',
        cantidad:      cantidad,
        unitPrice:     unitPrice,
        total:         total
      };
    }

    function formatMoney(value){
      var n = Number(value);
      if (!isFinite(n)) n = 0;
      return n.toFixed(2).replace('.', ',') + ' $';
    }

    // Remplir la carte avec les données normalisées
    (function rellenarTarjeta(){
      var p = getPedidoNormalizado();

      var elHora     = document.getElementById('confirmHora');
      var elSector   = document.getElementById('confirmSector');
      var elNombre   = document.getElementById('confirmNombre');
      var elDir      = document.getElementById('confirmDireccion');
      var elNota     = document.getElementById('confirmNota');
      var elWhatsapp = document.getElementById('confirmWhatsapp');
      var elPrecio   = document.getElementById('confirmPrecio');
      var elId       = document.getElementById('pedidoId');

      if (elId)       elId.textContent       = p.pedidoId || '';
      if (elHora)     elHora.textContent     = p.horaEntrega || '—';
      if (elSector)   elSector.textContent   = p.sector || '—';
      if (elNombre)   elNombre.textContent   = p.nombre || '—';
      if (elDir)      elDir.textContent      = p.direccion || '—';

      if (elNota){
        if (p.nota){
          elNota.textContent = 'Nota: ' + p.nota;
          elNota.style.display = '';
        } else {
          elNota.textContent = '';
          elNota.style.display = 'none';
        }
      }

      if (elWhatsapp){
        elWhatsapp.textContent = p.whatsapp ? p.whatsapp : '—';
      }

      if (elPrecio){
        var q = p.cantidad;
        var qtyTxt = q + ' seco' + (q === 1 ? '' : 's');
        var unitTxt = formatMoney(p.unitPrice);
        var totalTxt = formatMoney(p.total);

        elPrecio.innerHTML = qtyTxt + ' x ' + unitTxt + ' = <strong>' + totalTxt + '</strong>';
      }

      // On garde aussi une version propre dans SECO_CTX pour WhatsApp
      var ctx = window.SECO_CTX || {};
      ctx.pedido = ctx.pedido || {};
      ctx.pedido._normalizado = p;
      window.SECO_CTX = ctx;
    })();

    // Bouton OK + envoi WhatsApp si coché
    function bindBotonOk(){
      var btnOk = document.getElementById('btnOk') || document.querySelector('.btn-noir');
      var chk   = document.getElementById('chkEnviarWhatsapp');

      if (!btnOk) return;

      btnOk.addEventListener('click', function(){
        if (window.secoSetBlackButtonLoading){
          window.secoSetBlackButtonLoading(btnOk, true);
        }

        var ctx = window.SECO_CTX || {};
        var pedido = (ctx.pedido && ctx.pedido._normalizado) || getPedidoNormalizado();

        // Si pas de WhatsApp ou checkbox décoché → pas d’envoi, on retourne juste à inicio
        var doitEnvoyer = chk && chk.checked && pedido.whatsapp;

        if (!doitEnvoyer){
          loadPage('inicio', function(){
            if (window.secoSetBlackButtonLoading){
              window.secoSetBlackButtonLoading(btnOk, false);
            }
          });
          return;
        }

        google.script.run
          .withSuccessHandler(function(){
            loadPage('inicio', function(){
              if (window.secoSetBlackButtonLoading){
                window.secoSetBlackButtonLoading(btnOk, false);
              }
            });
          })
          .withFailureHandler(function(){
            if (window.secoSetBlackButtonLoading){
              window.secoSetBlackButtonLoading(btnOk, false);
            }
            loadPage('inicio');
          })
          .enviarWhatsappPedidoRegistrado(pedido);
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      bindBotonOk();
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },








  cerrarElDia: function(){
    function applyScaleFix(){
      var cssW = window.innerWidth;
      var screenW = Math.min(window.screen.width, window.screen.height);
      if (cssW >= 960 && cssW <= 1024){
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix','1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (img && wrapper){
        var avail = Math.floor(wrapper.clientWidth);
        img.style.width = avail + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    function setupConfirm(){
      var chk = document.getElementById('chkConfirm');
      var btn = document.getElementById('btnCerrar');

      function sync(){
        if (chk && chk.checked){
          btn.disabled = false;
          btn.classList.remove('btn-desactive');
          btn.classList.add('btn-noir');
        } else if (btn){
          btn.disabled = true;
          btn.classList.remove('btn-noir');
          btn.classList.add('btn-desactive');
        }
      }

      if (chk){
        chk.addEventListener('change', sync);
      }
      if (btn){
        sync();
      }
    }

    var btnCerrar = document.getElementById('btnCerrar');
    var btnVolver = document.querySelector('.btn.btn-blanc');

    if (btnCerrar){
      btnCerrar.addEventListener('click', function(){
        if (btnCerrar.disabled) return;
        window.secoSetBlackButtonLoading(btnCerrar, true);
        loadPage('diaCerrado');
      });
    }

    if (btnVolver){
      btnVolver.addEventListener('click', function(){
        loadPage('inicio');
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      setupConfirm();
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  diaCerrado: function(){
    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var avail = Math.floor(wrapper.clientWidth);
      img.style.width = avail + 'px';
      img.style.maxWidth = '100%';
      img.removeAttribute('height');
    }

    var btnOk = document.querySelector('.btn-noir');
    if (btnOk){
      btnOk.addEventListener('click', function(){
        window.secoSetBlackButtonLoading(btnOk, true);
        loadPage('inicio');
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  configuracionDelSistema: function(){
    function applyScaleFix(){
      var cssW = window.innerWidth;
      var screenW = Math.min(window.screen.width, window.screen.height);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.5;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix','1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var w = Math.floor(wrapper.clientWidth);
      img.style.width = w + 'px';
      img.style.maxWidth = '100%';
    }

    var overlay = document.getElementById('ddOverlay');
    var overlayList = document.getElementById('ddOverlayList');
    var chk = document.getElementById('chkConfirm');
    var btnConfigurar = document.getElementById('btnConfigurar');
    var btnVolver = document.querySelector('.btn.btn-blanc');
    var currentDropdown = null;

    function getOptionsFromDropdown(drop){
      var dataEl = drop ? drop.querySelector('.dd-data') : null;
      if (!dataEl) return [];
      var raw = dataEl.getAttribute('data-options') || '[]';
      try {
        return JSON.parse(raw);
      } catch (err) {
        return [];
      }
    }

    function closeOverlay(){
      if (!overlay) return;
      overlay.setAttribute('data-open','false');
      document.body.style.overflow='';
      currentDropdown=null;
    }

    function openOverlay(drop){
      if (!overlay || !overlayList || !drop) return;
      currentDropdown = drop;
      overlayList.innerHTML = "";

      var label = drop.querySelector('.dd-label');
      var data = getOptionsFromDropdown(drop);

      if (label){
        var ph = label.textContent.trim();
        var liPh = document.createElement('li');
        liPh.className = 'dd-overlay-option placeholder';
        liPh.textContent = ph;
        liPh.onclick = function(){ closeOverlay(); };
        overlayList.appendChild(liPh);
      }

      data.forEach(function(t){
        var li = document.createElement('li');
        li.className = 'dd-overlay-option';
        li.textContent = t;
        li.onclick = function(){
          if (label){
            label.textContent = t;
          }
          closeOverlay();
        };
        overlayList.appendChild(li);
      });

      overlay.setAttribute('data-open','true');
      document.body.style.overflow='hidden';
    }

    function initDropdowns(){
      document.querySelectorAll('.dropdown').forEach(function(dd){
        var btn = dd.querySelector('.dd-button');
        if (btn){
          btn.onclick = function(){ openOverlay(dd); };
        }
      });
      if (overlay){
        overlay.onclick = function(e){
          if(e.target===overlay) closeOverlay();
        };
      }
    }

    function setupConfirmToggle(){
      if (!chk || !btnConfigurar) return;
      function sync(){
        if(chk.checked){
          btnConfigurar.disabled=false;
          btnConfigurar.classList.remove('btn-desactive');
          btnConfigurar.classList.add('btn-noir');
        } else{
          btnConfigurar.disabled=true;
          btnConfigurar.classList.remove('btn-noir');
          btnConfigurar.classList.add('btn-desactive');
        }
      }
      chk.onchange=sync;
      sync();
    }

    if (btnConfigurar){
      btnConfigurar.addEventListener('click', function(){
        if (btnConfigurar.disabled) return;
        window.secoSetBlackButtonLoading(btnConfigurar, true);
        loadPage('sistemaConfigurado');
      });
    }

    if (btnVolver){
      btnVolver.addEventListener('click', function(){
        loadPage('inicio');
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      initDropdowns();
      setupConfirmToggle();
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded',init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  sistemaConfigurado: function(){
    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var avail = Math.floor(wrapper.clientWidth);
      img.style.width = avail + 'px';
      img.style.maxWidth = '100%';
      img.removeAttribute('height');
    }

    var btnOk = document.querySelector('.btn-noir');
    if (btnOk){
      btnOk.addEventListener('click', function(){
        window.secoSetBlackButtonLoading(btnOk, true);
        loadPage('inicio');
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  }
    };

    function loadPage(pageName, onLoaded){
      google.script.run
        .withSuccessHandler(function(html){
          const app = document.getElementById('app');
          if (app) {
            app.innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'instant' });
            if (pageInit[pageName]) {
              pageInit[pageName]();
            }
          }
          if (typeof onLoaded === 'function') onLoaded();
        })
        .withFailureHandler(function(){
          if (typeof onLoaded === 'function') onLoaded();
        })
        .getPage(pageName);
    }

    document.addEventListener('DOMContentLoaded', function(){
      loadPage('inicio');
    });
  </script>
</body>
</html>
