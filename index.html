<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, shrink-to-fit=no">
  <title>SecoMovil</title>
  <script>
    window.gastoState = {
      fecha: null,
      categoria: null,
      producto: null,
      idProducto: null,
      proveedor: null,
      unidad: null,
      precioUnitario: null,
      cantidad: null,
      gasto: null,
      observaciones: '',
      origen: null,
      costoDebug: null
    };

    function resetGastoState() {
      window.gastoState = {
        fecha: null,
        categoria: null,
        producto: null,
        idProducto: null,
        proveedor: null,
        unidad: null,
        precioUnitario: null,
        cantidad: null,
        gasto: null,
        observaciones: '',
        origen: null,
        costoDebug: null
      };
    }

    function updateGastoState(key, value) {
      window.gastoState[key] = value;
    }

    function normalizeNumericInput(inputEl){
      if (!inputEl) return '';
      var val = (inputEl.value || '').toString();
      var normalized = val.replace(/\./g, ',').replace(/[^0-9,]/g, '');
      var commaIndex = normalized.indexOf(',');
      if (commaIndex !== -1){
        normalized = normalized.slice(0, commaIndex + 1) + normalized.slice(commaIndex + 1).replace(/,/g, '');
      }
      if (normalized !== val){
        inputEl.value = normalized;
      }
      return normalized;
    }

    function parseInputCantidad(inputEl){
      var sanitized = normalizeNumericInput(inputEl);
      var numberVal = parseFloat(sanitized.replace(',', '.'));
      return {
        sanitized: sanitized,
        number: isFinite(numberVal) ? numberVal : null
      };
    }

    function parseInputPrecio(inputEl){
      var sanitized = normalizeNumericInput(inputEl);
      var numberVal = parseFloat(sanitized.replace(',', '.'));
      return {
        sanitized: sanitized,
        number: isFinite(numberVal) ? numberVal : null
      };
    }

    const DEBUG_COSTO = true;
  </script>
  <style>
    .btn-noir[data-spinner="1"]{
      position:relative;
      color:transparent !important;
      text-shadow:none !important;
    }
    .btn-noir[data-spinner="1"] > *{ visibility:hidden; }
    .btn-noir[data-spinner="1"]::before{
      content:"";
      position:absolute;
      inset:0;
      margin:auto;
      width:calc(28px * var(--fix));
      height:calc(28px * var(--fix));
      border-radius:50%;
      border:calc(12px * var(--fix)) solid rgba(255,255,255,0.35);
      border-top-color:#fff;
      animation: btnNoirSpin 0.9s linear infinite;
      pointer-events:none;
    }
    /* Spinner uniforme pour les boutons VOLVER AL INICIO (fond blanc) */
    button[data-role="volver-inicio"]{ position:relative; }
    button[data-role="volver-inicio"][data-spinner="1"]{
      color:transparent !important;
      text-shadow:none !important;
    }
    button[data-role="volver-inicio"][data-spinner="1"] > *{ visibility:hidden; }
    button[data-role="volver-inicio"][data-spinner="1"]::before{
      content:"";
      position:absolute;
      inset:0;
      margin:auto;
      width:calc(28px * var(--fix));
      height:calc(28px * var(--fix));
      border-radius:50%;
      border:calc(12px * var(--fix)) solid rgba(0,0,0,0.35);
      border-top-color:#000;
      animation: btnNoirSpin 0.9s linear infinite;
      pointer-events:none;
    }

    /* Spinner pour les boutons de navigation (fond blanc) */
    #btnPedidosDelDia[data-spinner="1"],
    #btnRegistrarGasto[data-spinner="1"],
    #btnCerrarElDia[data-spinner="1"],
    #btnConfiguracion[data-spinner="1"]{
      position:relative;
      color:transparent !important;
      text-shadow:none !important;
    }
    #btnPedidosDelDia[data-spinner="1"] > *,
    #btnRegistrarGasto[data-spinner="1"] > *,
    #btnCerrarElDia[data-spinner="1"] > *,
    #btnConfiguracion[data-spinner="1"] > *{ visibility:hidden; }
    #btnPedidosDelDia[data-spinner="1"]::before,
    #btnRegistrarGasto[data-spinner="1"]::before,
    #btnCerrarElDia[data-spinner="1"]::before,
    #btnConfiguracion[data-spinner="1"]::before{
      content:"";
      position:absolute;
      inset:0;
      margin:auto;
      width:calc(28px * var(--fix));
      height:calc(28px * var(--fix));
      border-radius:50%;
      border:calc(12px * var(--fix)) solid rgba(0,0,0,0.35);
      border-top-color:#000;
      animation: btnNoirSpin 0.9s linear infinite;
      pointer-events:none;
    }



    @keyframes btnNoirSpin{
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }



    
  </style>
</head>
<body>
  <div id="app"></div>
  <script>
    window.secoSetBlackButtonLoading = function(btn, isLoading){
      if (!btn) return;
      if (isLoading){
        if (btn.dataset.spinner === '1') return;
        btn.disabled = true;
        btn.dataset.spinner = '1';
      } else {
        btn.disabled = false;
        btn.removeAttribute('data-spinner');
      }
    };

    let currentPageName = null;
    let volverInicioHooks = new Map();

    function resetVolverInicioHooks(pageName){
      currentPageName = pageName || null;
      volverInicioHooks.clear();
    }

    function getVolverInicioHook(btn){
      if (!currentPageName || !btn) return null;
      const hooksForPage = volverInicioHooks.get(currentPageName);
      if (!hooksForPage) return null;
      return hooksForPage.get(btn) || (btn.id ? hooksForPage.get(btn.id) : null) || null;
    }

    function setVolverInicioLoading(btn, isLoading){
      if (!btn) return;
      if (isLoading){
        if (btn.dataset.spinner === '1') return;
        btn.disabled = true;
        btn.dataset.spinner = '1';
      } else {
        btn.disabled = false;
        btn.removeAttribute('data-spinner');
      }
    }

    function handleVolverInicioClick(btn){
      if (!btn || btn.disabled) return;

      setVolverInicioLoading(btn, true);

      var hook = getVolverInicioHook(btn);
      if (typeof hook === 'function'){
        hook(btn);
      }

      loadPage('inicio');
    }

    function registerVolverInicioHook(btn, beforeNavigate){
      if (!btn || typeof beforeNavigate !== 'function' || !currentPageName) return;
      const hooksForPage = volverInicioHooks.get(currentPageName) || new Map();
      hooksForPage.set(btn, beforeNavigate);
      if (btn.id) hooksForPage.set(btn.id, beforeNavigate);
      volverInicioHooks.set(currentPageName, hooksForPage);
    }

    function bindVolverInicioButtons(){
      var buttons = document.querySelectorAll('button[data-role="volver-inicio"]');
      if (!buttons || !buttons.length) return;

      buttons.forEach(function(btn){
        if (btn.dataset.volverBound === '1') return;
        btn.dataset.volverBound = '1';

        btn.addEventListener('click', function(){
          handleVolverInicioClick(btn);
        });
      });
    }

    const pageInit = {
  inicio: function(){
    (function(){
        const card = document.getElementById('card1');
        const btnDel = document.getElementById('btnDel');
        const btnConfirm = document.getElementById('btnConfirm');
        const btnDelay = document.getElementById('btnDelay');
        const heureText = document.getElementById('heureText');
        const sectorText = document.getElementById('sectorText');
        const clienteText = document.getElementById('clienteText');
        const direccionText = document.getElementById('direccionText');
        const notaText = document.getElementById('notaText');
        const extraText = document.getElementById('extraText');
        const timeConfirmTitle = document.getElementById('timeConfirmTitle');
        const btnNuevoPedido = document.getElementById('btnNuevoPedido');
        const btnVentaDirecta = document.getElementById('btnVentaDirecta');
        const btnPedidosDelDia = document.getElementById('btnPedidosDelDia');
        const btnRegistrarGasto = document.getElementById('btnRegistrarGasto');
        const btnCerrarElDia = document.getElementById('btnCerrarElDia');
        const btnConfiguracion = document.getElementById('btnConfiguracion');
        const cardLoading = document.getElementById('cardLoading');
        const editCell = card ? card.querySelector('.edit-cell') : null;
        const cardEmptyText = document.getElementById('cardEmptyText');
    
        const overlay = document.getElementById('ddOverlay');
        const overlayList = document.getElementById('ddOverlayList');
    
        const ICONS = {
          trash:   "https://lh3.googleusercontent.com/d/1NEwXtWZqpIJlto9dPs49xKhq3oOqwpXH",
          xgray:   "https://lh3.googleusercontent.com/d/15wgAEpPLmV12eD0dFTr4dD9yZugrNiCs",
          checkBlk:"https://lh3.googleusercontent.com/d/1CiREwW0rHzmdha8SqKtDEqr9iPNW21eG",
          checkW:  "https://lh3.googleusercontent.com/d/1kIWQWxgpGWgRbdiBcm_X1BpwFZkUwX5l"
        };
    
        let normalHeight = null;
        let currentHour = null;
        let pendingHour = null;
        let pedidoActual = null;
        let actionOrigin = null;
        let processingActionBtn = null;
        let topActionEnCours = false;
    
        function captureNormalHeight(){
          const wasConfirm       = card.classList.contains('is-confirm');
          const wasDeleted       = card.classList.contains('is-deleted');
          const wasTimeConfirm   = card.classList.contains('is-timeconfirm');
          const wasDeliveryConf  = card.classList.contains('is-deliveryconfirm');
          const wasDelivered     = card.classList.contains('is-delivered');
    
          card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-deliveryconfirm','is-delivered');
          card.style.height = '';
          normalHeight = card.offsetHeight;
          card.style.height = normalHeight + 'px';
    
          if (wasDeleted) card.classList.add('is-deleted');
          else if (wasDelivered) card.classList.add('is-delivered');
          else if (wasDeliveryConf) card.classList.add('is-deliveryconfirm');
          else if (wasTimeConfirm) card.classList.add('is-timeconfirm');
          else if (wasConfirm) card.classList.add('is-confirm');
        }
    
        function lockToNormalHeight(){
          if (!normalHeight) captureNormalHeight();
          card.style.height = normalHeight + 'px';
        }
    
        function setNormal(){
          card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-deliveryconfirm','is-delivered','is-empty');
          btnDel.querySelector('img').src = ICONS.trash;
          btnConfirm.querySelector('img').src = ICONS.checkW;
          card.style.height = '';
          captureNormalHeight();
          actionOrigin = null;
          clearActionProcessing();
        }
    
        function setConfirm(){
          clearActionProcessing();
          lockToNormalHeight();
          card.classList.add('is-confirm');
          card.classList.remove('is-deleted','is-timeconfirm','is-deliveryconfirm','is-delivered');
          btnDel.querySelector('img').src = ICONS.xgray;
          btnConfirm.querySelector('img').src = ICONS.checkBlk;
          actionOrigin = btnDel;
          setActionProcessing(btnDel, true, false);
        }
    
        function setDeleted(){
          lockToNormalHeight();
          card.classList.add('is-deleted');
          card.classList.remove('is-confirm','is-timeconfirm','is-deliveryconfirm','is-delivered');
        }
    
        function setTimeConfirm(){
          if (!pendingHour) return;
          clearActionProcessing();
          lockToNormalHeight();
          timeConfirmTitle.textContent = pendingHour;
          card.classList.add('is-timeconfirm');
          card.classList.remove('is-confirm','is-deleted','is-deliveryconfirm','is-delivered');
          btnDel.querySelector('img').src = ICONS.xgray;
          btnConfirm.querySelector('img').src = ICONS.checkBlk;
          actionOrigin = btnDelay;
          setActionProcessing(btnDelay, true, false);
        }
    
        function setDeliveryConfirm(){
          clearActionProcessing();
          lockToNormalHeight();
          card.classList.add('is-deliveryconfirm');
          card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-delivered');
          btnDel.querySelector('img').src = ICONS.xgray;
          btnConfirm.querySelector('img').src = ICONS.checkBlk;
          actionOrigin = btnConfirm;
          setActionProcessing(btnConfirm, true, false);
        }
    
        function setDelivered(){
          lockToNormalHeight();
          card.classList.add('is-delivered');
          card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-deliveryconfirm');
        }
    
        function setButtonLoading(btn, isLoading){
          if (!btn) return;
          var loadingColor = 'rgba(255,255,255,0.5)';
          if (isLoading){
            if (!btn.dataset.originalColor){
              var computed = window.getComputedStyle ? getComputedStyle(btn).color : btn.style.color;
              btn.dataset.originalColor = computed || '';
            }
            btn.disabled = true;
            btn.style.color = loadingColor;
          } else {
            btn.disabled = false;
            btn.style.color = btn.dataset.originalColor || '';
          }
        }
    
        function setHalfLoading(el, isLoading){
          if (!el) return;
          if (isLoading){
            el.dataset.loading = '1';
            el.classList.add('is-loading');
            el.style.pointerEvents = 'none';
          } else {
            el.dataset.loading = '0';
            el.classList.remove('is-loading');
            el.style.pointerEvents = '';
          }
        }

        function setEditLoading(isLoading){
          if (!editCell) return;
          editCell.classList.toggle('is-editloading', !!isLoading);
        }
    
        function setCardLoading(isLoading){
          if (!card || !cardLoading) return;
          if (isLoading){
            card.classList.add('is-loading');
          } else {
            card.classList.remove('is-loading');
          }
        }

        function setConfirmButtonLoading(isLoading){
          // Gestion du spinner local sur le bouton de confirmation en bas de la carte
          if (!btnConfirm) return;
          if (isLoading){
            btnConfirm.classList.add('is-loading-confirm');
            btnConfirm.disabled = true;
          } else {
            btnConfirm.classList.remove('is-loading-confirm');
            btnConfirm.disabled = false;
          }
        }

        function setPedidosDelDiaLoading(btn, isLoading){
          if (!btn) return;
          if (isLoading){
            if (btn.dataset.spinner === '1') return;
            btn.disabled = true;
            btn.dataset.spinner = '1';
          } else {
            btn.disabled = false;
            btn.removeAttribute('data-spinner');
          }
        }

        function setActionProcessing(btn, isProcessing, lockButton){
          if (!btn) return;
          const icon = btn.querySelector('.act-icon');
          if (!icon) return;
          const shouldLock = lockButton !== false;
          if (isProcessing){
            icon.classList.add('is-processing');
            if (shouldLock) btn.disabled = true;
            processingActionBtn = btn;
          } else {
            icon.classList.remove('is-processing');
            if (shouldLock) btn.disabled = false;
            if (processingActionBtn === btn){
              processingActionBtn = null;
            }
          }
        }

        function clearActionProcessing(){
          if (processingActionBtn){
            setActionProcessing(processingActionBtn, false);
          }
        }

        function bindNavigationButton(btn, pageName, startFn, endFn){
          if (!btn) return;
          btn.addEventListener('click', function(){
            if (btn.dataset.navLoading === '1') return;
            btn.dataset.navLoading = '1';
            if (startFn) startFn(btn);
            loadPage(pageName, function(){
              btn.dataset.navLoading = '0';
              if (endFn) endFn(btn);
            });
          });
        }


        function bindTopHalfAction(btn, pageName){
          if (!btn) return;
          btn.addEventListener('click', function(){
            if (topActionEnCours) return;
            topActionEnCours = true;
            setHalfLoading(btn, true);
            loadPage(pageName, function(){
              setHalfLoading(btn, false);
              topActionEnCours = false;
            });
          });
        }
    
        function formatHour(hora){
          if (!hora) return '--:--';
    
          if (hora instanceof Date){
            return `${hora.getHours()}:${hora.getMinutes().toString().padStart(2, '0')}`;
          }
    
          const raw = String(hora).trim();
          const direct = raw.match(/(\d{1,2}):(\d{2})/);
          if (direct){
            return `${Number(direct[1])}:${direct[2]}`;
          }
    
          const parsed = new Date(raw);
          if (!isNaN(parsed.getTime())){
            return `${parsed.getHours()}:${parsed.getMinutes().toString().padStart(2, '0')}`;
          }
    
          return raw;
        }
    
        function formatMoney(value){
          if (typeof value !== 'number' || !isFinite(value)) return null;
          return value.toFixed(2).replace('.', ',');
        }
    
        function renderPedido(pedido){
          card.style.display = '';

          if (!pedido){
            pedidoActual = null;
            card.classList.add('is-empty');
            card.classList.remove('is-confirm','is-deleted','is-timeconfirm','is-deliveryconfirm','is-delivered');
            heureText.textContent = '--:--';
            sectorText.textContent = '—';
            clienteText.textContent = '—';
            direccionText.textContent = '—';
            notaText.textContent = '';
            extraText.textContent = '';
            currentHour = '--:--';
            if (cardEmptyText){
              cardEmptyText.innerHTML = 'Sin pedido<br>Pendiente';
            }
            clearActionProcessing();
            lockToNormalHeight();
            return;
          }

          card.classList.remove('is-empty');
          const sector = pedido.cliente && pedido.cliente.sector ? pedido.cliente.sector : '—';
          const nombre = pedido.cliente && pedido.cliente.nombre ? pedido.cliente.nombre.toUpperCase() : '—';
          const direccion = pedido.cliente && pedido.cliente.direccion ? pedido.cliente.direccion : '—';
          const notas = pedido.notas ? `Nota : ${pedido.notas}` : '';

          const cantidadValida = typeof pedido.cantidad === 'number' && isFinite(pedido.cantidad) && pedido.cantidad > 0;
          const totalValido = typeof pedido.total === 'number' && isFinite(pedido.total);
          const precioSectorValido = typeof pedido.precioUnitarioSector === 'number' && isFinite(pedido.precioUnitarioSector);
          let resumenExtra = '';
          if (cantidadValida && totalValido){
            const unitPrice = precioSectorValido
              ? pedido.precioUnitarioSector
              : (pedido.total / pedido.cantidad);
            const cantidadTxt = `${pedido.cantidad} seco${pedido.cantidad === 1 ? '' : 's'}`;
            const unitTxt = formatMoney(unitPrice);
            const totalTxt = formatMoney(pedido.total);
            if (unitTxt && totalTxt){
              resumenExtra = `${cantidadTxt} x ${unitTxt} $ = ${totalTxt} $`;
            }
          }
    
          pedidoActual = pedido;
          const horaFormateada = formatHour(pedido.horaEntrega);
          heureText.textContent = horaFormateada;
          sectorText.textContent = sector || '—';
          clienteText.textContent = nombre || '—';
          direccionText.textContent = direccion || '—';
          notaText.textContent = notas;
          extraText.textContent = resumenExtra;
          currentHour = horaFormateada;
          setNormal();
          captureNormalHeight();
        }
    
        function refreshProximaEntregaCard(){
          card.classList.remove('is-deleted','is-delivered');
          setCardLoading(true);
          google.script.run
            .withSuccessHandler(function(resp){
              if (resp && resp.ok && resp.data){
                renderPedido(resp.data.pedido);
              } else {
                renderPedido(null);
              }
              setCardLoading(false);
            })
            .withFailureHandler(function(){ renderPedido(null); setCardLoading(false); })
            .getProximaEntrega();
        }
    
        function actualizarEstado(estado){
          if (!pedidoActual || !pedidoActual.idPedido) return;
          const processingBtn = actionOrigin || btnConfirm;
          setCardLoading(true);
          setButtonLoading(btnConfirm, true);
          setConfirmButtonLoading(true);
          setActionProcessing(processingBtn, true);
          google.script.run
            .withSuccessHandler(function(resp){
              setActionProcessing(processingBtn, false);
              setButtonLoading(btnConfirm, false);
              setConfirmButtonLoading(false);
              setNormal();
              if (resp && resp.ok){
                refreshProximaEntregaCard();
              } else {
                setCardLoading(false);
              }
            })
            .withFailureHandler(function(){
              setActionProcessing(processingBtn, false);
              setButtonLoading(btnConfirm, false);
              setConfirmButtonLoading(false);
              setCardLoading(false);
            })
            .actualizarEstadoPedido({ idPedido: pedidoActual.idPedido, estado: estado });
        }

        function construirPayloadHoraActualizada(nuevaHora){
          var notasActuales = '';
          if (pedidoActual && (pedidoActual.notas || pedidoActual.nota)) {
            notasActuales = pedidoActual.notas || pedidoActual.nota || '';
          }

          return {
            idPedido: pedidoActual.idPedido,
            fechaEntrega: pedidoActual.fechaEntrega || pedidoActual.fecha || '',
            horaEntrega: nuevaHora,
            cantidad: pedidoActual.cantidad,
            notas: notasActuales
          };
        }

        function actualizarHora(nuevaHora){
          if (!pedidoActual || !pedidoActual.idPedido || !nuevaHora) return;
          const processingBtn = actionOrigin || btnConfirm;
          setCardLoading(true);
          setButtonLoading(btnConfirm, true);
          setConfirmButtonLoading(true);
          setActionProcessing(processingBtn, true);

          var payloadHora = construirPayloadHoraActualizada(nuevaHora);

          google.script.run
            .withSuccessHandler(function(resp){
              setActionProcessing(processingBtn, false);
              setButtonLoading(btnConfirm, false);
              setConfirmButtonLoading(false);
              setNormal();
              if (resp && resp.ok){
                var pedidoResp = resp.data && resp.data.pedido ? resp.data.pedido : null;
                if (pedidoResp){
                  pedidoActual = pedidoResp;
                  window.SECO_CTX = { pedido: pedidoResp };
                }
                refreshProximaEntregaCard();
              } else {
                setCardLoading(false);
              }
            })
            .withFailureHandler(function(){
              setActionProcessing(processingBtn, false);
              setButtonLoading(btnConfirm, false);
              setConfirmButtonLoading(false);
              setNormal();
              setCardLoading(false);
            })
            .editarPedidoPorId(payloadHora);
        }
    
        btnDel.addEventListener('click', function(e){
          e.stopPropagation();
          if (!pedidoActual) return;
          if (card.classList.contains('is-confirm') || card.classList.contains('is-timeconfirm') || card.classList.contains('is-deliveryconfirm')){
            setNormal();
          } else {
            setConfirm();
          }
        });
    
        btnConfirm.addEventListener('click', function(e){
          e.stopPropagation();
          if (!pedidoActual) return;
          if (card.classList.contains('is-confirm')){
            actualizarEstado('Cancelado');
          } else if (card.classList.contains('is-timeconfirm')){
            if (pendingHour){
              actualizarHora(pendingHour);
              pendingHour = null;
            }
          } else if (card.classList.contains('is-deliveryconfirm')){
            actualizarEstado('Entregado');
          } else {
            setDeliveryConfirm();
          }
        });
    
        card.addEventListener('click', function(){
          if (card.classList.contains('is-deleted') || card.classList.contains('is-delivered')){
            setNormal();
          }
        });
    
        function pad(n){ return n<10 ? '0'+n : ''+n; }
        function buildTimes(){
          const out=[];
          for(let h=6; h<=18; h++){
            for(let m=0; m<60; m+=5){
              if(h===18 && m>55) break;
              out.push(h+":"+pad(m));
            }
          }
          return out;
        }
    
        function openHoursOverlay(){
          if (!pedidoActual) return;
          overlayList.innerHTML = '';
    
          function markSelectedOption(optionEl){
            overlayList.querySelectorAll('.dd-grid-option.is-selected').forEach(function(node){
              node.classList.remove('is-selected');
            });
            if (optionEl){
              optionEl.classList.add('is-selected');
            }
          }
    
          const selectedHour = pendingHour || currentHour;

          const ph = document.createElement('li');
          ph.className = 'dd-grid-option placeholder';
          ph.textContent = 'Heure';
          ph.addEventListener('click', () => closeOverlay());
          overlayList.appendChild(ph);
    
          const times = buildTimes();
          let col = 1;
          let rowCount = 0;
    
          times.forEach((txt, idx) => {
            const li = document.createElement('li');
            li.className = 'dd-grid-option';
            li.dataset.col = String(col);
            li.textContent = txt;
            li.addEventListener('click', () => {
              pendingHour = txt;
              markSelectedOption(li);
              requestAnimationFrame(() => {
                setTimeout(() => {
                  closeOverlay();
                  setTimeConfirm();
                }, 80);
              });
            });
            overlayList.appendChild(li);

            if (selectedHour && txt === selectedHour){
              markSelectedOption(li);
            }

            col = (col % 3) + 1;
            if ((idx+1) % 3 === 0){
              rowCount++;
              if (rowCount === 4 && idx < times.length - 1){
                const sep = document.createElement('li');
                sep.className = 'dd-grid-sep-black';
                overlayList.appendChild(sep);
                rowCount = 0;
              }
            }
          });
    
          overlay.setAttribute('data-open','true');
          document.body.style.overflow = 'hidden';
        }
    
        function closeOverlay(){
          overlay.removeAttribute('data-open');
          document.body.style.overflow = '';
          if (!pendingHour && actionOrigin === btnDelay){
            clearActionProcessing();
            actionOrigin = null;
          }
        }
    
        btnDelay.addEventListener('click', function(e){
          e.stopPropagation();
          if (!pedidoActual) return;
          setActionProcessing(btnDelay, true, false);
          actionOrigin = btnDelay;
          openHoursOverlay();
        });
    
        overlay.addEventListener('click', function(e){
          if (e.target === overlay) closeOverlay();
        });
    
        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && overlay.getAttribute('data-open')){
            closeOverlay();
          }
        });

        function prepararCtxEditarPedido(){
          if (!pedidoActual) return null;
          var ctx = {
            origen: 'inicio',
            pedidoId: pedidoActual.idPedido || '',
            pedido: pedidoActual,
            cliente: pedidoActual.cliente || null,
            idContacto: (pedidoActual.cliente && pedidoActual.cliente.idCliente) ? pedidoActual.cliente.idCliente : ''
          };
          window.SECO_CTX = ctx;
          return ctx;
        }

        if (editCell){
          editCell.addEventListener('click', function(){
            if (!pedidoActual || editCell.dataset.editing === '1') return;
            editCell.dataset.editing = '1';
            setEditLoading(true);
            prepararCtxEditarPedido();
            if (pedidoActual) {
              window.SECO_CTX = window.SECO_CTX || {};
              window.SECO_CTX.pedidoEnEdicion = pedidoActual;
            }
            loadPage('editarPedido', function(){
              setEditLoading(false);
              editCell.dataset.editing = '0';
            });
          });
        }
    
        function applyScaleFix(){
          let cssW = window.innerWidth;
          let screenW = Math.min(window.screen.width, window.screen.height);
          if (cssW >= 960 && cssW <= 1024){
            let fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
          setTimeout(captureNormalHeight, 0);
        }
    
        bindTopHalfAction(btnNuevoPedido, 'nuevoPedido');
        bindTopHalfAction(btnVentaDirecta, 'ventaDirecta');
        bindNavigationButton(btnPedidosDelDia, 'pedidosDelDia', (btn) => setPedidosDelDiaLoading(btn, true), (btn) => setPedidosDelDiaLoading(btn, false));
        if (btnRegistrarGasto){
          btnRegistrarGasto.addEventListener('click', function(){
            resetGastoState();
            loadPage('registrarGasto');
          });
        }
        bindNavigationButton(btnCerrarElDia, 'cerrarElDia', (btn) => setPedidosDelDiaLoading(btn, true), (btn) => setPedidosDelDiaLoading(btn, false));
        bindNavigationButton(btnConfiguracion, 'configuracionDelSistema', (btn) => setPedidosDelDiaLoading(btn, true), (btn) => setPedidosDelDiaLoading(btn, false));
    
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', ()=>{
            currentHour = heureText.textContent.trim();
            applyScaleFix();
            captureNormalHeight();
            setCardLoading(true);
            refreshProximaEntregaCard();
          });
        } else {
          currentHour = heureText.textContent.trim();
          applyScaleFix();
          captureNormalHeight();
          setCardLoading(true);
          refreshProximaEntregaCard();
        }
    
        window.addEventListener('resize', ()=>{
          applyScaleFix();
          if (!card.classList.contains('is-confirm') &&
              !card.classList.contains('is-deleted') &&
              !card.classList.contains('is-timeconfirm') &&
              !card.classList.contains('is-deliveryconfirm') &&
              !card.classList.contains('is-delivered') &&
              !card.classList.contains('is-empty')){
            captureNormalHeight();
          } else {
            lockToNormalHeight();
          }
        });

      })();
  },

  registrarGasto: function(){
    (function(){
        const expenseDate = document.getElementById('expenseDate');
        const today = new Date();
        const fechaHoy = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;

        if (!window.gastoState.fecha){
          updateGastoState('fecha', fechaHoy);
        }

        ensureGastoStateConsistente();

        if (expenseDate){
          expenseDate.textContent = window.gastoState.fecha || fechaHoy;
        }

        clearError();

        var overlay = document.getElementById('ddOverlay');
        var overlayList = document.getElementById('ddOverlayList');
        var currentDropdown = null;

        var registrarGastoLoading = document.getElementById('registrarGastoLoading');
        var registrarGastoFields = document.getElementById('registrarGastoFields');

        var dropdownScope = registrarGastoFields || document;
        var dropdowns = Array.from(dropdownScope.querySelectorAll('.dropdown[data-variant="boxed"]'));
        var categoriaDropdown = dropdowns.length ? dropdowns[0] : null;
        var productoDropdown = dropdowns.length > 1 ? dropdowns[1] : null;
        var proveedorDropdown = dropdowns.length > 2 ? dropdowns[2] : null;
        var unidadDropdown = dropdowns.length > 3 ? dropdowns[3] : null;

        var registrarCostoContainer = document.getElementById('registrarCostoContainer');
        var precioUnitarioContainer = document.getElementById('precioUnitarioContainer');
        var expenseCard = document.getElementById('expenseCard');
        var expenseCardLoading = document.getElementById('expenseCardLoading');
        var qtyInput = document.getElementById('qtyInput');
        var unitLabel = document.getElementById('unitLabel');
        var unitPriceText = document.getElementById('unitPriceText');
        var expenseTotal = document.getElementById('expenseTotal');
        var obsField = document.getElementById('obsField');
        var errorContainer = document.getElementById('registrarGastoError') || document.querySelector('[data-role="error"]');
        var btnRegistrarGasto = document.getElementById('btnRegistrar');
        var btnRegistrarCostoCta = document.getElementById('btnRegistrarCostoCta');

        var categoriaLoading = false;
        var productoLoading = false;
        var proveedorLoading = false;
        var unidadLoading = false;
        var costoLookupPending = false;
        var costoLookupFailedParse = false;

        var sectionCategoria = document.getElementById('sectionCategoria');
        var sectionProducto = document.getElementById('sectionProducto');
        var sectionProveedor = document.getElementById('sectionProveedor');
        var sectionUnidad = document.getElementById('sectionUnidad');
        var sectionObservaciones = document.getElementById('sectionObservaciones');
        var sepAfterProducto = document.getElementById('sepAfterProducto');
        var sepBeforeCosto = document.getElementById('sepBeforeCosto');
        var sepAfterCosto = document.getElementById('sepAfterCosto');
        var sepBeforeButtons = document.getElementById('sepBeforeButtons');
        var categoriaLockedContainer = document.getElementById('categoriaLockedContainer');
        var categoriaLockedValue = document.getElementById('categoriaLockedValue');
        var btnUnlockCategoria = document.getElementById('btnUnlockCategoria');

        function hideElement(el){
          if (!el) return;
          el.style.display = 'none';
          el.classList.add('hidden');
        }

        function showElement(el){
          if (!el) return;
          el.style.display = '';
          el.classList.remove('hidden');
        }

        function setInitialLoadingState(){
          hideElement(registrarGastoFields);
          hideElement(sectionCategoria);
          showElement(registrarGastoLoading);
        }

        function setCategoriasReadyState(){
          hideElement(registrarGastoLoading);
          showElement(registrarGastoFields);
          showElement(sectionCategoria);
        }

        function formatMoney(val){
          var num = typeof val === 'number' ? val : parseFloat(val);
          if (!isFinite(num)) num = 0;
          return num.toFixed(2).replace('.', ',') + ' $';
        }

        function getMesFromFecha(fecha){
          if (!fecha) return '';
          var parts = fecha.split('/');
          return parts.length >= 2 ? parts[1] : '';
        }

        function clearError(){
          if (errorContainer){
            errorContainer.textContent = '';
            errorContainer.style.display = 'none';
          }
        }

        function showError(msg){
          if (errorContainer){
            errorContainer.textContent = msg || 'Ocurrió un error al registrar el gasto.';
            errorContainer.style.display = '';
          } else {
            alert(msg || 'Ocurrió un error al registrar el gasto.');
          }
        }

        function ensureGastoStateConsistente(){
          var shouldReset = false;

          if (!gastoState.categoria && (gastoState.producto || gastoState.idProducto || gastoState.proveedor || gastoState.unidad || gastoState.precioUnitario)){
            shouldReset = true;
          }

          if (gastoState.producto && !gastoState.categoria){
            shouldReset = true;
          }

          if (!gastoState.proveedor && gastoState.precioUnitario){
            updateGastoState('precioUnitario', null);
            updateGastoState('unidad', null);
          }

          if (shouldReset){
            resetGastoState();
            updateGastoState('fecha', fechaHoy);
          }
        }

        function setRegistrarEnabled(enabled){
          if (!btnRegistrarGasto) return;
          btnRegistrarGasto.disabled = !enabled;
          if (enabled){
            btnRegistrarGasto.classList.remove('btn-desactive');
            if (!btnRegistrarGasto.classList.contains('btn-noir')){
              btnRegistrarGasto.classList.add('btn-noir');
            }
          } else {
            if (!btnRegistrarGasto.classList.contains('btn-desactive')){
              btnRegistrarGasto.classList.add('btn-desactive');
            }
            btnRegistrarGasto.classList.remove('btn-noir');
          }
        }

        function hideSeccionesFinales(){
          hideElement(sectionObservaciones);
          hideElement(sepAfterCosto);
          hideElement(sepBeforeButtons);
          hideElement(btnRegistrarGasto);
        }

        function showSeccionesFinales(){
          showElement(sectionObservaciones);
          showElement(sepAfterCosto);
          showElement(sepBeforeButtons);
          showElement(btnRegistrarGasto);
        }

        function sanitizeCantidadInput(){
          if (!qtyInput) return '';
          return normalizeNumericInput(qtyInput);
        }

        function handleQtyKeydown(e){
          var allowed = ['Backspace','Tab','Enter','ArrowLeft','ArrowRight','Delete',',','.'];
          if (allowed.indexOf(e.key) !== -1) return;
          if (/^\d$/.test(e.key)) return;
          e.preventDefault();
        }

        function isFormularioValido(){
          var precioNumero = parseFloat(gastoState.precioUnitario);
          var cantidadParsed = parseInputCantidad(qtyInput).number;

          return !!(
            gastoState.fecha &&
            gastoState.categoria &&
            gastoState.producto &&
            gastoState.proveedor &&
            gastoState.unidad &&
            isFinite(precioNumero) &&
            isFinite(cantidadParsed) &&
            cantidadParsed > 0 &&
            gastoState.idProducto
          );
        }

        function updateMontoDesdeCantidad(){
          var parsed = parseInputCantidad(qtyInput);
          var cantidadNumber = parsed.number;

          if (!parsed.sanitized){
            updateGastoState('cantidad', null);
            updateGastoState('gasto', null);
            if (expenseTotal){
              expenseTotal.textContent = '0,00 $';
            }
            setRegistrarEnabled(false);
            return;
          }

          if (!isFinite(cantidadNumber) || cantidadNumber <= 0){
            updateGastoState('cantidad', null);
            updateGastoState('gasto', null);
            if (expenseTotal){
              expenseTotal.textContent = '0,00 $';
            }
            showError('Cantidad inválida.');
            setRegistrarEnabled(false);
            return;
          }

          updateGastoState('cantidad', cantidadNumber);
          var precioNumero = parseFloat(gastoState.precioUnitario);
          var tienePrecio = isFinite(precioNumero);
          var monto = tienePrecio ? cantidadNumber * precioNumero : 0;
          updateGastoState('gasto', monto);

          if (expenseTotal){
            expenseTotal.textContent = formatMoney(monto);
          }

          if (tienePrecio && monto > 0){
            clearError();
          }

          setRegistrarEnabled(isFormularioValido());
        }

        function setExpenseCardLoading(isLoading){
          if (!expenseCard) return;

          if (isLoading){
            showElement(precioUnitarioContainer);
            expenseCard.style.display = '';
            expenseCard.classList.remove('hidden');
            hideElement(registrarCostoContainer);
            expenseCard.classList.add('is-loading');
            if (expenseCardLoading){
              expenseCardLoading.setAttribute('aria-hidden', 'false');
            }
            return;
          }

          expenseCard.classList.remove('is-loading');
          if (expenseCardLoading){
            expenseCardLoading.setAttribute('aria-hidden', 'true');
          }
        }

        function refreshExpenseCard(){
          var hasData = gastoState.categoria && gastoState.producto && gastoState.proveedor && gastoState.unidad;
          var precioNumber = parseFloat(gastoState.precioUnitario);
          var canShowCard = (costoLookupPending && !!gastoState.unidad) || (hasData && isFinite(precioNumber));
          var costoDebug = gastoState.costoDebug;
          var hasLookupStatus = !!(costoDebug && costoDebug.matchStatus);
          var lookupStatusInvalido = hasLookupStatus && costoDebug.matchStatus !== 'row_found';
          var shouldShowCostoError = hasData && !costoLookupPending && (lookupStatusInvalido || costoLookupFailedParse);

          if (expenseCard){
            if (canShowCard){
              expenseCard.style.display = '';
              expenseCard.classList.remove('hidden');
            } else {
              expenseCard.style.display = 'none';
              expenseCard.classList.add('hidden');
            }
          }

          if (!canShowCard){
            setExpenseCardLoading(false);
            if (expenseTotal){
              expenseTotal.textContent = '0,00 $';
            }
            if (qtyInput){
              qtyInput.value = '';
            }
            if (shouldShowCostoError){
              var errorCosto = 'No hay costo disponible para el producto seleccionado.';
              if (DEBUG_COSTO && costoDebug){
                var sheet = costoDebug.sheet || 'PRODUCTO';
                var cell = costoDebug.priceCell || '';
                var rawValue = costoDebug.rawValue;
                var rawText = (rawValue === null || typeof rawValue === 'undefined' || rawValue === '') ? '' : String(rawValue);
                var cellExpr = cell ? (sheet + '!' + cell) : (sheet + '!');
                errorCosto += ' [' + cellExpr + " = '" + rawText + "']" +
                  ' (idProducto=' + (costoDebug.idProducto || '') +
                  ', categoria=' + (costoDebug.categoria || '') +
                  ', producto=' + (costoDebug.producto || '') +
                  ', proveedor=' + (costoDebug.proveedor || '') +
                  ', unidad=' + (costoDebug.unidad || '') +
                  ', status=' + (costoDebug.matchStatus || '') + ')';
              }
              showError(errorCosto);
            }
            setRegistrarEnabled(false);
            return;
          }

          if (costoLookupPending){
            setExpenseCardLoading(true);
            setRegistrarEnabled(false);
            return;
          }

          setExpenseCardLoading(false);
          clearError();

          if (unitLabel){
            unitLabel.textContent = (gastoState.unidad || '').toString().toLowerCase();
          }
          if (unitPriceText){
            var unitTxt = (gastoState.unidad || '').toString().toLowerCase();
            unitPriceText.textContent = precioNumber.toFixed(2).replace('.', ',') + ' $ / ' + unitTxt;
          }

          if (typeof gastoState.cantidad === 'number' && isFinite(gastoState.cantidad) && gastoState.cantidad > 0){
            var qtyStr = gastoState.cantidad.toString().replace('.', ',');
            if (qtyInput && qtyInput.value !== qtyStr){
              qtyInput.value = qtyStr;
            }
            var monto = gastoState.cantidad * precioNumber;
            updateGastoState('gasto', monto);
            if (expenseTotal){
              expenseTotal.textContent = formatMoney(monto);
            }
            setRegistrarEnabled(isFormularioValido());
          } else {
            if (expenseTotal){
              expenseTotal.textContent = '0,00 $';
            }
            if (qtyInput && !qtyInput.value){
              qtyInput.value = '';
            }
            setRegistrarEnabled(false);
          }
        }

        function setDropdownPlaceholder(dropdown){
          if (!dropdown) return;
          var label = dropdown.querySelector('.dd-label');
          var btn = dropdown.querySelector('.dd-button');
          var ph = dropdown.dataset.ph || (label && label.textContent.trim()) || 'Seleccionar';

          if (label){
            label.textContent = ph;
          }
          if (btn){
            btn.setAttribute('data-placeholder', 'true');
          }
          dropdown.dataset.value = '';
        }

        function lockCategoria(value){
          if (categoriaLockedValue){
            categoriaLockedValue.textContent = value || '';
          }
          if (categoriaDropdown){
            hideElement(categoriaDropdown);
          }
          if (categoriaLockedContainer){
            showElement(categoriaLockedContainer);
          }
        }

        function unlockCategoria(){
          updateGastoState('categoria', null);
          resetCamposDependientes();
          setDropdownPlaceholder(categoriaDropdown);
          if (categoriaLockedContainer){
            hideElement(categoriaLockedContainer);
          }
          if (categoriaDropdown){
            showElement(categoriaDropdown);
          }
        }

        function bindUnlockCategoria(){
          if (!btnUnlockCategoria) return;
          btnUnlockCategoria.addEventListener('click', function(){
            unlockCategoria();
          });
        }

        function showDropdownSpinner(dropdown){
          if (!dropdown) return;
          var btn = dropdown.querySelector('.dd-button');
          if (!btn) return;
          btn.classList.add('dd-loading');
          btn.disabled = true;
          btn.setAttribute('aria-busy', 'true');
        }

        function hideDropdownSpinner(dropdown){
          if (!dropdown) return;
          var btn = dropdown.querySelector('.dd-button');
          if (!btn) return;
          btn.classList.remove('dd-loading');
          btn.disabled = false;
          btn.removeAttribute('aria-busy');
        }

        function isDropdownLoading(dropdown){
          if (dropdown === categoriaDropdown) return categoriaLoading;
          if (dropdown === productoDropdown) return productoLoading;
          if (dropdown === proveedorDropdown) return proveedorLoading;
          if (dropdown === unidadDropdown) return unidadLoading;
          return false;
        }

        function setDropdownLoading(dropdown, loading){
          if (dropdown === categoriaDropdown){
            categoriaLoading = !!loading;
          } else if (dropdown === productoDropdown){
            productoLoading = !!loading;
          } else if (dropdown === proveedorDropdown){
            proveedorLoading = !!loading;
          } else if (dropdown === unidadDropdown){
            unidadLoading = !!loading;
          }

          if (loading){
            showDropdownSpinner(dropdown);
            return;
          }

          hideDropdownSpinner(dropdown);
        }

        function resetGastoStateDependencias(){
          costoLookupPending = false;
          costoLookupFailedParse = false;
          updateGastoState('producto', null);
          updateGastoState('idProducto', null);
          updateGastoState('proveedor', null);
          updateGastoState('unidad', null);
          updateGastoState('precioUnitario', null);
          updateGastoState('cantidad', null);
          updateGastoState('gasto', null);
        }

        function resetCamposDependientes(){
          resetGastoStateDependencias();

          setDropdownLoading(productoDropdown, false);
          setDropdownLoading(proveedorDropdown, false);
          setDropdownLoading(unidadDropdown, false);
          setDropdownPlaceholder(productoDropdown);
          setDropdownPlaceholder(proveedorDropdown);
          setDropdownPlaceholder(unidadDropdown);

          if (qtyInput){
            qtyInput.value = '';
          }

          if (unitLabel){
            unitLabel.textContent = '';
          }

          if (unitPriceText){
            unitPriceText.textContent = '';
          }

          if (expenseTotal){
            expenseTotal.textContent = '0,00 $';
          }

          refreshExpenseCard();

          hideElement(sectionProducto);
          hideElement(sepAfterProducto);
          hideElement(sectionProveedor);
          hideElement(sectionUnidad);
          hideElement(sepBeforeCosto);
          hideSeccionesFinales();
          ocultarSeccionesCosto();
        }

        function resetCamposDesdeProducto(){
          costoLookupPending = false;
          costoLookupFailedParse = false;
          updateGastoState('proveedor', null);
          updateGastoState('unidad', null);
          updateGastoState('precioUnitario', null);
          updateGastoState('cantidad', null);
          updateGastoState('gasto', null);

          setDropdownLoading(proveedorDropdown, false);
          setDropdownLoading(unidadDropdown, false);
          setDropdownPlaceholder(proveedorDropdown);
          setOptionsToDropdown(proveedorDropdown, []);
          setDropdownPlaceholder(unidadDropdown);
          setOptionsToDropdown(unidadDropdown, []);

          if (qtyInput){
            qtyInput.value = '';
          }

          if (unitLabel){
            unitLabel.textContent = '';
          }

          if (unitPriceText){
            unitPriceText.textContent = '';
          }

          if (expenseTotal){
            expenseTotal.textContent = '0,00 $';
          }

          refreshExpenseCard();

          hideElement(sectionProveedor);
          hideElement(sectionUnidad);
          hideElement(sepBeforeCosto);
          hideSeccionesFinales();
          ocultarSeccionesCosto();
        }

        function ocultarSeccionesCosto(){
          hideElement(registrarCostoContainer);
          hideElement(precioUnitarioContainer);
          hideSeccionesFinales();

          refreshExpenseCard();
        }

        function mostrarRegistrarCosto(){
          showElement(registrarCostoContainer);
          hideElement(precioUnitarioContainer);
          hideSeccionesFinales();

          refreshExpenseCard();
        }

        function mostrarPrecioUnitario(){
          showElement(precioUnitarioContainer);
          hideElement(registrarCostoContainer);
          showSeccionesFinales();

          refreshExpenseCard();
        }

        function showProductoContainer(){
          showElement(sectionProducto);
          showElement(sepAfterProducto);
        }

        function showProveedorContainer(){
          showElement(sectionProveedor);
        }

        function showUnidadContainer(){
          showElement(sectionUnidad);
          showElement(sepBeforeCosto);
        }

        function getOptionsFromDropdown(dropdown){
          var dataEl = dropdown ? dropdown.querySelector('.dd-data') : null;
          if (!dataEl) return [];
          var raw = dataEl.getAttribute('data-options') || dataEl.textContent || '[]';
          try {
            return JSON.parse(raw);
          } catch (err){
            return [];
          }
        }

        function setOptionsToDropdown(dropdown, options){
          var dataEl = dropdown ? dropdown.querySelector('.dd-data') : null;
          if (!dataEl) return;

          var json = JSON.stringify(options || []);
          dataEl.textContent = json;
          dataEl.setAttribute('data-options', json);
        }

        function prepararDropdownUnidad(unidades){
          if (!unidadDropdown) return;

          unidadDropdown.dataset.ph = 'Unidad';

          var opts = (unidades || []).slice();
          setOptionsToDropdown(unidadDropdown, opts);

          if (gastoState.unidad && opts.indexOf(gastoState.unidad) !== -1){
            selectOption(unidadDropdown, gastoState.unidad);
          } else {
            setDropdownPlaceholder(unidadDropdown);
          }
        }

        function cargarUnidades(){
          if (!unidadDropdown || !gastoState.proveedor) return;

          setOptionsToDropdown(unidadDropdown, []);
          unidadDropdown.dataset.ph = 'Unidad';
          showUnidadContainer();
          setDropdownLoading(unidadDropdown, true);

          if (
            typeof google === 'undefined' ||
            !google.script ||
            !google.script.run
          ){
            setDropdownLoading(unidadDropdown, false);
            setDropdownPlaceholder(unidadDropdown);
            return;
          }

          google.script.run
            .withSuccessHandler(function(unidades){
              setDropdownLoading(unidadDropdown, false);
              if (!Array.isArray(unidades)) unidades = [];

              prepararDropdownUnidad(unidades);
              showUnidadContainer();
            })
            .withFailureHandler(function(err){
              setDropdownLoading(unidadDropdown, false);
              setDropdownPlaceholder(unidadDropdown);
              var msg = (err && err.message) ? err.message : 'No se pudieron cargar las unidades.';
              showError(msg);
            })
            .getUnidades(gastoState.categoria, gastoState.producto, gastoState.proveedor);
        }

        function cargarCostoSiListo(){
          if (
            typeof google === 'undefined' ||
            !google.script ||
            !google.script.run ||
            !gastoState.idProducto ||
            !gastoState.proveedor ||
            !gastoState.unidad
          ) return;

          costoLookupPending = true;
          costoLookupFailedParse = false;

          google.script.run
            .withSuccessHandler(function(costo){
              updateGastoState('costoDebug', (costo && costo.debug) ? costo.debug : null);

              var precioRaw = (costo && typeof costo.precioUnitario !== 'undefined' && costo.precioUnitario !== null)
                ? costo.precioUnitario
                : null;
              var precioNormalizado = (typeof precioRaw === 'string') ? precioRaw.replace(',', '.') : precioRaw;
              var precioNumero = (precioRaw === null) ? NaN : Number(precioNormalizado);


              if (isFinite(precioNumero)){
                updateGastoState('precioUnitario', precioNumero);
                costoLookupFailedParse = false;
                mostrarPrecioUnitario();
              } else {
                updateGastoState('precioUnitario', null);
                costoLookupFailedParse = (precioRaw !== null);
                mostrarRegistrarCosto();
              }


              costoLookupPending = false;
              setExpenseCardLoading(false);
              refreshExpenseCard();
            })
            .withFailureHandler(function(err){
              costoLookupPending = false;
              setExpenseCardLoading(false);
              costoLookupFailedParse = false;
              updateGastoState('precioUnitario', null);
              updateGastoState('costoDebug', null);
              mostrarRegistrarCosto();
              refreshExpenseCard();
              var msg = (err && err.message) ? err.message : 'No se pudo obtener el costo.';
              showError(msg);
            })
            .getCosto(gastoState.idProducto, gastoState.proveedor, gastoState.unidad, gastoState.categoria, gastoState.producto);
        }

        function resolverIdProductoYCargarCosto(){
          if (
            typeof google === 'undefined' ||
            !google.script ||
            !google.script.run ||
            !gastoState.categoria ||
            !gastoState.producto ||
            !gastoState.proveedor ||
            !gastoState.unidad
          ) return;

          google.script.run
            .withSuccessHandler(function(id){
              updateGastoState('idProducto', id || null);

              if (!id){
                costoLookupPending = false;
                setExpenseCardLoading(false);
                costoLookupFailedParse = false;
                updateGastoState('precioUnitario', null);
                updateGastoState('costoDebug', null);
                mostrarRegistrarCosto();
                refreshExpenseCard();
                return;
              }

              cargarCostoSiListo();
            })
            .withFailureHandler(function(err){
              costoLookupPending = false;
              setExpenseCardLoading(false);
              costoLookupFailedParse = false;
              updateGastoState('idProducto', null);
              updateGastoState('precioUnitario', null);
              updateGastoState('costoDebug', null);
              mostrarRegistrarCosto();
              refreshExpenseCard();
              var msg = (err && err.message) ? err.message : 'No se pudo obtener el producto seleccionado.';
              showError(msg);
            })
            .getIdProducto(gastoState.categoria, gastoState.producto, gastoState.proveedor, gastoState.unidad);
        }

        function closeOverlay(){
          if (!overlay) return;
          overlay.setAttribute('data-open','false');
          document.body.style.overflow = '';
          document.body.classList.remove('dd-open');
          document.documentElement.classList.remove('dd-open');
          currentDropdown = null;
          if (overlayList){
            overlayList.innerHTML = '';
          }
        }

        function selectOption(dropdown, value){
          if (!dropdown) return;
          var label = dropdown.querySelector('.dd-label');
          var btn = dropdown.querySelector('.dd-button');

          clearError();

          if (label){
            label.textContent = value;
          }
          if (btn){
            btn.removeAttribute('data-placeholder');
          }
          dropdown.dataset.value = value;

          if (dropdown === categoriaDropdown){
            if (value === 'Nueva categoria'){
              updateGastoState('origen', 'GASTO');
              loadPage('nuevaCategoria');
              closeOverlay();
              if (btn){
                setTimeout(()=>btn.focus({preventScroll:true}),0);
              }
              return;
            }

            var previousCategoria = gastoState.categoria;
            updateGastoState('categoria', value);

            if (previousCategoria !== value){
              resetCamposDependientes();
            }

            if (value){
              lockCategoria(value);
              showProductoContainer();
              cargarProductosPorCategoria(value);
            }
          }

          if (dropdown === productoDropdown){
            var previousProducto = gastoState.producto;
            var shouldResetProductoDeps = previousProducto !== value;

            updateGastoState('producto', value);
            if (shouldResetProductoDeps){
              updateGastoState('idProducto', null);
              resetCamposDesdeProducto();
            }
            showProveedorContainer();

            if (
              gastoState.categoria &&
              gastoState.producto
            ){
              proveedorDropdown.dataset.ph = 'Proveedor';
              setOptionsToDropdown(proveedorDropdown, []);
              setDropdownLoading(proveedorDropdown, true);

              if (
                typeof google !== 'undefined' &&
                google.script &&
                google.script.run
              ){
                google.script.run
                  .withSuccessHandler(function(proveedores){
                    setDropdownLoading(proveedorDropdown, false);
                    if (!Array.isArray(proveedores)) proveedores = [];

                    var sorted = proveedores.slice().sort(function(a, b){
                      return String(a || '').localeCompare(String(b || ''));
                    });

                    var opts = ['Nuevo proveedor'].concat(sorted);

                    proveedorDropdown.dataset.ph = 'Proveedor';
                    setOptionsToDropdown(proveedorDropdown, opts);

                    if (gastoState.proveedor && opts.indexOf(gastoState.proveedor) !== -1){
                      selectOption(proveedorDropdown, gastoState.proveedor);
                    } else {
                      setDropdownPlaceholder(proveedorDropdown);
                    }
                  })
                  .withFailureHandler(function(err){
                    setDropdownLoading(proveedorDropdown, false);
                    setDropdownPlaceholder(proveedorDropdown);
                    var msg = (err && err.message) ? err.message : 'No se pudieron cargar los proveedores.';
                    showError(msg);
                  })
                  .getProveedoresPorProducto(gastoState.categoria, gastoState.producto);
              } else {
                setDropdownLoading(proveedorDropdown, false);
                setDropdownPlaceholder(proveedorDropdown);
              }
            }
          }

          if (dropdown === proveedorDropdown){
            var previousProveedor = gastoState.proveedor;

            if (value === 'Nuevo proveedor'){
              updateGastoState('origen', 'GASTO');
              loadPage('nuevoProveedor');
              closeOverlay();
              if (btn){
                setTimeout(()=>btn.focus({preventScroll:true}),0);
              }
              return;
            }

            if (previousProveedor !== value){
              updateGastoState('idProducto', null);
              updateGastoState('unidad', null);
              updateGastoState('precioUnitario', null);
              updateGastoState('cantidad', null);
              updateGastoState('gasto', null);
              ocultarSeccionesCosto();
              hideElement(sectionUnidad);
              hideElement(sepBeforeCosto);
            }

            updateGastoState('proveedor', value);

            cargarUnidades();
          }

          if (dropdown === unidadDropdown){
            updateGastoState('idProducto', null);
            updateGastoState('unidad', value);
            updateGastoState('precioUnitario', null);
            updateGastoState('cantidad', null);
            updateGastoState('gasto', null);
            costoLookupPending = true;
            costoLookupFailedParse = false;
            if (qtyInput){ qtyInput.value = ''; }
            if (expenseTotal){ expenseTotal.textContent = '0,00 $'; }
            setExpenseCardLoading(true);
            resolverIdProductoYCargarCosto();
          }

          refreshExpenseCard();

          closeOverlay();
        }

        function openOverlay(dropdown){
          if (!overlay || !overlayList || !dropdown || isDropdownLoading(dropdown)) return;

          currentDropdown = dropdown;
          overlayList.innerHTML = "";

          var label = dropdown.querySelector('.dd-label');
          var btn = dropdown.querySelector('.dd-button');
          var placeholderText = dropdown.dataset.ph || (label && label.textContent.trim()) || 'Seleccionar';

          var liPh = document.createElement('li');
          liPh.className = 'dd-overlay-option placeholder';
          liPh.style.pointerEvents = 'auto';
          liPh.setAttribute('role', 'option');
          liPh.textContent = placeholderText;
          liPh.dataset.value = '';
          overlayList.appendChild(liPh);

          var options = getOptionsFromDropdown(dropdown);
          options.forEach(function(txt){
            var li = document.createElement('li');
            li.className = 'dd-overlay-option';
            li.style.pointerEvents = 'auto';
            li.setAttribute('role','option');
            li.textContent = txt;
            li.dataset.value = txt;
            overlayList.appendChild(li);
          });

          overlay.setAttribute('data-open','true');
          document.body.style.overflow = 'hidden';
          document.body.classList.add('dd-open');
          document.documentElement.classList.add('dd-open');
        }

        function setupDropdown(dropdown){
          if (!dropdown) return;
          var label = dropdown.querySelector('.dd-label');
          if (label && !dropdown.dataset.ph){
            dropdown.dataset.ph = label.textContent.trim();
          }

          var btn = dropdown.querySelector('.dd-button');
          if (btn){
            btn.addEventListener('click', function(){ openOverlay(dropdown); });
            btn.addEventListener('keydown', function(e){
              if (e.key === 'Enter' || e.key === ' '){
                e.preventDefault();
                openOverlay(dropdown);
              }
            });
          }
        }

        function initDropdowns(){
          dropdowns.forEach(setupDropdown);

          if (overlay){
            if (overlayList){
              overlayList.style.pointerEvents = 'auto';
            }

            var overlaySelectionHandler = function(e){
              var eventTarget = e.target;
              if (eventTarget && eventTarget.nodeType === Node.TEXT_NODE){
                eventTarget = eventTarget.parentElement;
              }

              var option = eventTarget && eventTarget.closest ? eventTarget.closest('[data-value]') : null;
              if (option && currentDropdown && overlayList && overlayList.contains(option)){
                e.preventDefault();
                e.stopPropagation();

                if (option.classList.contains('placeholder')){
                  var btn = currentDropdown.querySelector('.dd-button');
                  if (currentDropdown !== unidadDropdown){
                    setDropdownPlaceholder(currentDropdown);
                    if (currentDropdown === categoriaDropdown){
                      resetCamposDependientes();
                      updateGastoState('categoria', null);
                    }
                    if (currentDropdown === productoDropdown){
                      updateGastoState('producto', null);
                      updateGastoState('idProducto', null);
                      resetCamposDesdeProducto();
                    }
                    if (currentDropdown === proveedorDropdown){
                      updateGastoState('proveedor', null);
                      updateGastoState('unidad', null);
                      updateGastoState('precioUnitario', null);
                      updateGastoState('cantidad', null);
                      updateGastoState('gasto', null);
                      hideElement(sectionUnidad);
                      hideElement(sepBeforeCosto);
                      ocultarSeccionesCosto();
                      setDropdownPlaceholder(unidadDropdown);
                    }
                  }
                  closeOverlay();
                  if (btn){
                    setTimeout(()=>btn.focus({preventScroll:true}),0);
                  }
                  return;
                }

                var value = option.dataset.value || option.textContent;
                var selectedDropdown = currentDropdown;
                var btnSelected = selectedDropdown.querySelector('.dd-button');

                if (selectedDropdown === productoDropdown){
                  closeOverlay();
                }

                selectOption(selectedDropdown, value);
                if (btnSelected){
                  setTimeout(()=>btnSelected.focus({preventScroll:true}),0);
                }
                return;
              }

            };

            if (overlayList){
              overlayList.addEventListener('click', overlaySelectionHandler);
            }

            overlay.addEventListener('click', function(e){
              if (e.target === overlay) closeOverlay();
            });
          }

          document.addEventListener('keydown', function(e){
            if (e.key === 'Escape' && overlay && overlay.getAttribute('data-open') === 'true'){
              closeOverlay();
            }
          });
        }

        function cargarCategorias(){
          if (!categoriaDropdown) return;

          setDropdownLoading(categoriaDropdown, true);

          if (typeof google === 'undefined' || !google.script || !google.script.run){
            setCategoriasReadyState();
            setDropdownLoading(categoriaDropdown, false);
            setDropdownPlaceholder(categoriaDropdown);
            return;
          }

          google.script.run
            .withSuccessHandler(function(categorias){
              setDropdownLoading(categoriaDropdown, false);
              if (!Array.isArray(categorias)) categorias = [];
              var categoriaOpts = ['Nueva categoria'].concat(categorias);

              setCategoriasReadyState();
              setOptionsToDropdown(categoriaDropdown, categoriaOpts);

              if (!categorias.length){
                setDropdownPlaceholder(categoriaDropdown);
                showError('Aucune catégorie disponible – ajoutez un produit');
                resetCamposDependientes();
                return;
              }

              if (gastoState.categoria && categorias.indexOf(gastoState.categoria) !== -1){
                selectOption(categoriaDropdown, gastoState.categoria);
              } else if (gastoState.categoria){
                if (categoriaDropdown){
                  var categoriaLabel = categoriaDropdown.querySelector('.dd-label');
                  var categoriaBtn = categoriaDropdown.querySelector('.dd-button');
                  if (categoriaLabel){
                    categoriaLabel.textContent = gastoState.categoria;
                  }
                  if (categoriaBtn){
                    categoriaBtn.removeAttribute('data-placeholder');
                  }
                  categoriaDropdown.dataset.value = gastoState.categoria;
                }
                lockCategoria(gastoState.categoria);
                showProductoContainer();
                productoDropdown.dataset.ph = 'Producto';
                setDropdownPlaceholder(productoDropdown);
              } else {
                if (categoriaLockedContainer){
                  hideElement(categoriaLockedContainer);
                }
                if (categoriaDropdown){
                  showElement(categoriaDropdown);
                }
                setDropdownPlaceholder(categoriaDropdown);
              }
            })
            .withFailureHandler(function(err){
              setCategoriasReadyState();
              setDropdownLoading(categoriaDropdown, false);
              setDropdownPlaceholder(categoriaDropdown);
              var msg = (err && err.message) ? err.message : 'No se pudieron cargar las categorías.';
              showError(msg);
            })
            .getCategorias();
        }

        function cargarProductosPorCategoria(categoria){
          if (!productoDropdown) return;

          productoDropdown.dataset.ph = 'Producto';
          setOptionsToDropdown(productoDropdown, []);
          setDropdownLoading(productoDropdown, true);

          if (!categoria || typeof google === 'undefined' || !google.script || !google.script.run){
            setDropdownLoading(productoDropdown, false);
            setDropdownPlaceholder(productoDropdown);
            return;
          }

          google.script.run
            .withSuccessHandler(function(productos){
              setDropdownLoading(productoDropdown, false);
              if (!Array.isArray(productos)) productos = [];

              setOptionsToDropdown(productoDropdown, productos);

              if (gastoState.producto && productos.indexOf(gastoState.producto) !== -1){
                selectOption(productoDropdown, gastoState.producto);
              } else {
                setDropdownPlaceholder(productoDropdown);
              }
            })
            .withFailureHandler(function(err){
              setDropdownLoading(productoDropdown, false);
              setDropdownPlaceholder(productoDropdown);
              var msg = (err && err.message) ? err.message : 'No se pudieron cargar los productos.';
              showError(msg);
            })
            .getProductosPorCategoria(categoria);
        }

        if (qtyInput){
          if (typeof gastoState.cantidad === 'number' && isFinite(gastoState.cantidad)){
            qtyInput.value = gastoState.cantidad.toString().replace('.', ',');
          }
          qtyInput.addEventListener('input', updateMontoDesdeCantidad);
          qtyInput.addEventListener('keydown', handleQtyKeydown);
        }

        if (obsField){
          obsField.value = gastoState.observaciones || '';
          obsField.addEventListener('input', function(){
            updateGastoState('observaciones', obsField.value);
          });
          obsField.addEventListener('change', function(){
            updateGastoState('observaciones', obsField.value);
          });
        }

        if (btnRegistrarGasto){
          btnRegistrarGasto.addEventListener('click', function(){
            if (btnRegistrarGasto.disabled) return;

            clearError();

            var cantidadParsed = parseInputCantidad(qtyInput).number;
            if (!isFinite(cantidadParsed) || cantidadParsed <= 0){
              showError('Ingrese una cantidad válida.');
              return;
            }

            if (!isFinite(parseFloat(gastoState.precioUnitario))){
              showError('Registre primero el costo para continuar.');
              return;
            }

            var camposCompletos = (
              gastoState.fecha &&
              gastoState.categoria &&
              gastoState.producto &&
              gastoState.proveedor &&
              gastoState.unidad &&
              isFormularioValido()
            );

            if (!camposCompletos){
              showError('Complete los datos del gasto antes de registrar.');
              return;
            }

            if (typeof google === 'undefined' || !google.script || !google.script.run){
              showError('No se puede registrar el gasto en este momento.');
              return;
            }

            window.secoSetBlackButtonLoading(btnRegistrarGasto, true);

            var data = {
              fecha: gastoState.fecha,
              mes: getMesFromFecha(gastoState.fecha),
              categoria: gastoState.categoria,
              producto: gastoState.producto,
              cantidad: gastoState.cantidad,
              unidad: gastoState.unidad,
              precioUnitario: gastoState.precioUnitario,
              monto: gastoState.gasto,
              proveedor: gastoState.proveedor,
              observaciones: gastoState.observaciones || '',
              idProducto: gastoState.idProducto
            };

            google.script.run
              .withSuccessHandler(function(resp){
                var ok = (resp && (resp.success || resp.ok)) || resp === true;
                if (!ok){
                  window.secoSetBlackButtonLoading(btnRegistrarGasto, false);
                  showError('No se pudo registrar el gasto.');
                  return;
                }

                resetGastoState();
                loadPage('gastoRegistrado');
              })
              .withFailureHandler(function(err){
                window.secoSetBlackButtonLoading(btnRegistrarGasto, false);
                setRegistrarEnabled(isFormularioValido());
                var msg = (err && err.message) ? err.message : 'No se pudo registrar el gasto.';
                showError(msg);
              })
              .registrarGasto(data);
          });
        }

        if (btnRegistrarCostoCta){
          btnRegistrarCostoCta.addEventListener('click', function(){
            updateGastoState('origen', 'GASTO');
            loadPage('registrarCosto');
          });
        }

        if (!gastoState.categoria){
          setDropdownPlaceholder(categoriaDropdown);
        }
        if (unidadDropdown){
          unidadDropdown.dataset.ph = 'Unidad';
          if (gastoState.unidad){
            var unidadLabel = unidadDropdown.querySelector('.dd-label');
            var unidadBtn = unidadDropdown.querySelector('.dd-button');
            if (unidadLabel){
              unidadLabel.textContent = gastoState.unidad;
            }
            if (unidadBtn){
              unidadBtn.removeAttribute('data-placeholder');
            }
            unidadDropdown.dataset.value = gastoState.unidad;
          } else {
            setDropdownPlaceholder(unidadDropdown);
          }
        }
        setInitialLoadingState();
        resetCamposDependientes();
        refreshExpenseCard();
        bindUnlockCategoria();
        initDropdowns();
        cargarCategorias();
        if (gastoState.categoria){
          showProductoContainer();
          cargarProductosPorCategoria(gastoState.categoria);
        }
        if (gastoState.producto){
          showProveedorContainer();
        }
        if (gastoState.proveedor){
          cargarUnidades();
          showUnidadContainer();
        }
        if (gastoState.idProducto && gastoState.proveedor && gastoState.unidad){
          cargarCostoSiListo();
        }
    })();
  },

  registrarCosto: function(){
    (function(){
        var fechaLabel = document.getElementById('costoFecha') || document.querySelector('[data-field="fecha"]');
        var categoriaLabel = document.getElementById('costoCategoria') || document.querySelector('[data-field="categoria"]');
        var productoLabel = document.getElementById('costoProducto') || document.querySelector('[data-field="producto"]');
        var proveedorLabel = document.getElementById('costoProveedor') || document.querySelector('[data-field="proveedor"]');
        var unidadLabel = document.getElementById('costoUnidad') || document.querySelector('[data-field="unidad"]');

        var precioInput = document.getElementById('precioUnidad')
          || document.getElementById('precioUnidadInput')
          || document.querySelector('input[name="precioUnidad"]')
          || document.querySelector('input[type="text"]');

        var errorContainer = document.getElementById('registrarCostoError') || document.querySelector('[data-role="error"]');

        var btnRegistrar = document.getElementById('btnRegistrarCosto') || document.getElementById('btnRegistrar');
        var btnVolverInicio = document.querySelector('button[data-role="volver-inicio"]') || document.getElementById('btnVolverInicio');

        function setLabelText(el, val){
          if (!el) return;
          el.textContent = (val === null || typeof val === 'undefined') ? '' : String(val);
        }

        function clearError(){
          if (errorContainer){
            errorContainer.textContent = '';
            errorContainer.style.display = 'none';
          }
        }

        function showError(msg){
          if (errorContainer){
            errorContainer.textContent = msg;
            errorContainer.style.display = '';
          } else {
            alert(msg);
          }
        }

        function setRegistrarLoading(isLoading){
          if (!btnRegistrar) return;
          if (btnRegistrar.classList && btnRegistrar.classList.contains('btn-noir')){
            window.secoSetBlackButtonLoading(btnRegistrar, isLoading);
            return;
          }
          if (isLoading){
            if (btnRegistrar.dataset.spinner === '1') return;
            btnRegistrar.disabled = true;
            btnRegistrar.dataset.spinner = '1';
          } else {
            btnRegistrar.disabled = false;
            btnRegistrar.removeAttribute('data-spinner');
          }
        }

        function setVolverInicioLoading(isLoading){
          if (!btnVolverInicio) return;
          if (isLoading){
            if (btnVolverInicio.dataset.spinner === '1') return;
            btnVolverInicio.disabled = true;
            btnVolverInicio.dataset.spinner = '1';
          } else {
            btnVolverInicio.disabled = false;
            btnVolverInicio.removeAttribute('data-spinner');
          }
        }

        function sanitizePrecio(){
          if (!precioInput) return '';
          return normalizeNumericInput(precioInput);
        }

        function handlePrecioKeydown(e){
          var allowed = ['Backspace','Tab','Enter','ArrowLeft','ArrowRight','Delete',',','.'];
          if (allowed.indexOf(e.key) !== -1) return;
          if (/^\d$/.test(e.key)) return;
          e.preventDefault();
        }

        function isCostoFormularioValido(){
          var parsedPrecio = parseInputPrecio(precioInput);
          return !!(
            gastoState.idProducto &&
            gastoState.categoria &&
            gastoState.producto &&
            gastoState.proveedor &&
            gastoState.unidad &&
            parsedPrecio.number !== null &&
            parsedPrecio.number > 0
          );
        }

        function setRegistrarEnabled(enabled){
          if (!btnRegistrar || btnRegistrar.dataset.spinner === '1') return;
          btnRegistrar.disabled = !enabled;
        }

        setLabelText(fechaLabel, gastoState.fecha);
        setLabelText(categoriaLabel, gastoState.categoria);
        setLabelText(productoLabel, gastoState.producto);
        setLabelText(proveedorLabel, gastoState.proveedor);
        setLabelText(unidadLabel, gastoState.unidad);

        if (precioInput){
          precioInput.value = '';
          precioInput.removeAttribute('data-spinner');
          precioInput.addEventListener('input', function(){
            sanitizePrecio();
            clearError();
            setRegistrarEnabled(isCostoFormularioValido());
          });
          precioInput.addEventListener('keydown', handlePrecioKeydown);
        }

        clearError();
        setRegistrarLoading(false);
        setVolverInicioLoading(false);
        setRegistrarEnabled(isCostoFormularioValido());

        if (btnVolverInicio){
          if (typeof registerVolverInicioHook === 'function'){
            registerVolverInicioHook(btnVolverInicio, function(){
              resetGastoState();
            });
          } else {
            btnVolverInicio.addEventListener('click', function(){
              if (btnVolverInicio.disabled) return;
              resetGastoState();
              loadPage('inicio');
            });
          }
        }

        if (btnRegistrar){
          btnRegistrar.addEventListener('click', function(){
            if (btnRegistrar.disabled) return;

            clearError();
            var parsedPrecio = parseInputPrecio(precioInput);
            if (!parsedPrecio.sanitized){
              showError('Ingrese el precio por unidad.');
              if (precioInput) precioInput.focus();
              setRegistrarEnabled(false);
              return;
            }

            if (parsedPrecio.number === null || parsedPrecio.number <= 0){
              showError('Precio inválido.');
              if (precioInput) precioInput.focus();
              setRegistrarEnabled(false);
              return;
            }

            if (!isCostoFormularioValido()){
              showError('Faltan datos para registrar el costo.');
              setRegistrarEnabled(false);
              return;
            }

            setRegistrarEnabled(false);
            setRegistrarLoading(true);
            setVolverInicioLoading(true);

            if (typeof google !== 'undefined' && google.script && google.script.run){
              google.script.run
                .withSuccessHandler(function(resp){
                  var ok = resp && (resp.success || resp.ok || resp === true);
                  if (!ok){
                    setRegistrarLoading(false);
                    setVolverInicioLoading(false);
                    setRegistrarEnabled(isCostoFormularioValido());
                    var msg = (resp && resp.error) ? resp.error : 'No se pudo registrar el costo.';
                    showError(msg);
                    return;
                  }

                  updateGastoState('precioUnitario', parsedPrecio.number);
                  loadPage('registrarGasto');
                })
                .withFailureHandler(function(err){
                  setRegistrarLoading(false);
                  setVolverInicioLoading(false);
                  setRegistrarEnabled(isCostoFormularioValido());
                  var msg = (err && err.message) ? err.message : 'Error al registrar el costo.';
                  showError(msg);
                })
                .registrarCosto(
                  gastoState.idProducto,
                  gastoState.categoria,
                  gastoState.producto,
                  gastoState.proveedor,
                  gastoState.unidad,
                  parsedPrecio.number
                );
            } else {
              setRegistrarLoading(false);
              setVolverInicioLoading(false);
              setRegistrarEnabled(isCostoFormularioValido());
              showError('No se pudo registrar el costo.');
            }
          });
        }
    })();
  },

  nuevoProveedor: function(){
    var nombreInput = document.getElementById('nombreProveedor')
      || document.getElementById('proveedorNombre')
      || document.querySelector('input[name="proveedorNombre"]')
      || document.querySelector('input[type="text"]');
    var errorContainer = document.getElementById('nuevoProveedorError')
      || document.querySelector('[data-role="error"]');
    var btnRegistrar = document.getElementById('btnRegistrarProveedor') || document.getElementById('btnRegistrar');
    var btnVolverInicio = document.querySelector('button[data-role="volver-inicio"]') || document.getElementById('btnVolverInicio');

    function clearError(){
      if (errorContainer){
        errorContainer.textContent = '';
        errorContainer.style.display = 'none';
      }
    }

    function showError(msg){
      if (errorContainer){
        errorContainer.textContent = msg;
        errorContainer.style.display = '';
      } else {
        alert(msg);
      }
    }

    function setRegistrarLoading(isLoading){
      if (!btnRegistrar) return;
      if (btnRegistrar.classList && btnRegistrar.classList.contains('btn-noir')){
        window.secoSetBlackButtonLoading(btnRegistrar, isLoading);
        return;
      }
      if (isLoading){
        if (btnRegistrar.dataset.spinner === '1') return;
        btnRegistrar.disabled = true;
        btnRegistrar.dataset.spinner = '1';
      } else {
        btnRegistrar.disabled = false;
        btnRegistrar.removeAttribute('data-spinner');
      }
    }

    function setVolverInicioEnabled(enable){
      if (btnVolverInicio){
        btnVolverInicio.disabled = !enable;
      }
    }

    function setRegistrarEnabled(enable){
      if (!btnRegistrar || btnRegistrar.dataset.spinner === '1') return;
      btnRegistrar.disabled = !enable;
    }

    if (nombreInput){
      nombreInput.value = '';
      nombreInput.addEventListener('input', function(){
        clearError();
        setRegistrarEnabled(!!nombreInput.value.trim());
      });
    }
    clearError();
    setRegistrarEnabled(false);

    if (btnVolverInicio){
      if (typeof registerVolverInicioHook === 'function'){
        registerVolverInicioHook(btnVolverInicio, function(){
          resetGastoState();
        });
      } else {
        btnVolverInicio.addEventListener('click', function(){
          if (btnVolverInicio.disabled) return;
          resetGastoState();
          loadPage('inicio');
        });
      }
    }

    if (btnRegistrar){
      btnRegistrar.addEventListener('click', function(){
        if (btnRegistrar.disabled) return;

        var nombre = (nombreInput ? nombreInput.value : '').toString().trim();
        if (!nombre){
          showError('Ingrese el nombre del proveedor.');
          if (nombreInput) nombreInput.focus();
          return;
        }

        clearError();
        setRegistrarEnabled(false);
        setRegistrarLoading(true);
        setVolverInicioEnabled(false);

        var nomNormalizado = nombre;

        if (typeof google !== 'undefined' && google.script && google.script.run){
          google.script.run
            .withSuccessHandler(function(resp){
              var ok = (resp && (resp.ok || resp.success)) || resp === undefined || resp === null || resp === true;
              if (!ok){
                setRegistrarLoading(false);
                setVolverInicioEnabled(true);
                setRegistrarEnabled(true);
                var msg = (resp && resp.error) ? resp.error : 'Error al crear el proveedor.';
                showError(msg);
                return;
              }

              updateGastoState('proveedor', nomNormalizado);
              updateGastoState('origen', null);
              loadPage('registrarGasto');
            })
            .withFailureHandler(function(err){
              setRegistrarLoading(false);
              setVolverInicioEnabled(true);
              setRegistrarEnabled(true);
              var msg = (err && err.message) ? err.message : 'Error al crear el proveedor.';
              showError(msg);
            })
            .crearProveedor(nomNormalizado);
        } else {
          setRegistrarLoading(false);
          setVolverInicioEnabled(true);
          setRegistrarEnabled(true);
          showError('No se pudo crear el proveedor.');
        }
      });
    }
  },

  nuevaCategoria: function(){
    var categoriaInput = document.getElementById('nombreCategoria')
      || document.getElementById('categoriaNombre')
      || document.querySelector('input[name="categoriaNombre"]')
      || document.querySelector('input[type="text"]');
    var errorContainer = document.getElementById('nuevaCategoriaError')
      || document.querySelector('[data-role="error"]');
    var btnGuardar = document.getElementById('btnGuardarCategoria') || document.getElementById('btnRegistrar');
    var btnCancelar = document.getElementById('btnVolverCategoria') || document.getElementById('btnVolver');

    function clearError(){
      if (errorContainer){
        errorContainer.textContent = '';
        errorContainer.style.display = 'none';
      }
    }

    function showError(msg){
      if (errorContainer){
        errorContainer.textContent = msg;
        errorContainer.style.display = '';
      } else {
        alert(msg);
      }
    }

    function setGuardarLoading(isLoading){
      if (!btnGuardar) return;
      if (btnGuardar.classList && btnGuardar.classList.contains('btn-noir')){
        window.secoSetBlackButtonLoading(btnGuardar, isLoading);
        return;
      }
      if (isLoading){
        if (btnGuardar.dataset.spinner === '1') return;
        btnGuardar.disabled = true;
        btnGuardar.dataset.spinner = '1';
      } else {
        btnGuardar.disabled = false;
        btnGuardar.removeAttribute('data-spinner');
      }
    }

    function setCancelarEnabled(enable){
      if (btnCancelar){
        btnCancelar.disabled = !enable;
      }
    }

    function setGuardarEnabled(enable){
      if (!btnGuardar || btnGuardar.dataset.spinner === '1') return;
      btnGuardar.disabled = !enable;
    }

    if (categoriaInput){
      categoriaInput.value = '';
      categoriaInput.addEventListener('input', function(){
        clearError();
        setGuardarEnabled(!!categoriaInput.value.trim());
      });
    }
    clearError();
    setGuardarLoading(false);
    setGuardarEnabled(false);

    if (btnCancelar){
      btnCancelar.addEventListener('click', function(){
        if (btnCancelar.disabled) return;
        loadPage('registrarGasto');
      });
    }

    if (btnGuardar){
      btnGuardar.addEventListener('click', function(){
        if (btnGuardar.disabled) return;

        var nombre = (categoriaInput ? categoriaInput.value : '').toString().trim();
        if (!nombre){
          showError('Ingrese el nombre de la categoria.');
          if (categoriaInput) categoriaInput.focus();
          return;
        }

        clearError();
        setGuardarEnabled(false);
        setGuardarLoading(true);
        setCancelarEnabled(false);

        var nombreNormalizado = nombre;

        if (typeof google !== 'undefined' && google.script && google.script.run){
          google.script.run
            .withSuccessHandler(function(resp){
              var ok = (resp && (resp.ok || resp.success)) || resp === undefined || resp === null || resp === true;
              if (!ok){
                setGuardarLoading(false);
                setCancelarEnabled(true);
                setGuardarEnabled(true);
                var msg = (resp && resp.error) ? resp.error : 'Error al crear la categoria.';
                showError(msg);
                return;
              }

              updateGastoState('categoria', nombreNormalizado);
              updateGastoState('producto', null);
              updateGastoState('proveedor', null);
              updateGastoState('unidad', null);
              updateGastoState('precioUnitario', null);
              updateGastoState('idProducto', null);
              updateGastoState('origen', null);

              loadPage('registrarGasto');
            })
            .withFailureHandler(function(err){
              setGuardarLoading(false);
              setCancelarEnabled(true);
              setGuardarEnabled(true);
              var msg = (err && err.message) ? err.message : 'Error al crear la categoria.';
              showError(msg);
            })
            .crearCategoria(nombreNormalizado);
        } else {
          setGuardarLoading(false);
          setCancelarEnabled(true);
          setGuardarEnabled(true);
          showError('No se pudo crear la categoria.');
        }
      });
    }
  },

  nuevaUnidad: function(){
    var unidadInput = document.getElementById('nombreUnidad')
      || document.getElementById('unidadNombre')
      || document.querySelector('input[name="unidadNombre"]')
      || document.querySelector('input[type="text"]');
    var errorContainer = document.getElementById('nuevaUnidadError')
      || document.querySelector('[data-role="error"]');
    var btnRegistrar = document.getElementById('btnRegistrarUnidad') || document.getElementById('btnRegistrar');
    var btnVolverInicio = document.querySelector('button[data-role="volver-inicio"]') || document.getElementById('btnVolverInicio');

    function clearError(){
      if (errorContainer){
        errorContainer.textContent = '';
        errorContainer.style.display = 'none';
      }
    }

    function showError(msg){
      if (errorContainer){
        errorContainer.textContent = msg;
        errorContainer.style.display = '';
      } else {
        alert(msg);
      }
    }

    function setRegistrarLoading(isLoading){
      if (!btnRegistrar) return;
      if (btnRegistrar.classList && btnRegistrar.classList.contains('btn-noir')){
        window.secoSetBlackButtonLoading(btnRegistrar, isLoading);
        return;
      }
      if (isLoading){
        if (btnRegistrar.dataset.spinner === '1') return;
        btnRegistrar.disabled = true;
        btnRegistrar.dataset.spinner = '1';
      } else {
        btnRegistrar.disabled = false;
        btnRegistrar.removeAttribute('data-spinner');
      }
    }

    function setVolverInicioEnabled(enable){
      if (btnVolverInicio){
        btnVolverInicio.disabled = !enable;
      }
    }

    function setRegistrarEnabled(enable){
      if (!btnRegistrar || btnRegistrar.dataset.spinner === '1') return;
      btnRegistrar.disabled = !enable;
    }

    if (unidadInput){
      unidadInput.value = '';
      unidadInput.addEventListener('input', function(){
        clearError();
        setRegistrarEnabled(!!unidadInput.value.trim());
      });
    }
    clearError();
    setRegistrarLoading(false);
    setRegistrarEnabled(false);
    
    if (btnVolverInicio){
      if (typeof registerVolverInicioHook === 'function'){
        registerVolverInicioHook(btnVolverInicio, function(){
          resetGastoState();
        });
      } else {
        btnVolverInicio.addEventListener('click', function(){
          if (btnVolverInicio.disabled) return;
          resetGastoState();
          loadPage('inicio');
        });
      }
    }

    if (btnRegistrar){
      btnRegistrar.addEventListener('click', function(){
        if (btnRegistrar.disabled) return;

        var nombre = (unidadInput ? unidadInput.value : '').toString().trim();
        if (!nombre){
          showError('Ingrese la unidad.');
          if (unidadInput) unidadInput.focus();
          return;
        }

        var nombreNormalizado = nombre.toLowerCase();

        clearError();
        setRegistrarEnabled(false);
        setRegistrarLoading(true);
        setVolverInicioEnabled(false);

        if (typeof google !== 'undefined' && google.script && google.script.run){
          google.script.run
            .withSuccessHandler(function(resp){
              var ok = (resp && (resp.ok || resp.success)) || resp === undefined || resp === null || resp === true;
              if (!ok){
                setRegistrarLoading(false);
                setVolverInicioEnabled(true);
                setRegistrarEnabled(true);
                var msg = (resp && resp.error) ? resp.error : 'Error al crear la unidad.';
                showError(msg);
                return;
              }

              updateGastoState('unidad', nombreNormalizado);
              updateGastoState('origen', null);
              loadPage('registrarGasto');
            })
            .withFailureHandler(function(err){
              setRegistrarLoading(false);
              setVolverInicioEnabled(true);
              setRegistrarEnabled(true);
              var msg = (err && err.message) ? err.message : 'Error al crear la unidad.';
              showError(msg);
            })
            .crearUnidad(nombreNormalizado);
        } else {
          setRegistrarLoading(false);
          setVolverInicioEnabled(true);
          setRegistrarEnabled(true);
          showError('No se pudo crear la unidad.');
        }
      });
    }
  },

  pedidosDelDia: function(){
    var tabs = document.querySelectorAll('.tab');
    var tabTodo = tabs && tabs.length ? tabs[0] : null;
    var tabPendiente = tabs && tabs.length > 1 ? tabs[1] : null;
    var cardsContainer = document.getElementById('cardsContainer');
    var finalSeparator = document.getElementById('finalSeparator');
    var pedidosCache = [];
    var activeTab = 'todo';

    var ICONS = {
      trash:   "https://lh3.googleusercontent.com/d/1NEwXtWZqpIJlto9dPs49xKhq3oOqwpXH",
      checkBlk:"https://lh3.googleusercontent.com/d/1CiREwW0rHzmdha8SqKtDEqr9iPNW21eG",
      checkW:  "https://lh3.googleusercontent.com/d/1kIWQWxgpGWgRbdiBcm_X1BpwFZkUwX5l",
      edit:    "https://lh3.googleusercontent.com/d/1IJOPYYBICvweVK9rn2mQqckhfyQOHvrJ",
      refresh: "https://www.gstatic.com/images/icons/material/system/24/autorenew_black_24dp.png"
    };

    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var w = Math.floor(wrapper.clientWidth);
      if (w > 0){
        img.style.width = w + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    function formatMoney(n){
      var num = Number(n);
      if (!isFinite(num)) num = 0;
      return num.toFixed(2).replace('.', ',') + ' $';
    }

    function formatCantidad(n){
      var c = Number(n);
      if (!isFinite(c) || c < 0) c = 0;
      var base = c + ' seco';
      return base + (c === 1 ? '' : 's');
    }

    function formatHora(raw){
      if (raw instanceof Date && !isNaN(raw.getTime())){
        var h = raw.getHours();
        var m = String(raw.getMinutes()).padStart(2, '0');
        return h + ':' + m;
      }
      var str = (raw === null || raw === undefined) ? '' : String(raw).trim();
      if (!str) return '';
      var match = str.match(/(\d{1,2})\s*[:hH]\s*(\d{2})/);
      if (match){
        var hh = parseInt(match[1], 10);
        var mm = match[2];
        if (!isNaN(hh)) return hh + ':' + mm;
      }
      var numVal = Number(str);
      if (isFinite(numVal)){
        var baseDate = new Date(1899, 11, 30);
        var millis = Math.round(numVal * 24 * 60 * 60 * 1000);
        var fromSerial = new Date(baseDate.getTime() + millis);
        if (!isNaN(fromSerial.getTime())){
          return fromSerial.getHours() + ':' + String(fromSerial.getMinutes()).padStart(2, '0');
        }
      }
      var parsed = new Date(str);
      if (!isNaN(parsed.getTime())){
        return parsed.getHours() + ':' + String(parsed.getMinutes()).padStart(2, '0');
      }
      return str;
    }

    function setTabs(tabName){
      activeTab = tabName;
      if (tabTodo){
        tabTodo.setAttribute('aria-selected', tabName === 'todo' ? 'true' : 'false');
      }
      if (tabPendiente){
        tabPendiente.setAttribute('aria-selected', tabName === 'pendiente' ? 'true' : 'false');
      }
      renderCards();
    }

    function setContainerMessage(msg){
      if (!cardsContainer) return;
      var div = document.createElement('div');
      div.className = 'txt-body';
      div.textContent = msg;
      cardsContainer.innerHTML = '';
      cardsContainer.appendChild(div);
      if (finalSeparator){
        finalSeparator.style.display = 'none';
      }
    }

    function stateFromPedido(pedido){
      var estado = (pedido && pedido.estado ? pedido.estado : '').toString().toLowerCase();
      return {
        isDeleted: estado === 'eliminado' || estado === 'cancelado',
        isDelivered: estado === 'entregado'
      };
    }

    function setActionLoading(btn, isLoading){
      if (!btn) return;
      if (isLoading){
        btn.disabled = true;
        btn.dataset.loading = '1';
        if (btn.classList.contains('btn-deliver') || btn.classList.contains('btn-cancel')){
          btn.dataset.spinner = '1';
        }
      } else {
        btn.disabled = false;
        btn.removeAttribute('data-loading');
        if (btn.classList.contains('btn-deliver') || btn.classList.contains('btn-cancel')){
          btn.removeAttribute('data-spinner');
        }
      }
    }

    const PEDIDO_TRANSITION_VISIBLE_MS = 200;
    const PEDIDO_TRANSITION_FADE_MS = PEDIDO_TRANSITION_VISIBLE_MS / 2;

    document.documentElement.style.setProperty('--pedido-transition-fade-ms', PEDIDO_TRANSITION_FADE_MS + 'ms');

    function showPedidoTransition(card, opts){
      if (!card) return function(){};
      var inner = card.querySelector('.pedido-inner');
      if (!inner) return function(){};

      var overlay = inner.querySelector('.pedido-transition');
      if (!overlay){
        overlay = document.createElement('div');
        overlay.className = 'pedido-transition pedido-transition-overlay';
        var imgEl = document.createElement('img');
        var txtEl = document.createElement('div');
        txtEl.className = 'txt-body';
        overlay.appendChild(imgEl);
        overlay.appendChild(txtEl);
        inner.appendChild(overlay);
      } else {
        overlay.classList.add('pedido-transition-overlay');
      }

      var img = overlay.querySelector('img');
      var txt = overlay.querySelector('.txt-body');
      if (img){
        if (opts && opts.icon) img.src = opts.icon;
        img.alt = opts && opts.alt ? opts.alt : (opts && opts.text ? opts.text : '');
      }
      if (txt && opts && typeof opts.text === 'string'){
        txt.textContent = opts.text;
      }

      var activeClass = opts && opts.activeClass ? opts.activeClass : 'is-transitioning';
      var delay = opts && typeof opts.delay === 'number' ? opts.delay : PEDIDO_TRANSITION_VISIBLE_MS;
      card.classList.add(activeClass);

      return function hideTransition(onHidden){
        var fadeStart = delay - PEDIDO_TRANSITION_FADE_MS;
        if (fadeStart < 0) fadeStart = 0;

        setTimeout(function(){
          overlay.classList.add('is-fading-out');
        }, fadeStart);

        setTimeout(function(){
          overlay.classList.remove('is-fading-out');
          card.classList.remove(activeClass);
          if (typeof onHidden === 'function') onHidden();
        }, delay);
      };
    }

    function actualizarPedidoEnCache(pedido){
      if (!pedido) return;
      var id = (pedido.idPedido || '').toString();
      var idx = pedidosCache.findIndex(function(p){ return (p.idPedido || '').toString() === id; });
      if (idx >= 0){
        pedidosCache[idx] = pedido;
      } else {
        pedidosCache.push(pedido);
      }
    }

    function runServerAction(card, btn, methodName, payload, onFinally){
      if (typeof google === 'undefined' || !google.script || !google.script.run) return;
      setActionLoading(btn, true);

      var transitionHide = null;
      if (card && methodName === 'reactivarPedido'){
        transitionHide = showPedidoTransition(card, {
          icon: ICONS.checkBlk,
          text: 'Reactivado',
          alt: 'Reactivado',
          activeClass: 'is-reactivating'
        });
      } else if (card && methodName === 'eliminarPedido'){
        transitionHide = showPedidoTransition(card, {
          icon: ICONS.trash,
          text: 'Cancelado',
          alt: 'Cancelado',
          activeClass: 'is-canceling'
        });
      }

      function finalize(afterHide){
        setActionLoading(btn, false);
        if (typeof transitionHide === 'function') transitionHide(afterHide);
        else if (typeof afterHide === 'function') afterHide();
        if (typeof onFinally === 'function') onFinally();
      }

      google.script.run
        .withSuccessHandler(function(resp){
          var afterHide = null;
          if (resp && resp.ok && resp.data && resp.data.pedido){
            actualizarPedidoEnCache(resp.data.pedido);
            afterHide = renderCards;
          } else if (resp && resp.error){
            alert(resp.error);
          }
          finalize(afterHide);
        })
        .withFailureHandler(function(err){
          if (err && err.message){
            alert(err.message);
          }
          finalize();
        })[methodName](payload);
    }

    function irAEditarPedido(pedido){
      if (!pedido) return;
      window.SECO_CTX = {
        origen: 'pedidosDelDia',
        pedidoId: pedido.idPedido || '',
        pedido: pedido,
        pedidoEnEdicion: pedido,
        cliente: pedido.cliente || null,
        idContacto: pedido.cliente && pedido.cliente.idCliente ? pedido.cliente.idCliente : ''
      };
      loadPage('editarPedido');
    }

    function crearStatusIcon(clase, src, alt){
      var cont = document.createElement('div');
      cont.className = 'pedido-status-icon ' + clase;
      var img = document.createElement('img');
      img.src = src;
      img.alt = alt;
      cont.appendChild(img);
      return cont;
    }

    function buildCard(pedido){
      var card = document.createElement('article');
      card.className = 'pedido-card';

      var estadoLower = (pedido && pedido.estado ? pedido.estado : '').toString().toLowerCase();
      var estadoInfo = stateFromPedido(pedido);
      if (estadoInfo.isDeleted) card.classList.add('is-deleted');
      if (estadoInfo.isDelivered) card.classList.add('is-delivered');
      if (estadoLower === 'cancelado') card.classList.add('is-cancelado');

      var inner = document.createElement('div');
      inner.className = 'pedido-inner';
      card.appendChild(inner);

      var main = document.createElement('div');
      main.className = 'pedido-main';
      main.style.position = 'relative';
      inner.appendChild(main);

      var row1 = document.createElement('div');
      row1.className = 'pedido-row1';
      var toplineWrap = document.createElement('div');
      toplineWrap.className = 'pedido-left';
      var topline = document.createElement('div');
      topline.className = 'pedido-topline';
      var hora = formatHora(pedido.horaEntrega || '');
      var sector = pedido.cliente && pedido.cliente.sector ? pedido.cliente.sector : '';
      var parts = [];
      if (hora) parts.push(hora);
      if (sector) parts.push(sector);
      topline.textContent = parts.join(' · ');
      toplineWrap.appendChild(topline);
      row1.appendChild(toplineWrap);

      var toggle = document.createElement('button');
      toggle.className = 'pedido-toggle';
      toggle.type = 'button';
      toggle.setAttribute('aria-expanded', 'false');
      var chev = document.createElement('span');
      chev.className = 'chevron';
      toggle.appendChild(chev);
      row1.appendChild(toggle);

      main.appendChild(row1);

      if (estadoInfo.isDeleted){
        main.appendChild(crearStatusIcon('pedido-status--deleted', ICONS.trash, 'Eliminado'));
      }
      if (estadoInfo.isDelivered){
        main.appendChild(crearStatusIcon('pedido-status--delivered', ICONS.checkBlk, 'Entregado'));
      }

      var row2 = document.createElement('div');
      row2.className = 'pedido-row2';
      var left2 = document.createElement('div');
      left2.className = 'pedido-left';
      var nom = document.createElement('div');
      nom.className = 'pedido-nom';
      nom.textContent = pedido.cliente && pedido.cliente.nombre ? pedido.cliente.nombre.toUpperCase() : '—';
      left2.appendChild(nom);

      var direccion = pedido.cliente && pedido.cliente.direccion ? pedido.cliente.direccion : '';
      if (direccion){
        var dirEl = document.createElement('div');
        dirEl.className = 'pedido-ligne';
        dirEl.textContent = direccion;
        left2.appendChild(dirEl);
      }

      var notas = (pedido.notas || '').toString().trim();
      if (notas){
        var notaEl = document.createElement('div');
        notaEl.className = 'pedido-note';
        notaEl.textContent = 'Nota : ' + notas;
        left2.appendChild(notaEl);
      }

      row2.appendChild(left2);
      main.appendChild(row2);

      var row3 = document.createElement('div');
      row3.className = 'pedido-row3';
      var left3 = document.createElement('div');
      left3.className = 'pedido-left';
      var total = document.createElement('div');
      total.className = 'pedido-total';
      var cantidadTxt = formatCantidad(pedido.cantidad);
      var totalTxt = (pedido.total || pedido.total === 0) ? formatMoney(pedido.total) : '';
      total.innerHTML = '<b>' + cantidadTxt + '</b>' + (totalTxt ? ' / ' + totalTxt : '');
      left3.appendChild(total);
      row3.appendChild(left3);

      var statusCell = document.createElement('div');
      statusCell.className = 'pedido-statuscell';
      var estadoLabel = document.createElement('div');
      estadoLabel.className = 'pedido-note';
      var estadoTxt = (pedido.estado || 'Pendiente').toString();
      estadoLabel.textContent = estadoTxt;
      statusCell.appendChild(estadoLabel);

      var refresh = document.createElement('div');
      refresh.className = 'pedido-refresh';
      var rImg = document.createElement('img');
      rImg.src = ICONS.refresh;
      rImg.alt = 'Reactivar';
      refresh.appendChild(rImg);
      refresh.addEventListener('click', function(e){
        e.stopPropagation();
        if (!pedido.idPedido) return;
        runServerAction(card, refresh, 'reactivarPedido', { idPedido: pedido.idPedido });
      });
      statusCell.appendChild(refresh);

      row3.appendChild(statusCell);
      main.appendChild(row3);

      var actions = document.createElement('div');
      actions.className = 'pedido-actions';

      var btnEdit = document.createElement('button');
      btnEdit.type = 'button';
      var imgEdit = document.createElement('img');
      imgEdit.src = ICONS.edit;
      imgEdit.alt = 'Editar';
      btnEdit.appendChild(imgEdit);
      btnEdit.addEventListener('click', function(e){
        e.stopPropagation();
        irAEditarPedido(pedido);
      });
      actions.appendChild(btnEdit);

      var btnDeliver = document.createElement('button');
      btnDeliver.type = 'button';
      btnDeliver.className = 'btn-deliver';
      var imgDeliver = document.createElement('img');
      imgDeliver.src = ICONS.checkW;
      imgDeliver.alt = 'Entregar';
      btnDeliver.appendChild(imgDeliver);
      btnDeliver.addEventListener('click', function(e){
        e.stopPropagation();
        if (!pedido.idPedido) return;
        runServerAction(card, btnDeliver, 'marcarPedidoEntregado', { idPedido: pedido.idPedido });
      });
      actions.appendChild(btnDeliver);

      var btnCancel = document.createElement('button');
      btnCancel.type = 'button';
      btnCancel.className = 'btn-cancel';
      var imgCancel = document.createElement('img');
      imgCancel.src = ICONS.trash;
      imgCancel.alt = 'Eliminar';
      btnCancel.appendChild(imgCancel);
      btnCancel.addEventListener('click', function(e){
        e.stopPropagation();
        if (!pedido.idPedido) return;
        runServerAction(card, btnCancel, 'eliminarPedido', { idPedido: pedido.idPedido });
      });
      actions.appendChild(btnCancel);

      inner.appendChild(actions);

      var reactivated = document.createElement('div');
      reactivated.className = 'pedido-transition';
      var reactImg = document.createElement('img');
      reactImg.src = ICONS.checkBlk;
      reactImg.alt = 'Reactivado';
      var reactTxt = document.createElement('div');
      reactTxt.className = 'txt-body';
      reactTxt.textContent = 'Reactivado';
      reactivated.appendChild(reactImg);
      reactivated.appendChild(reactTxt);
      inner.appendChild(reactivated);

      function toggleOpen(){
        if (estadoInfo.isDeleted || estadoInfo.isDelivered) return;
        var isOpen = card.classList.contains('is-open');
        card.classList.toggle('is-open', !isOpen);
        toggle.setAttribute('aria-expanded', (!isOpen).toString());
      }

      toggle.addEventListener('click', function(e){
        e.stopPropagation();
        toggleOpen();
      });

      card.addEventListener('click', function(){
        if (estadoInfo.isDeleted || estadoInfo.isDelivered){
          runServerAction(card, refresh, 'reactivarPedido', { idPedido: pedido.idPedido });
        }
      });

      return card;
    }

    function renderCards(){
      if (!cardsContainer) return;
      cardsContainer.innerHTML = '';
      var lista = activeTab === 'pendiente'
        ? pedidosCache.filter(function(p){
            return (p.estado || '').toString().toLowerCase() === 'pendiente';
          })
        : pedidosCache.slice();

      if (!lista.length){
        setContainerMessage('Sin pedidos');
        return;
      }

      if (finalSeparator){
        finalSeparator.style.display = '';
      }

      lista.forEach(function(p, idx){
        cardsContainer.appendChild(buildCard(p));
        if (idx < lista.length - 1){
          var sep = document.createElement('div');
          sep.className = 'pedido-separator';
          sep.setAttribute('aria-hidden', 'true');
          cardsContainer.appendChild(sep);
        }
      });
    }

    function fetchPedidos(){
      setContainerMessage('Cargando pedidos...');
      google.script.run
        .withSuccessHandler(function(resp){
          if (resp && resp.ok && resp.data && Array.isArray(resp.data.pedidos)){
            pedidosCache = resp.data.pedidos;
          } else {
            pedidosCache = [];
          }
          renderCards();
        })
        .withFailureHandler(function(){
          pedidosCache = [];
          setContainerMessage('No se pudieron cargar los pedidos.');
        })
        .getPedidosDelDia();
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      if (tabTodo){
        tabTodo.addEventListener('click', function(){ setTabs('todo'); });
      }
      if (tabPendiente){
        tabPendiente.addEventListener('click', function(){ setTabs('pendiente'); });
      }
      fetchPedidos();
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  nuevoPedido: function(){
    function applyScaleFix(){
          var cssW = window.innerWidth || document.documentElement.clientWidth;
          var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
          if (cssW >= 960 && cssW <= 1024) {
            var fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
        }
    
        function sizeHeaderImage(){
          var img = document.getElementById('headerImg');
          var wrap = document.querySelector('.wrapper');
          if (!img || !wrap) return;
          var w = Math.floor(wrap.clientWidth);
          if (w > 0){
            img.style.width = w + 'px';
            img.style.maxWidth = '100%';
            img.removeAttribute('height');
          }
        }
    
        var overlay     = document.getElementById('ddOverlay');
        var overlayList = document.getElementById('ddOverlayList');
        var contactBtn  = document.getElementById('contactBtn');
        var btnOK       = document.getElementById('btnOK');
        var btnVolver   = document.getElementById('btnVolverInicio');

        var contactosOpciones = [];
        var contactoSeleccionado = null;
        var ctxCache = null;

        function setPedidoIdHeaderDesdeValor(idPedido){
          var cont = document.getElementById('pedidoIdHeader');
          if (!cont) return;

          var txt = cont.querySelector('#pedidoIdTexto');
          var loader = cont.querySelector('.pedido-id-loader');
          var contactoDrop = document.getElementById('contactBtn');

          var valor = (idPedido || '').toString().trim();
          var tieneValor = !!valor;

          if (txt){
            txt.textContent = valor;
            txt.style.display = tieneValor ? '' : 'none';
          }

          if (loader){
            loader.style.display = tieneValor ? 'none' : '';
          }

          if (contactoDrop){
            contactoDrop.style.visibility = tieneValor ? 'visible' : 'hidden';
            contactoDrop.style.pointerEvents = tieneValor ? 'auto' : 'none';
          }
        }
    
        function setButtonLoading(btn, isLoading){
          if (!btn) return;
          if (isLoading){
            if (!btn.dataset.originalColor){
              var computed = window.getComputedStyle ? getComputedStyle(btn).color : btn.style.color;
              btn.dataset.originalColor = computed || '';
            }
            btn.disabled = true;
            btn.style.color = 'rgba(255,255,255,0.5)';
          } else {
            btn.disabled = false;
            btn.style.color = btn.dataset.originalColor || '';
          }
        }

        function setButtonSpinner(btn, isLoading, color){
          if (!btn) return;
          if (btn.classList.contains('btn-noir')){
            if (isLoading){
              window.secoSetBlackButtonLoading(btn, true);
            } else {
              window.secoSetBlackButtonLoading(btn, false);
            }
            return;
          }
          if (isLoading){
            if (!btn.dataset.originalHtml){
              btn.dataset.originalHtml = btn.innerHTML;
            }
            btn.innerHTML = '<span class="btn-spinner' + (color === 'black' ? ' black' : '') + '" aria-hidden="true"></span>';
            btn.disabled = true;
          } else {
            btn.disabled = false;
            if (btn.dataset.originalHtml){
              btn.innerHTML = btn.dataset.originalHtml;
              delete btn.dataset.originalHtml;
            }
          }
        }

        function obtenerCtxServidor(){
          if (ctxCache) return ctxCache;
          if (typeof window !== 'undefined' && window.SECO_CTX) {
            ctxCache = window.SECO_CTX;
            return ctxCache;
          }
          return null;
        }
    
        function cuandoCtxListo(callback, intento){
          var ctx = obtenerCtxServidor();
          if (ctx) {
            callback(ctx);
            return;
          }
          var intentoActual = intento || 0;
          if (intentoActual >= 50) return; // ~4s
          setTimeout(function(){
            cuandoCtxListo(callback, intentoActual + 1);
          }, 80);
        }
    
        function construirOpcionesContactos(){
          var ctx = obtenerCtxServidor();
          if (!ctx) return;
          var clientes = Array.isArray(ctx.clientes) ? ctx.clientes : [];
          var opciones = [{ label: 'Nuevo contacto', isNuevo: true }];
    
          clientes.forEach(function(cli){
            opciones.push({
              label: cli && cli.nombre ? cli.nombre : 'Contacto',
              idCliente: (cli && cli.idCliente) ? cli.idCliente : '',
              cliente: cli || null
            });
          });
    
          contactosOpciones = opciones;
        }
    
        function actualizarEstadoBtnOK(){
          var habilitado = !!contactoSeleccionado;
          btnOK.disabled = !habilitado;
          btnOK.classList.toggle('btn-noir', habilitado);
          btnOK.classList.toggle('btn-desactive', !habilitado);
        }
    
        contactBtn.addEventListener('click', function(){
          cuandoCtxListo(function(){
            construirOpcionesContactos();
            overlayList.innerHTML = "";
    
            contactosOpciones.forEach(function(opt){
              var li = document.createElement('li');
              li.className = "dd-overlay-option";
              li.textContent = opt.label;
              li.dataset.isNuevo = opt.isNuevo ? '1' : '0';
              li.addEventListener('click', function(){
                contactoSeleccionado = opt;
                contactBtn.querySelector('.dd-label').textContent = opt.label;
                contactBtn.removeAttribute('data-placeholder');
                overlay.setAttribute('data-open','false');
                document.body.style.overflow = '';
                actualizarEstadoBtnOK();
              });
              overlayList.appendChild(li);
            });
    
            overlay.setAttribute('data-open','true');
            document.body.style.overflow = 'hidden';
          });
        });
    
        overlay.addEventListener('click', function(e){
          if (e.target === overlay){
            overlay.setAttribute('data-open','false');
            document.body.style.overflow = '';
          }
        });
    
        // ===== BRANCHEMENT OK → NUEVO CONTACTO ou REGISTRAR PEDIDO =====
        btnOK.addEventListener('click', function(){
          if (btnOK.disabled) return;
          setButtonSpinner(btnOK, true);

          var ctx = obtenerCtxServidor() || {};
          var pedidoId = ctx.idPedido || ctx.pedidoId || '';

          var payload = Object.assign({}, ctx, {
            origen: 'nuevoPedido',
            pedidoId: pedidoId || '',
            idPedido: pedidoId || '',
            clienteNombre: '',
            idCliente: '',
            idContacto: ctx.idContacto || ctx.nextIdCliente || ''
          });

          if (contactoSeleccionado && contactoSeleccionado.isNuevo){
            // Ouvrir la page NUEVO CONTACTO
            window.SECO_CTX = payload;
            ctxCache = payload;
            loadPage('nuevoContacto');
          } else {
            var cli = contactoSeleccionado && contactoSeleccionado.cliente ? contactoSeleccionado.cliente : null;
            payload.clienteNombre = contactoSeleccionado ? contactoSeleccionado.label : '';
            payload.idCliente = (contactoSeleccionado && contactoSeleccionado.idCliente) ? contactoSeleccionado.idCliente : '';
            payload.cliente = cli;
            // Ouvrir directement la page REGISTRAR PEDIDO pour ce client
            payload.idContacto = payload.idCliente;
            window.SECO_CTX = payload;
            ctxCache = payload;
            loadPage('registrarPedido');
          }
        });
    
        function init(){
          applyScaleFix();
          sizeHeaderImage();
          setPedidoIdHeaderDesdeValor('');

          if (window.google && google.script && google.script.run){
            google.script.run
              .withSuccessHandler(function(resp){
                if (resp && resp.ok && resp.data){
                  window.SECO_CTX = resp.data;
                  ctxCache = resp.data;

                  setPedidoIdHeaderDesdeValor(resp.data.idPedido);

                  construirOpcionesContactos();
                  actualizarEstadoBtnOK();
                } else {
                  setPedidoIdHeaderDesdeValor('');
                }
              })
              .withFailureHandler(function(){
                setPedidoIdHeaderDesdeValor('');
              })
              .initNuevoPedido();
          } else {
            setPedidoIdHeaderDesdeValor('');
          }
        }
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
    
        window.addEventListener('resize', function(){
          applyScaleFix();
          sizeHeaderImage();
        });
  },

  nuevoContacto: function(){
    function applyScaleFix(){
          var cssW = window.innerWidth || document.documentElement.clientWidth;
          var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
          if (cssW >= 960 && cssW <= 1024) {
            var fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
        }
    
        function sizeHeaderImage(){
          var img = document.getElementById('headerImg');
          var wrap = document.querySelector('.wrapper');
          if (!img || !wrap) return;
          var w = Math.floor(wrap.clientWidth);
          if (w > 0){
            img.style.width = w + 'px';
            img.style.maxWidth = '100%';
            img.removeAttribute('height');
          }
        }
    
        /* Références des champs pour la validation */
        var overlay      = document.getElementById('ddOverlay');
        var overlayList  = document.getElementById('ddOverlayList');
        var sectorBtn    = document.getElementById('sectorBtn');
        var btnGuardar   = document.getElementById('btnGuardar');
        var btnVolverIni = document.getElementById('btnVolverInicio');
    
        var nombreEl   = document.getElementById('nombre');
        var dirEl      = document.getElementById('direccion');
        var notaEl     = document.getElementById('nota');
        var whatsappEl = document.getElementById('whatsapp');

        var ctxCache = null;
        var sectoresOpciones = [];

        function setButtonLoading(btn, isLoading){
          if (!btn) return;
          if (isLoading){
            if (!btn.dataset.originalColor){
              var computed = window.getComputedStyle ? getComputedStyle(btn).color : btn.style.color;
              btn.dataset.originalColor = computed || '';
            }
            btn.disabled = true;
            btn.style.color = 'rgba(255,255,255,0.5)';
          } else {
            btn.disabled = false;
            btn.style.color = btn.dataset.originalColor || '';
          }
        }

        function setButtonSpinner(btn, isLoading, color){
          if (!btn) return;
          if (btn.classList.contains('btn-noir')){
            if (isLoading){
              window.secoSetBlackButtonLoading(btn, true);
            } else {
              window.secoSetBlackButtonLoading(btn, false);
            }
            return;
          }
          if (isLoading){
            if (!btn.dataset.originalHtml){
              btn.dataset.originalHtml = btn.innerHTML;
            }
            btn.innerHTML = '<span class="btn-spinner' + (color === 'black' ? ' black' : '') + '" aria-hidden="true"></span>';
            btn.disabled = true;
          } else {
            btn.disabled = false;
            if (btn.dataset.originalHtml){
              btn.innerHTML = btn.dataset.originalHtml;
              delete btn.dataset.originalHtml;
            }
          }
        }
    
        function obtenerCtxServidor(){
          if (ctxCache) return ctxCache;
          if (typeof window !== 'undefined' && window.SECO_CTX) {
            ctxCache = window.SECO_CTX;
            return ctxCache;
          }
          return null;
        }
    
        function cuandoCtxListo(callback, intento){
          var ctx = obtenerCtxServidor();
          if (ctx) {
            callback(ctx);
            return;
          }
          var intentoActual = (intento || 0);
          if (intentoActual >= 50) return; // ~4s max si 80ms
          setTimeout(function(){
            cuandoCtxListo(callback, intentoActual + 1);
          }, 80);
        }
    
        function setContactoIdDesdeCtx(ctx){
          var idEl = document.getElementById('contactoId');
          if (!idEl || !ctx) return;
          var txtEl = document.getElementById('contactoIdTexto');
          var loaderEl = idEl.querySelector('.pedido-id-loader');
          var idContacto = (ctx && (ctx.idContacto || ctx.nextIdCliente)) ? (ctx.idContacto || ctx.nextIdCliente) : '';
          var tiene = !!idContacto;

          if (txtEl){
            txtEl.textContent = idContacto;
            txtEl.style.display = tiene ? '' : 'none';
          }
          if (loaderEl){
            loaderEl.style.display = tiene ? 'none' : '';
          }
        }
    
        function esWhatsappValido(valor){
          var limpio = (valor || '').toString().trim();
          return /^\d{7,15}$/.test(limpio);
        }
    
        function validarWhatsappCampo(){
          var errorEl = document.getElementById('whatsappError');
          if (!errorEl) return esWhatsappValido(whatsappEl.value);
    
          var valor = (whatsappEl.value || '').toString().trim();
          if (!valor){
            errorEl.textContent = '';
            return false;
          }
    
          var valido = esWhatsappValido(valor);
          errorEl.textContent = valido ? '' : 'Número de WhatsApp inválido';
          return valido;
        }
    
        function champsRemplis(){
          var nomOK    = nombreEl.value.trim()   !== '';
          var dirOK    = dirEl.value.trim()      !== '';
          var waOK     = esWhatsappValido(whatsappEl.value);
          var sectorOK = !sectorBtn.hasAttribute('data-placeholder');
          // Nota est optionnel → non pris en compte
          return nomOK && dirOK && waOK && sectorOK;
        }
    
        function majBoutonGuardar(){
          var waValido = validarWhatsappCampo();
          if (champsRemplis() && waValido){
            btnGuardar.disabled = false;
            btnGuardar.classList.remove('btn-desactive');
            btnGuardar.classList.add('btn-noir');
          } else {
            btnGuardar.disabled = true;
            btnGuardar.classList.remove('btn-noir');
            btnGuardar.classList.add('btn-desactive');
          }
        }

        function cargarSectoresDesdeServidor(callback) {
          google.script.run
            .withSuccessHandler(function(resp) {
              if (resp && resp.ok && Array.isArray(resp.sectores)) {
                sectoresOpciones = resp.sectores
                  .map(function(sec){ return (sec && sec.nombre) ? sec.nombre : sec; })
                  .filter(Boolean);
              } else {
                sectoresOpciones = [];
              }
              if (typeof callback === 'function') callback();
            })
            .withFailureHandler(function() {
              sectoresOpciones = [];
              if (typeof callback === 'function') callback();
            })
            .listarSectores();
        }

        /* Dropdown simple pour "Sector" */
        function openSectorDropdown(){
          if (!sectoresOpciones.length) {
            cargarSectoresDesdeServidor(function(){
              if (sectoresOpciones.length) openSectorDropdown();
            });
            return;
          }

          overlayList.innerHTML = "";

          sectoresOpciones.forEach(function(txt){
            var li = document.createElement('li');
            li.className = "dd-overlay-option";
            li.textContent = txt;
            li.addEventListener('click', function(){
              sectorBtn.querySelector('.dd-label').textContent = txt;
              sectorBtn.removeAttribute('data-placeholder');
              overlay.setAttribute('data-open','false');
              document.body.style.overflow = '';
              majBoutonGuardar();
            });
            overlayList.appendChild(li);
          });
    
          overlay.setAttribute('data-open','true');
          document.body.style.overflow = 'hidden';
        }
    
        sectorBtn.addEventListener('click', openSectorDropdown);
    
        overlay.addEventListener('click', function(e){
          if (e.target === overlay){
            overlay.setAttribute('data-open','false');
            document.body.style.overflow = '';
          }
        });
    
        /* Écouteurs sur les champs pour activer/désactiver GUARDAR */
        ['input','change'].forEach(function(ev){
          nombreEl.addEventListener(ev, majBoutonGuardar);
          dirEl.addEventListener(ev, majBoutonGuardar);
          // notaEl est optionnel → pas nécessaire dans la logique d'activation
          whatsappEl.addEventListener(ev, majBoutonGuardar);
        });
    
        /* Clic sur GUARDAR : créer le client puis ouvrir registrarPedido */
        btnGuardar.addEventListener('click', function(){
          if (btnGuardar.disabled) return;
    
          var whatsappValido = validarWhatsappCampo();
          if (!whatsappValido){
            whatsappEl.focus();
            return;
          }
    
          var sectorText = sectorBtn.querySelector('.dd-label')
            ? sectorBtn.querySelector('.dd-label').textContent.trim()
            : '';
    
          var ctxActual = obtenerCtxServidor();
    
          var datosCliente = {
            idContacto: (ctxActual && ctxActual.idContacto) ? ctxActual.idContacto : '',
            pedidoId:   (ctxActual && ctxActual.pedidoId) ? ctxActual.pedidoId : '',
            nombre:    nombreEl.value.trim(),
            direccion: dirEl.value.trim(),
            telefono:  whatsappEl.value.trim(),
            sector:    sectorText,
            nota:      notaEl.value.trim()
          };

          setButtonSpinner(btnGuardar, true);
          if (btnVolverIni) btnVolverIni.disabled = true;

          google.script.run
            .withSuccessHandler(function(resp){
              if (!resp || (!resp.ok && !resp.success) || !resp.data || !resp.data.cliente){
                setButtonSpinner(btnGuardar, false);
                if (btnVolverIni) btnVolverIni.disabled = false;
                var msg = (resp && resp.error) ? resp.error : 'Error al crear el cliente.';
                alert(msg);
                return;
              }

              var cliente = resp.data.cliente; // { idCliente, nombre, telefono, direccion, sector, nota }

              var ctxNuevoPedido = obtenerCtxServidor() || {};

              var pedidoIdNuevo = (resp.data && (resp.data.pedidoId || resp.data.idPedido))
                ? (resp.data.pedidoId || resp.data.idPedido)
                : (ctxNuevoPedido.pedidoId || ctxNuevoPedido.idPedido || datosCliente.pedidoId || '');

              var payload = Object.assign({}, ctxNuevoPedido, {
                origen: 'nuevoContacto',
                pedidoId: pedidoIdNuevo,
                idPedido: pedidoIdNuevo,
                idContacto: (resp.data && resp.data.idContacto) ? resp.data.idContacto : (ctxNuevoPedido.idContacto || datosCliente.idContacto || ''),
                clienteNombre: (resp.data && resp.data.clienteNombre) ? resp.data.clienteNombre : (cliente.nombre || ''),
                cliente: cliente
              });

              window.SECO_CTX = payload;
              ctxCache = payload;

              loadPage('registrarPedido');
            })
            .withFailureHandler(function(err){
              setButtonSpinner(btnGuardar, false);
              if (btnVolverIni) btnVolverIni.disabled = false;
              var msg = (err && err.message) ? err.message : 'Error al crear el cliente.';
              alert(msg);
            })
            .registrarNuevoContacto(datosCliente, ctxActual);
        });
    
        registerVolverInicioHook(btnVolverIni, function(){
          if (btnGuardar) btnGuardar.disabled = true;

          nombreEl.value   = '';
          dirEl.value      = '';
          notaEl.value     = '';
          whatsappEl.value = '';

          sectorBtn.setAttribute('data-placeholder', 'true');
          var lbl = sectorBtn.querySelector('.dd-label');
          if (lbl){
            lbl.textContent = 'Elegir un sector';
          }

          majBoutonGuardar();

          window.SECO_CTX = null;
          ctxCache = null;
        });
    
        function init(){
          applyScaleFix();
            sizeHeaderImage();

          cuandoCtxListo(function(ctx){
            ctxCache = ctx;
            setContactoIdDesdeCtx(ctx);
            majBoutonGuardar();
          });

          cargarSectoresDesdeServidor();
          majBoutonGuardar();
        }
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
    
        window.addEventListener('resize', function(){
          applyScaleFix();
          sizeHeaderImage();
        });
  },

  editarContacto: function(){
    function applyScaleFix(){
          var cssW = window.innerWidth || document.documentElement.clientWidth;
          var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
          if (cssW >= 960 && cssW <= 1024) {
            var fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
        }
    
        function sizeHeaderImage(){
          var img = document.getElementById('headerImg');
          var wrap = document.querySelector('.wrapper');
          if (!img || !wrap) return;
          var w = Math.floor(wrap.clientWidth);
          if (w > 0){
            img.style.width = w + 'px';
            img.style.maxWidth = '100%';
            img.removeAttribute('height');
          }
        }
    
        var overlay      = document.getElementById('ddOverlay');
        var overlayList  = document.getElementById('ddOverlayList');
        var sectorBtn    = document.getElementById('sectorBtn');
        var btnGuardar   = document.getElementById('btnGuardar');
        var btnVolverIni = document.getElementById('btnVolverInicio');
    
        var nombreEl   = document.getElementById('nombre');
        var dirEl      = document.getElementById('direccion');
        var notaEl     = document.getElementById('nota');
        var whatsappEl = document.getElementById('whatsapp');
    
        var ctxCache = null;
        var sectoresOpciones = [];
    
        function obtenerCtxServidor(){
          if (ctxCache) return ctxCache;
          if (typeof window !== 'undefined' && window.SECO_CTX){
            ctxCache = window.SECO_CTX;
            return ctxCache;
          }
          return null;
        }
    
        function cuandoCtxListo(callback, intento){
          var ctx = obtenerCtxServidor();
          if (ctx){
            callback(ctx);
            return;
          }
          var intentoActual = intento || 0;
          if (intentoActual >= 50) return;
          setTimeout(function(){
            cuandoCtxListo(callback, intentoActual + 1);
          }, 80);
        }
    
        function setContactoIdDesdeCtx(ctx){
          var idEl = document.getElementById('contactoId');
          if (!idEl || !ctx) return;
          var idContacto = (ctx.idContacto || (ctx.cliente && ctx.cliente.idCliente) || '').toString();
          if (idContacto){
            idEl.textContent = idContacto;
          }
        }
    
        function sincronizarSectoresDesdeCtx(ctx){
          var sectores = Array.isArray(ctx && ctx.sectores) ? ctx.sectores : [];
          sectoresOpciones = sectores
            .map(function(sec){ return (sec && sec.nombre) ? sec.nombre : sec; })
            .filter(Boolean);
    
          var dataEl = sectorBtn && sectorBtn.parentNode ? sectorBtn.parentNode.querySelector('.dd-data') : null;
          if (dataEl){
            dataEl.textContent = JSON.stringify(sectoresOpciones);
          }
        }
    
        function esWhatsappValido(valor){
          var limpio = (valor || '').toString().trim();
          return /^\d{7,15}$/.test(limpio);
        }
    
        function validarWhatsappCampo(){
          var errorEl = document.getElementById('whatsappError');
          if (!errorEl) return esWhatsappValido(whatsappEl.value);
    
          var valor = (whatsappEl.value || '').toString().trim();
          if (!valor){
            errorEl.textContent = '';
            return false;
          }
    
          var valido = esWhatsappValido(valor);
          errorEl.textContent = valido ? '' : 'Número de WhatsApp inválido';
          return valido;
        }
    
        function champsRemplis(){
          var nomOK    = nombreEl.value.trim()   !== '';
          var dirOK    = dirEl.value.trim()      !== '';
          var waOK     = esWhatsappValido(whatsappEl.value);
          var sectorOK = !sectorBtn.hasAttribute('data-placeholder');
          return nomOK && dirOK && waOK && sectorOK;
        }
    
        function majBoutonGuardar(){
          var waValido = validarWhatsappCampo();
          if (champsRemplis() && waValido){
            btnGuardar.disabled = false;
            btnGuardar.classList.remove('btn-desactive');
            btnGuardar.classList.add('btn-noir');
          } else {
            btnGuardar.disabled = true;
            btnGuardar.classList.remove('btn-noir');
            btnGuardar.classList.add('btn-desactive');
          }
        }
    
        function poblarFormularioDesdeCtx(ctx){
          if (!ctx) return;
    
          var cliente = ctx.cliente || {};
          nombreEl.value   = cliente.nombre || '';
          dirEl.value      = cliente.direccion || '';
          notaEl.value     = cliente.nota || '';
          whatsappEl.value = cliente.telefono || cliente.whatsapp || '';
    
          var sector = cliente.sector || '';
          var lbl = sectorBtn.querySelector('.dd-label');
          if (sector && lbl){
            lbl.textContent = sector;
            sectorBtn.removeAttribute('data-placeholder');
          }
    
          setContactoIdDesdeCtx(ctx);
        }
    
        function openSectorDropdown(){
          if (!sectoresOpciones.length) {
            cuandoCtxListo(function(ctx){
              sincronizarSectoresDesdeCtx(ctx);
              openSectorDropdown();
            });
            return;
          }
    
          overlayList.innerHTML = "";
    
          sectoresOpciones.forEach(function(txt){
            var li = document.createElement('li');
            li.className = "dd-overlay-option";
            li.textContent = txt;
            li.addEventListener('click', function(){
              sectorBtn.querySelector('.dd-label').textContent = txt;
              sectorBtn.removeAttribute('data-placeholder');
              overlay.setAttribute('data-open','false');
              document.body.style.overflow = '';
              majBoutonGuardar();
            });
            overlayList.appendChild(li);
          });
    
          overlay.setAttribute('data-open','true');
          document.body.style.overflow = 'hidden';
        }
    
        sectorBtn.addEventListener('click', openSectorDropdown);
    
        overlay.addEventListener('click', function(e){
          if (e.target === overlay){
            overlay.setAttribute('data-open','false');
            document.body.style.overflow = '';
          }
        });
    
        ['input','change'].forEach(function(ev){
          nombreEl.addEventListener(ev, majBoutonGuardar);
          dirEl.addEventListener(ev, majBoutonGuardar);
          whatsappEl.addEventListener(ev, majBoutonGuardar);
        });
    
        btnGuardar.addEventListener('click', function(){
          if (btnGuardar.disabled) return;

          var waValido = validarWhatsappCampo();
          if (!waValido){
            whatsappEl.focus();
            return;
          }

          secoSetBlackButtonLoading(btnGuardar, true);

          var sectorText = sectorBtn.querySelector('.dd-label')
            ? sectorBtn.querySelector('.dd-label').textContent.trim()
            : '';
    
          var ctxActual = obtenerCtxServidor() || {};
    
          var datosCliente = {
            idContacto: (ctxActual && (ctxActual.idContacto || (ctxActual.cliente && ctxActual.cliente.idCliente))) || '',
            pedidoId:   (ctxActual && ctxActual.pedidoId) ? ctxActual.pedidoId : '',
            nombre:    nombreEl.value.trim(),
            direccion: dirEl.value.trim(),
            telefono:  whatsappEl.value.trim(),
            sector:    sectorText,
            nota:      notaEl.value.trim()
          };

          google.script.run
            .withSuccessHandler(function(resp){
              if (!resp || !resp.ok || !resp.data || !resp.data.ctx){
                var msg = (resp && resp.error) ? resp.error : 'Error al actualizar el contacto.';
                alert(msg);
                return;
              }
              var ctxResp = resp.data.ctx || {};
              var origen = (ctxActual && ctxActual.origen) || ctxResp.origen || '';
              var clienteActualizado = resp.data.cliente || ctxResp.cliente || null;

              if (origen === 'editarPedido'){
                var nuevoCtx = Object.assign({}, ctxActual || {}, ctxResp || {});
                if (clienteActualizado){
                  nuevoCtx.cliente = clienteActualizado;
                }

                var pedidoEnEdicion = nuevoCtx.pedidoEnEdicion || nuevoCtx.pedido || null;
                if (pedidoEnEdicion && clienteActualizado){
                  pedidoEnEdicion.cliente = clienteActualizado;
                  nuevoCtx.pedidoEnEdicion = pedidoEnEdicion;
                  if (!nuevoCtx.pedido) {
                    nuevoCtx.pedido = pedidoEnEdicion;
                  }
                }

                window.SECO_CTX = nuevoCtx;
                loadPage('editarPedido');
                return;
              }

              loadPage('registrarPedido');
            })
            .withFailureHandler(function(err){
              secoSetBlackButtonLoading(btnGuardar, false);
              var msg = (err && err.message) ? err.message : 'Error al actualizar el contacto.';
              alert(msg);
            })
            .actualizarContactoDesdeEditar(datosCliente, ctxActual);
        });
    
        function init(){
          applyScaleFix();
          sizeHeaderImage();
    
          cuandoCtxListo(function(ctx){
            sincronizarSectoresDesdeCtx(ctx);
            poblarFormularioDesdeCtx(ctx);
            majBoutonGuardar();
          });
        }
        if (document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
    
        window.addEventListener('resize', function(){
          applyScaleFix();
          sizeHeaderImage();
        });
  },

  editarPedido: function(){
    var ctx = (typeof window !== 'undefined' && window.SECO_CTX) ? window.SECO_CTX : {};
    var pedido = ctx && ctx.pedidoEnEdicion ? ctx.pedidoEnEdicion : null;
    var sectoresCtx = Array.isArray(ctx.sectores) ? ctx.sectores : [];
    var precioUnitarioCache = null;

    var overlay      = document.getElementById('ddOverlay');
    var overlayList  = document.getElementById('ddOverlayList');
    var btnVolver    = document.getElementById('btnVolver');
    var btnRegistrar = document.getElementById('btnRegistrar');
    var pedidoIdEl   = document.getElementById('pedidoId');
    var contactEditBtn   = document.querySelector('.contact-edit');

    var overlayListRef = null;
    var currentDropdown = null;
    var contactEditLoading = false;

    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var avail = Math.floor(wrapper.clientWidth);
      if (avail > 0) {
        img.style.width = avail + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    function obtenerElementoSector(){
      var labels = document.querySelectorAll('.contact-card .label');
      for (var i = 0; i < labels.length; i++) {
        var lbl = labels[i];
        if ((lbl.textContent || '').toString().trim().toLowerCase() !== 'sector') continue;

        var contenedor = lbl.parentElement;
        if (contenedor) {
          var txtBody = contenedor.querySelector('.txt-body');
          if (txtBody && txtBody.textContent) {
            return txtBody;
          }
        }

        var siguiente = lbl.nextElementSibling;
        if (siguiente && siguiente.classList.contains('txt-body') && siguiente.textContent) {
          return siguiente;
        }
      }
      return null;
    }

    function obtenerSectorDesdePagina(){
      var el = obtenerElementoSector();
      return el && el.textContent ? el.textContent.trim() : '';
    }

    function construirSectorPrices(){
      var sectores = Array.isArray(sectoresCtx) ? sectoresCtx : [];
      var tabla = {};

      sectores.forEach(function(sec){
        var nombre = (sec && sec.nombre) ? sec.nombre.toString().trim() : '';
        var precioValido = (sec && typeof sec.precio === 'number' && !isNaN(sec.precio))
          ? Number(sec.precio)
          : null;

        if (!nombre || precioValido === null) return;
        tabla[nombre.toLowerCase()] = precioValido;
      });

      return tabla;
    }

    function getPrecioBaseDesdeCtx(){
      if (precioUnitarioCache !== null) return precioUnitarioCache;

      if (ctx && typeof ctx.precioBase === 'number' && !isNaN(ctx.precioBase)){
        precioUnitarioCache = Number(ctx.precioBase);
        return precioUnitarioCache;
      }

      if (pedido && typeof pedido.precioUnitario === 'number' && !isNaN(pedido.precioUnitario)){
        precioUnitarioCache = Number(pedido.precioUnitario);
        ctx.precioBase = precioUnitarioCache;
        return precioUnitarioCache;
      }

      var sectorTexto = (obtenerSectorDesdePagina() || '').toString().trim().toLowerCase();
      var sectorPrices = construirSectorPrices();

      if (sectorTexto && Object.prototype.hasOwnProperty.call(sectorPrices, sectorTexto)) {
        precioUnitarioCache = sectorPrices[sectorTexto];
        ctx.precioBase = precioUnitarioCache;
        return precioUnitarioCache;
      }

      return 0;
    }

    function cargarPrecioUnitarioDesdeBackend(){
      var sectorTexto = obtenerSectorDesdePagina();
      if (!sectorTexto || (precioUnitarioCache !== null && precioUnitarioCache > 0)) return;

      google.script.run
        .withSuccessHandler(function(resp){
          if (resp && resp.ok && resp.data && typeof resp.data.precio === 'number' && !isNaN(resp.data.precio)){
            precioUnitarioCache = Number(resp.data.precio);
            ctx.precioBase = precioUnitarioCache;
          }
          updatePrecioYBoton();
        })
        .withFailureHandler(function(){
          updatePrecioYBoton();
        })
        .obtenerPrecioUnitarioSector(sectorTexto);
    }

    function buildTimes(){
      const out=[];
      for(let h=6;h<=18;h++){
        for(let m=0;m<60;m+=5){
          if(h===18 && m>55) break;
          out.push(String(h).padStart(2,"0")+":"+String(m).padStart(2,"0"));
        }
      }
      return out;
    }

    function normalizarHora(h) {
      if (!h) return '';
      const raw = String(h).trim();

      // Format H:MM ou HH:MM
      const m = raw.match(/(\d{1,2}):(\d{2})/);
      if (m) {
        const hh = m[1].padStart(2, "0");
        const mm = m[2];
        return hh + ":" + mm;
      }

      // Format ISO ou Date()
      const d = new Date(raw);
      if (!isNaN(d.getTime())) {
        const hh = String(d.getHours()).padStart(2, "0");
        const mm = String(d.getMinutes()).padStart(2, "0");
        return hh + ":" + mm;
      }

      return raw;
    }

          function formatFechaEtiqueta(raw){
        if (!raw) return "";

        var meses = ["Ene.","Feb.","Mar.","Abr.","May.","Jun.","Jul.","Ago.","Sep.","Oct.","Nov.","Dic."];
        var dias  = ["Domingo","Lunes","Martes","Miercoles","Jueves","Viernes","Sabado"];

        var d = null;
        var s = String(raw).trim();

        // Format DD/MM/YYYY
        var mSlash = s.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        if (mSlash){
          var dd = parseInt(mSlash[1], 10);
          var mm = parseInt(mSlash[2], 10) - 1;
          var yyyy = parseInt(mSlash[3], 10);
          d = new Date(yyyy, mm, dd); // LOCAL, pas UTC
        } else {
          // Format YYYY-MM-DD
          var mDash = s.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (mDash){
            var yyyy2 = parseInt(mDash[1], 10);
            var mm2   = parseInt(mDash[2], 10) - 1;
            var dd2   = parseInt(mDash[3], 10);
            d = new Date(yyyy2, mm2, dd2); // LOCAL, pas UTC
          } else {
            // Fallback: laisser le moteur essayer
            var dIso = new Date(s);
            if (!isNaN(dIso.getTime())){
              d = dIso;
            }
          }
        }

        if (!d || isNaN(d.getTime())) return raw;

        var dow = dias[d.getDay()];
        var day = d.getDate();
        var mes = meses[d.getMonth()];

        return dow + ", " + day + " de " + mes;
      }


    function buildDatesStartingTomorrow(count){
      const res = [];
      const hoy = new Date();
      for (let i = 1; i <= count; i++){
        const d = new Date(hoy);
        d.setDate(hoy.getDate() + i);
        const dd  = String(d.getDate()).padStart(2,"0");
        const mm  = String(d.getMonth()+1).padStart(2,"0");
        const yyyy = d.getFullYear();
        const etiqueta = formatFechaEtiqueta(yyyy + "-" + mm + "-" + dd);
        res.push(etiqueta);
      }
      return res;
    }

    function updatePrecioYBoton(){
      var precioBase = getPrecioBaseDesdeCtx();
      var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
      var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
      var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
      var btn        = document.getElementById('btnRegistrar');
      var precioEl   = document.getElementById('precioValor');

      function isFilled(dd){
        if (!dd) return false;
        var button = dd.querySelector('.dd-button');
        var val = dd.dataset.value || '';
        var isPlaceholder = button && button.getAttribute('data-placeholder') === 'true';
        return !isPlaceholder && val !== '';
      }

      var cantidad = 0;
      if (isFilled(ddCantidad)){
        var raw = ddCantidad.dataset.value || '';
        var m = raw.match(/^(\d+)/);
        if (m) cantidad = parseInt(m[1],10);
      }
      if (!isFinite(cantidad) || cantidad < 1) cantidad = 0;

      var total = precioBase * cantidad;
      if (precioEl){
        var txt = (cantidad && precioBase ? total : 0).toFixed(2).replace('.', ',') + ' $';
        precioEl.textContent = txt;
        var isPlaceholder = !cantidad || !precioBase;
        precioEl.style.color = isPlaceholder ? 'rgba(0,0,0,0.25)' : '#000';
      }

      var ok = isFilled(ddFecha) && isFilled(ddHora) && isFilled(ddCantidad);
      if (btn){
        btn.disabled = !ok;
        btn.classList.toggle('btn-noir', ok);
        btn.classList.toggle('btn-desactive', !ok);
      }
    }

    function observarCambiosSector(){
      var sectorEl = obtenerElementoSector();
      if (!sectorEl || typeof MutationObserver !== 'function') return;

      var obs = new MutationObserver(function(){
        updatePrecioYBoton();
      });

      obs.observe(sectorEl, { childList: true, characterData: true, subtree: true });
    }

    function formatISODate(d){
      if (!(d instanceof Date) || isNaN(d.getTime())) return '';
      var yyyy = d.getFullYear();
      var mm   = String(d.getMonth() + 1).padStart(2, '0');
      var dd   = String(d.getDate()).padStart(2, '0');
      return yyyy + '-' + mm + '-' + dd;
    }

    function buscarFechaPorEtiqueta(etiqueta){
      var texto = (etiqueta || '').toString().trim();
      if (!texto) return '';

      var isoMatch = texto.match(/^\d{4}-\d{2}-\d{2}$/);
      if (isoMatch) return texto;

      var parsed = new Date(texto);
      if (!isNaN(parsed.getTime())){
        return formatISODate(parsed);
      }

      var hoy = new Date();
      hoy.setHours(0,0,0,0);
      for (var i = 0; i < 400; i++){
        var d = new Date(hoy);
        d.setDate(hoy.getDate() + i);
        if (formatFechaEtiqueta(d) === texto){
          return formatISODate(d);
        }
      }

      return '';
    }

    function obtenerValorDropdown(nombre){
      var dd = document.querySelector('.dropdown[data-name="' + nombre + '"]');
      if (!dd) return '';
      var val = dd.dataset.value || '';
      if (!val){
        var label = dd.querySelector('.dd-label');
        if (label && label.textContent) val = label.textContent.trim();
      }
      return val;
    }

    function obtenerCantidadSeleccionada(){
      var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
      if (!ddCantidad) return 0;

      var raw = ddCantidad.dataset.value || '';
      var m = raw.match(/^(\d+)/);
      if (m){
        var n = parseInt(m[1], 10);
        if (!isNaN(n) && n > 0) return n;
      }
      return 0;
    }

    function construirPayloadEdicion(){
      var fechaSeleccion = buscarFechaPorEtiqueta(obtenerValorDropdown('fecha'))
        || buscarFechaPorEtiqueta((pedido && (pedido.fechaEntrega || pedido.fecha)) || '');

      var horaSeleccion = normalizarHora(obtenerValorDropdown('hora')) || normalizarHora(pedido && pedido.horaEntrega);
      var cantidadSel   = obtenerCantidadSeleccionada();
      var notasSel      = (pedido && (pedido.notas || pedido.nota)) || '';
      var idPedidoSel   = (pedido && (pedido.idPedido || pedido.pedidoId)) || (ctx && ctx.pedidoId) || '';

      var notasInput = document.querySelector('[data-role="nota-input"], #notasInput, textarea[name="notas"]');
      if (notasInput && typeof notasInput.value === 'string') {
        notasSel = notasInput.value;
      }

      return {
        idPedido: idPedidoSel,
        fechaEntrega: fechaSeleccion,
        horaEntrega: horaSeleccion,
        cantidad: cantidadSel,
        notas: notasSel
      };
    }

    var overlayRef, overlayListEl;

    function openOverlayFor(dropdown){
      overlayRef = overlay;
      overlayListEl = overlayList || document.getElementById('ddOverlayList');
      if (!overlayRef || !overlayListEl || !dropdown) return;

      currentDropdown = dropdown;
      overlayListEl.className = 'dd-overlay-list';
      overlayListEl.innerHTML = "";

      var button = dropdown.querySelector('.dd-button');
      var label  = dropdown.querySelector('.dd-label');

      var variant = dropdown.dataset.listVariant || 'fullscreen';

      if (variant === 'grid3'){
        overlayListEl.classList.add('grid3');

        var phText = dropdown.dataset.ph || label.textContent.trim() || 'Heure';
        var ph = document.createElement('li');
        ph.className = 'dd-grid-option placeholder';
        ph.textContent = phText;
        ph.addEventListener('click', function(){
          label.textContent = phText;
          button.setAttribute('data-placeholder','true');
          dropdown.dataset.value = '';
          closeOverlay();
          setTimeout(()=>button.focus({preventScroll:true}),0);
          updatePrecioYBoton();
        });
        overlayListEl.appendChild(ph);

        var times = buildTimes();
        var perRow = 3, groupRows = 4, groupSize = perRow * groupRows;
        var col = 1;
        const ddHora = document.querySelector('.dropdown[data-name="hora"]');
        const rawSelected = ddHora ? (ddHora.dataset.value || '') : '';
        const horaSeleccionada = normalizarHora(rawSelected);

        times.forEach(function(txt, idx){
          var li = document.createElement('li');
          li.className = 'dd-grid-option';
          li.textContent = txt;
          li.setAttribute('role','option');
          li.dataset.col = String(col);

          if (normalizarHora(txt) === horaSeleccionada) {
            li.classList.add('is-selected');
          }

          li.addEventListener('click', function(){
            label.textContent = txt;
            button.removeAttribute('data-placeholder');
            dropdown.dataset.value = txt;
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            updatePrecioYBoton();
          });
          overlayListEl.appendChild(li);

          col = (col % 3) + 1;

          var pos = idx + 1;
          if (pos % groupSize === 0 && pos < times.length){
            var sep = document.createElement('li');
            sep.className = 'dd-grid-sep-black';
            overlayListEl.appendChild(sep);
          }
        });

      } else {
        var dataEl = dropdown.querySelector('.dd-data');
        var items = [];
        if (dataEl) {
          try { items = JSON.parse(dataEl.textContent.trim() || "[]"); } catch(e){ items = []; }
        }

        var placeholderText = dropdown.dataset.ph || label.textContent.trim() || 'Seleccionar';
        var liPh = document.createElement('li');
        liPh.className = 'dd-overlay-option placeholder';
        liPh.setAttribute('role','option');
        liPh.textContent = placeholderText;
        liPh.addEventListener('click', function(){
          label.textContent = placeholderText;
          button.setAttribute('data-placeholder','true');
          dropdown.dataset.value = '';
          closeOverlay();
          setTimeout(()=>button.focus({preventScroll:true}),0);
          updatePrecioYBoton();
        });
        overlayListEl.appendChild(liPh);

        items.forEach(function(txt){
          var li = document.createElement('li');
          li.className = 'dd-overlay-option';
          li.setAttribute('role','option');
          li.textContent = txt;
          li.addEventListener('click', function(){
            label.textContent = txt;
            button.removeAttribute('data-placeholder');
            dropdown.dataset.value = txt;
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            updatePrecioYBoton();
          });
          overlayListEl.appendChild(li);
        });
      }

      document.getElementById('ddOverlay').setAttribute('data-open','true');
      document.body.style.overflow = 'hidden';
    }

    function closeOverlay(){
      document.getElementById('ddOverlay').setAttribute('data-open','false');
      document.body.style.overflow = '';
      currentDropdown = null;
    }

    function setupDropdown(dropdown){
      var button = dropdown.querySelector('.dd-button');
      var label  = dropdown.querySelector('.dd-label');

      var phText = label.textContent.trim() || 'Seleccionar';
      dropdown.dataset.ph = phText;
      if (!dropdown.dataset.value){
        dropdown.dataset.value = '';
      }

      button.addEventListener('click', function(){
        openOverlayFor(dropdown);
      });
      button.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          openOverlayFor(dropdown);
        }
      });
    }

    function initDropdowns(){
      document.querySelectorAll('.dropdown').forEach(setupDropdown);
      overlayListRef = document.getElementById('ddOverlayList');

      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape' && document.getElementById('ddOverlay').getAttribute('data-open') === 'true'){
          closeOverlay();
        }
      });

      document.getElementById('ddOverlay').addEventListener('click', function(e){
        if (e.target === e.currentTarget) closeOverlay();
      });
    }

    function buildDatesAndCantidad(){
      var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
      var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');

      if (ddFecha){
        var dataElF = ddFecha.querySelector('.dd-data');
        if (dataElF){
          const fechas = buildDatesStartingTomorrow(7);
          const fechaPedidoRaw = pedido && (pedido.fechaEntrega || pedido.fecha || pedido.fecha_entrega);
          const fechaPedidoFmt = fechaPedidoRaw ? formatFechaEtiqueta(fechaPedidoRaw) : '';

          if (fechaPedidoFmt && fechas.indexOf(fechaPedidoFmt) === -1){
            fechas.unshift(fechaPedidoFmt);
          }

          dataElF.textContent = JSON.stringify(fechas);

          var btnF = ddFecha.querySelector('.dd-button');
          var labF = ddFecha.querySelector('.dd-label');
          var valorInicial = fechaPedidoFmt || (fechas.length ? fechas[0] : '');

          if (valorInicial){
            if (labF) labF.textContent = valorInicial;
            if (btnF) btnF.removeAttribute('data-placeholder');
            ddFecha.dataset.value = valorInicial;
          }
        }
      }

      if (ddCantidad){
        var dataElC = ddCantidad.querySelector('.dd-data');
        if (dataElC){
          var items = [];
          for (var i = 1; i <= 10; i++){
            items.push(i + (i === 1 ? ' seco' : ' secos'));
          }
          dataElC.textContent = JSON.stringify(items);
          if (items.length){
            var btnC = ddCantidad.querySelector('.dd-button');
            var labC = ddCantidad.querySelector('.dd-label');
            var cantidadPedido = pedido && pedido.cantidad ? Number(pedido.cantidad) : null;
            var cantidadTxt = cantidadPedido && items[cantidadPedido - 1] ? items[cantidadPedido - 1] : items[0];
            if (labC) labC.textContent = cantidadTxt;
            if (btnC) btnC.removeAttribute('data-placeholder');
            ddCantidad.dataset.value = cantidadTxt;
          }
        }
      }

      updatePrecioYBoton();
    }

    function setDefaultHoraOuDesdePedido(){
      const horaRaw = pedido.horaEntrega;
      const horaNorm = normalizarHora(horaRaw);

      const ddHora = document.querySelector('.dropdown[data-name="hora"]');
      if (ddHora) {
        ddHora.dataset.value = horaNorm;
        const lbl = ddHora.querySelector('.dd-label');
        const btn = ddHora.querySelector('.dd-button');
        if (lbl) lbl.textContent = horaNorm;
        if (btn) btn.removeAttribute('data-placeholder');
      }

      updatePrecioYBoton();
    }

    function poblarContacto(){
      var cliente = (pedido && pedido.cliente) || (ctx && ctx.cliente) || {};
      var nombre = cliente.nombre || '';
      var partes = nombre.split(' ');
      var headerLines = document.querySelectorAll('.contact-top .txt-body div');
      if (headerLines.length){
        headerLines[0].textContent = partes.shift() || nombre || 'Contacto';
        if (headerLines[1]){
          headerLines[1].textContent = partes.join(' ');
        }
      }

      var notaRow = document.querySelector('[data-role="nota-row"]');
      var notaSep = document.querySelector('[data-role="nota-sep-below"]');
      var notaBody = notaRow ? notaRow.querySelector('.txt-body') : null;
      var notaValor = (pedido && (pedido.notas || pedido.nota)) || cliente.nota || '';
      var notaTexto = (notaValor || '').trim();
      var mostrarNota = notaTexto !== '';

      document.querySelectorAll('.contact-card .label').forEach(function(lbl){
        var key = lbl.textContent.trim().toLowerCase();
        var target = lbl.nextElementSibling;
        if (!target) return;
        if (key === 'sector') target.textContent = cliente.sector || '—';
        else if (key === 'direccion') target.textContent = (pedido && pedido.direccion) || cliente.direccion || '—';
        else if (key === 'nota') return;
        else if (key === 'whatsapp') target.textContent = (cliente.telefono || cliente.whatsapp || (pedido && pedido.whatsapp)) || '—';
      });

      if (notaBody){
        notaBody.textContent = notaTexto;
      }

      if (notaRow){
        notaRow.style.display = mostrarNota ? '' : 'none';
      }
      if (notaSep){
        notaSep.style.display = mostrarNota ? '' : 'none';
      }

      if (pedidoIdEl){
        var pedidoId = (pedido && (pedido.idPedido || pedido.pedidoId || pedido.id_pedido || pedido.id)) || (ctx && ctx.pedidoId);
        if (pedidoId) pedidoIdEl.textContent = pedidoId;
      }
    }

    function bindActions(){
      function construirCtxEditarContacto(){
        var cliente = (pedido && pedido.cliente) || (ctx && ctx.cliente) || {};

        return {
          origen: 'editarPedido',
          pedidoId: (pedido && (pedido.idPedido || pedido.pedidoId)) || (ctx && ctx.pedidoId) || '',
          idContacto: cliente.idCliente || (ctx && ctx.idContacto) || '',
          cliente: cliente || {},
          pedido: pedido || (ctx && ctx.pedido),
          sectores: Array.isArray(sectoresCtx) ? sectoresCtx : []
        };
      }

      function asegurarCtxContactoCompleto(callback){
        var ctxContacto = construirCtxEditarContacto();
        var necesitaSectores = !Array.isArray(ctxContacto.sectores) || ctxContacto.sectores.length === 0;
        var tieneCliente = ctxContacto.cliente && Object.keys(ctxContacto.cliente).length > 0;
        var idContacto = ctxContacto.idContacto;

        if (!necesitaSectores && tieneCliente){
          window.SECO_CTX = ctxContacto;
          callback();
          return;
        }

        function finalizar(){
          window.SECO_CTX = ctxContacto;
          callback();
        }

        if (idContacto){
          google.script.run
            .withSuccessHandler(function(resp){
              if (resp && resp.ok){
                if (resp.data && resp.data.cliente){
                  ctxContacto.cliente = resp.data.cliente;
                }
                if (Array.isArray(resp.data && resp.data.sectores)){
                  ctxContacto.sectores = resp.data.sectores;
                  sectoresCtx = ctxContacto.sectores;
                }
              }
              finalizar();
            })
            .withFailureHandler(finalizar)
            .obtenerClientePorId({ idContacto: idContacto });
          return;
        }

        if (necesitaSectores){
          google.script.run
            .withSuccessHandler(function(resp){
              if (resp && resp.ok && Array.isArray(resp.sectores)){
                ctxContacto.sectores = resp.sectores;
                sectoresCtx = ctxContacto.sectores;
              }
              finalizar();
            })
            .withFailureHandler(finalizar)
            .listarSectores();
          return;
        }

        finalizar();
      }

      if (contactEditBtn){
        contactEditBtn.addEventListener('click', function(){
          if (contactEditLoading) return;
          contactEditLoading = true;
          contactEditBtn.classList.add('is-loading');

          asegurarCtxContactoCompleto(function(){
            loadPage('editarContacto', function(){
              contactEditLoading = false;
              contactEditBtn.classList.remove('is-loading');
            });
          });
        });
      }

      if (btnRegistrar){
        btnRegistrar.addEventListener('click', function(){
          if (btnRegistrar.disabled) return;

          window.secoSetBlackButtonLoading(btnRegistrar, true);
          var payload = construirPayloadEdicion();

          google.script.run
            .withSuccessHandler(function(resp){
              if (resp && resp.ok){
                var pedidoResp = resp.data && resp.data.pedido ? resp.data.pedido : null;
                if (pedidoResp){
                  window.SECO_CTX = {
                    pedido: pedidoResp,
                    pedidoEnEdicion: pedidoResp,
                    precioBase: pedidoResp.precioUnitario
                  };
                }
                loadPage('pedidoActualizado');
              } else {
                window.secoSetBlackButtonLoading(btnRegistrar, false);
                var msg = (resp && resp.error) ? resp.error : 'Error al actualizar el pedido.';
                alert(msg);
              }
            })
            .withFailureHandler(function(err){
              window.secoSetBlackButtonLoading(btnRegistrar, false);
              var msg = (err && err.message) ? err.message : 'Error al actualizar el pedido.';
              alert(msg);
            })
            .editarPedidoPorId(payload);
        });
      }
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      poblarContacto();
      initDropdowns();
      buildDatesAndCantidad();
      setDefaultHoraOuDesdePedido();
      cargarPrecioUnitarioDesdeBackend();
      observarCambiosSector();
      bindActions();
    }

    init();

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  registrarPedido: function() {
      var ctx = (typeof window !== 'undefined' && window.SECO_CTX) ? window.SECO_CTX : {};
      var clienteActual = ctx.cliente || null;
      var sectoresCtx = Array.isArray(ctx.sectores) ? ctx.sectores : [];
      var overlay, overlayList, currentDropdown = null;
      var contactEditBtn = document.getElementById('btnEditarContacto');
      var btnRegistrar = document.getElementById('btnRegistrar');
      var btnVolver = document.getElementById('btnVolver');

      function applyScaleFix(){
          var cssW = window.innerWidth || document.documentElement.clientWidth;
          var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
          if (cssW >= 960 && cssW <= 1024) {
            var fix = (980 / screenW) * 1.50;
            document.documentElement.style.setProperty('--fix', fix.toFixed(3));
          } else {
            document.documentElement.style.setProperty('--fix', '1');
          }
        }

        function sizeHeaderImage(){
          var img = document.getElementById('headerImg');
          var wrap = document.querySelector('.wrapper');
          if (!img || !wrap) return;
          var w = Math.floor(wrap.clientWidth);
          if (w > 0){
            img.style.width = w + 'px';
            img.style.maxWidth = '100%';
            img.removeAttribute('height');
          }
        }

      function obtenerElementoSector(){
        var labels = document.querySelectorAll('.contact-card .label');
        for (var i = 0; i < labels.length; i++) {
          var lbl = labels[i];
          if ((lbl.textContent || '').toString().trim().toLowerCase() !== 'sector') continue;

          var contenedor = lbl.parentElement;
          if (contenedor) {
            var txtBody = contenedor.querySelector('.txt-body');
            if (txtBody && txtBody.textContent) {
              return txtBody;
            }
          }

          var siguiente = lbl.nextElementSibling;
          if (siguiente && siguiente.classList.contains('txt-body') && siguiente.textContent) {
            return siguiente;
          }
        }
        return null;
      }

      function obtenerSectorDesdePagina(){
        var el = obtenerElementoSector();
        return el && el.textContent ? el.textContent.trim() : '';
      }

      function construirSectorPrices(){
        var sectores = Array.isArray(sectoresCtx) ? sectoresCtx : [];
        var tabla = {};

        sectores.forEach(function(sec){
          var nombre = (sec && sec.nombre) ? sec.nombre.toString().trim() : '';
          var precioValido = (sec && typeof sec.precio === 'number' && !isNaN(sec.precio))
            ? Number(sec.precio)
            : null;

          if (!nombre || precioValido === null) return;
          tabla[nombre.toLowerCase()] = precioValido;
        });

        return tabla;
      }

      function getPrecioBaseDesdeCtx(){
        if (ctx && typeof ctx.precioBase === 'number' && !isNaN(ctx.precioBase)){
          return Number(ctx.precioBase);
        }

        var sectorTexto = (obtenerSectorDesdePagina() || '').toString().trim().toLowerCase();
        var sectorPrices = construirSectorPrices();

        if (sectorTexto && Object.prototype.hasOwnProperty.call(sectorPrices, sectorTexto)) {
          return sectorPrices[sectorTexto];
        }

        return 0;
      }

      function obtenerCantidadSeleccionada(){
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
        if (!ddCantidad) return 0;
        var raw = ddCantidad.dataset.value || '';
        var m = raw.match(/^(\d+)/);
        if (m){
          var n = parseInt(m[1], 10);
          if (!isNaN(n) && n > 0) return n;
        }
        return 0;
      }

      function dropdownTieneValor(dropdown){
        if (!dropdown) return false;
        var button = dropdown.querySelector('.dd-button');
        var isPlaceholder = button && button.getAttribute('data-placeholder') === 'true';
        var val = dropdown.dataset.value || '';
        return !isPlaceholder && val !== '';
      }

      function sincronizarBotonRegistrar(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
        var btn        = document.getElementById('btnRegistrar');

        var ok = dropdownTieneValor(ddFecha) && dropdownTieneValor(ddHora) && dropdownTieneValor(ddCantidad);
        if (btn){
          btn.disabled = !ok;
          btn.classList.toggle('btn-noir', ok);
          btn.classList.toggle('btn-desactive', !ok);
        }
      }

      function actualizarPrecio(){
        var precioBase = getPrecioBaseDesdeCtx();
        var cantidad = dropdownTieneValor(document.querySelector('.dropdown[data-name="cantidad"]'))
          ? obtenerCantidadSeleccionada()
          : 0;
        var total = precioBase * cantidad;

        var precioEl = document.getElementById('precioValor');
        if (precioEl){
          var txt = (cantidad && precioBase ? total : 0).toFixed(2).replace('.', ',') + ' $';
          precioEl.textContent = txt;
          var isPlaceholder = !cantidad || !precioBase;
          precioEl.style.color = isPlaceholder ? 'rgba(0,0,0,0.25)' : '#000';
        }

        sincronizarBotonRegistrar();
      }

      function observarCambiosSector(){
        var sectorEl = obtenerElementoSector();
        if (!sectorEl || typeof MutationObserver !== 'function') return;

        var obs = new MutationObserver(function(){
          actualizarPrecio();
        });

        obs.observe(sectorEl, { childList: true, characterData: true, subtree: true });
      }

      function formatFechaEtiqueta(raw){
        if (!raw) return "";

        var meses = ["Ene.","Feb.","Mar.","Abr.","May.","Jun.","Jul.","Ago.","Sep.","Oct.","Nov.","Dic."];
        var dias  = ["Domingo","Lunes","Martes","Miercoles","Jueves","Viernes","Sabado"];

        var d = null;

        // 1) Si on reçoit déjà un objet Date
        if (raw instanceof Date){
          d = raw;
        } else {
          var s = String(raw).trim();

          // 2) Format dd/mm/yyyy → on le parse en local
          var m1 = s.match(/(\d{2})\/(\d{2})\/(\d{4})/);
          if (m1){
            var dd1  = parseInt(m1[1], 10);
            var mm1  = parseInt(m1[2], 10) - 1;
            var yy1  = parseInt(m1[3], 10);
            d = new Date(yy1, mm1, dd1);
          } else {
            // 3) Format yyyy-mm-dd → on le parse aussi en local (et surtout PAS new Date(s))
            var mIso = s.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (mIso){
              var yy2 = parseInt(mIso[1], 10);
              var mm2 = parseInt(mIso[2], 10) - 1;
              var dd2 = parseInt(mIso[3], 10);
              d = new Date(yy2, mm2, dd2);
            } else {
              // 4) Dernier recours : new Date(s) (pour d’autres formats éventuels)
              var dIso = new Date(s);
              if (!isNaN(dIso.getTime())){
                d = dIso;
              }
            }
          }
        }

        if (!d || isNaN(d.getTime())) return raw;

        var dow = dias[d.getDay()];
        var day = d.getDate();
        var mes = meses[d.getMonth()];

        return dow + ", " + day + " de " + mes;
      }


      function buildTimes(){
        const out=[];
        for(let h=6;h<=18;h++){
          for(let m=0;m<60;m+=5){
            if(h===18 && m>55) break;
            out.push(String(h).padStart(2,"0")+":"+String(m).padStart(2,"0"));
          }
        }
        return out;
      }

      function normalizarHora(h) {
        if (!h) return '';
        const raw = String(h).trim();
        const m = raw.match(/(\d{1,2}):(\d{2})/);
        if (m) {
          const hh = m[1].padStart(2, "0");
          const mm = m[2];
          return hh + ":" + mm;
        }
        return '';
      }

      function buildDatesStartingTomorrow(count){
        const res = [];
        const hoy = new Date();
        for (let i = 1; i <= count; i++){
          const d = new Date(hoy);
          d.setDate(hoy.getDate() + i);
          const dd  = String(d.getDate()).padStart(2,"0");
          const mm  = String(d.getMonth()+1).padStart(2,"0");
          const yyyy = d.getFullYear();
          const etiqueta = formatFechaEtiqueta(yyyy + "-" + mm + "-" + dd);
          res.push(etiqueta);
        }
        return res;
      }

      function setButtonSpinner(btn, isLoading, color){
        if (!btn) return;
        if (btn.classList.contains('btn-noir')){
          if (isLoading){
            window.secoSetBlackButtonLoading(btn, true);
          } else {
            window.secoSetBlackButtonLoading(btn, false);
          }
          return;
        }
        if (isLoading){
          if (!btn.dataset.originalHtml){
            btn.dataset.originalHtml = btn.innerHTML;
          }
          btn.innerHTML = '<span class="btn-spinner' + (color === 'black' ? ' black' : '') + '" aria-hidden="true"></span>';
          btn.disabled = true;
        } else {
          btn.disabled = false;
          if (btn.dataset.originalHtml){
            btn.innerHTML = btn.dataset.originalHtml;
            delete btn.dataset.originalHtml;
          }
        }
      }

      function openOverlayFor(dropdown){
        currentDropdown = dropdown;
        overlayList.className = 'dd-overlay-list';
        overlayList.innerHTML = "";

        var button = dropdown.querySelector('.dd-button');
        var label  = dropdown.querySelector('.dd-label');

        var variant = dropdown.dataset.listVariant || 'fullscreen';

        if (variant === 'grid3'){
          overlayList.classList.add('grid3');

          var phText = dropdown.dataset.ph || label.textContent.trim() || 'Heure';
          var ph = document.createElement('li');
          ph.className = 'dd-grid-option placeholder';
          ph.textContent = phText;
          ph.addEventListener('click', function(){
            label.textContent = phText;
            button.setAttribute('data-placeholder','true');
            dropdown.dataset.value = '';
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            actualizarPrecio();
          });
          overlayList.appendChild(ph);

          var times = buildTimes();
          var selectedHora = normalizarHora(dropdown.dataset.value || label.textContent || '');
          var perRow = 3, groupRows = 4, groupSize = perRow * groupRows;
          var col = 1;

          times.forEach(function(txt, idx){
            var li = document.createElement('li');
            li.className = 'dd-grid-option';
            li.textContent = txt;
            li.setAttribute('role','option');
            if (normalizarHora(txt) === selectedHora) {
              li.classList.add('is-selected');
            }

            li.dataset.col = String(col);

            li.addEventListener('click', function(){

              // --- Flash visuel immédiat sur mobile ---
              li.classList.add('is-tapflash');
              setTimeout(() => li.classList.remove('is-tapflash'), 120);
              // ----------------------------------------
              label.textContent = txt;
              button.removeAttribute('data-placeholder');
              dropdown.dataset.value = txt;
              closeOverlay();
              setTimeout(()=>button.focus({preventScroll:true}),0);
              actualizarPrecio();
            });
            overlayList.appendChild(li);

            col = (col % 3) + 1;

            var pos = idx + 1;
            if (pos % groupSize === 0 && pos < times.length){
              var sep = document.createElement('li');
              sep.className = 'dd-grid-sep-black';
              overlayList.appendChild(sep);
            }
          });

        } else {
          var dataEl = dropdown.querySelector('.dd-data');
          var items = [];
          if (dataEl) {
            try { items = JSON.parse(dataEl.textContent.trim()); } catch(e){ items = []; }
          }

          var placeholderText = dropdown.dataset.ph || label.textContent.trim() || 'Lorem ipsum';
          var liPh = document.createElement('li');
          liPh.className = 'dd-overlay-option placeholder';
          liPh.setAttribute('role','option');
          liPh.textContent = placeholderText;
          liPh.addEventListener('click', function(){
            label.textContent = placeholderText;
            button.setAttribute('data-placeholder','true');
            dropdown.dataset.value = '';
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            actualizarPrecio();
          });
          overlayList.appendChild(liPh);

          items.forEach(function(txt){
            var li = document.createElement('li');
            li.className = 'dd-overlay-option';
            li.setAttribute('role','option');
            li.textContent = txt;
            li.addEventListener('click', function(){
              label.textContent = txt;
              button.removeAttribute('data-placeholder');
              dropdown.dataset.value = txt;
              closeOverlay();
              setTimeout(()=>button.focus({preventScroll:true}),0);
              actualizarPrecio();
            });
            overlayList.appendChild(li);
          });
        }

        document.getElementById('ddOverlay').setAttribute('data-open','true');
        document.body.style.overflow = 'hidden';
      }

      function closeOverlay(){
        document.getElementById('ddOverlay').setAttribute('data-open','false');
        document.body.style.overflow = '';
        currentDropdown = null;
      }

      function setupDropdown(dropdown){
        var button = dropdown.querySelector('.dd-button');
        var label  = dropdown.querySelector('.dd-label');

        var phText = label.textContent.trim() || 'Seleccionar';
        dropdown.dataset.ph = phText;
        if (!dropdown.dataset.value){
          dropdown.dataset.value = '';
        }

        button.addEventListener('click', function(){
          openOverlayFor(dropdown);
        });
        button.addEventListener('keydown', function(e){
          if (e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            openOverlayFor(dropdown);
          }
        });
      }

      function initDropdowns(){
        document.querySelectorAll('.dropdown').forEach(setupDropdown);
        overlayList = document.getElementById('ddOverlayList');

        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && document.getElementById('ddOverlay').getAttribute('data-open') === 'true'){
            closeOverlay();
          }
        });

        document.getElementById('ddOverlay').addEventListener('click', function(e){
          if (e.target === e.currentTarget) closeOverlay();
        });
      }

      function setDropdownValue(dropdown, labelText, valueText, isPlaceholder){
        if (!dropdown) return;
        var btn = dropdown.querySelector('.dd-button');
        var lab = dropdown.querySelector('.dd-label');
        if (lab && labelText !== undefined) lab.textContent = labelText;
        if (btn){
          if (isPlaceholder){
            btn.setAttribute('data-placeholder','true');
          } else {
            btn.removeAttribute('data-placeholder');
          }
        }
        dropdown.dataset.value = valueText || '';
      }

            function inicializarFechaCantidadHora(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');

        // ===== FECHA =====
        if (ddFecha){
          var dataElF = ddFecha.querySelector('.dd-data');
          var fechas = [];

          // Construire la liste à partir d'AUJOURD'HUI (7 jours)
          var hoy = new Date();
          for (var i = 0; i < 7; i++){
            var d = new Date(hoy);
            d.setDate(hoy.getDate() + i);

            var yyyy = String(d.getFullYear());
            var mm   = String(d.getMonth() + 1).padStart(2, "0");
            var dd   = String(d.getDate()).padStart(2, "0");
            var iso  = yyyy + "-" + mm + "-" + dd;

            fechas.push(formatFechaEtiqueta(iso));
          }

          if (dataElF){
            dataElF.textContent = JSON.stringify(fechas);
          }

          var preferida = null;

          if (ctx && ctx.origen === 'registrarPedido' && ctx.fechaSeleccionada){
            // Retour après editarContacto → on respecte la date déjà choisie
            preferida = ctx.fechaSeleccionada;
          } else if (fechas.length){
            // Arrivée "normale" → on force DEMAIN = 2e élément si disponible
            if (fechas.length > 1){
              preferida = fechas[1]; // demain
            } else {
              preferida = fechas[0]; // fallback: aujourd'hui si un seul élément
            }
            ctx.fechaSeleccionada = preferida;
            window.SECO_CTX = ctx;
          }

          if (preferida){
            setDropdownValue(ddFecha, preferida, preferida, false);
          }
        }

        // ===== CANTIDAD =====
        if (ddCantidad){
          var dataElC = ddCantidad.querySelector('.dd-data');
          if (dataElC){
            var items = [];
            for (var i = 1; i <= 10; i++){
              items.push(i + (i === 1 ? ' seco' : ' secos'));
            }
            dataElC.textContent = JSON.stringify(items);

            var seleccion = ctx.cantidadSeleccionada || items[0] || '';
            if (seleccion){
              setDropdownValue(ddCantidad, seleccion, seleccion, false);
            }
          }
        }

        // ===== HORA =====
        if (ddHora){
          var seleccionHora = normalizarHora(ctx.horaSeleccionada);
          var phHora = ddHora.dataset.ph || 'Hora de entrega';
          setDropdownValue(ddHora, seleccionHora || phHora, seleccionHora, !seleccionHora);
          if (!seleccionHora && ddHora.querySelector('.dd-button')){
            ddHora.querySelector('.dd-button').setAttribute('data-placeholder','true');
          }
        }

        actualizarPrecio();
      }

      function poblarContacto(){
        var nombreEl = document.getElementById('contactoNombre');
        var sublineEl = document.getElementById('contactoSubline');
        var sectorEl = document.getElementById('contactoSector');
        var dirEl = document.getElementById('contactoDireccion');
        var dirExtraEl = document.getElementById('contactoDireccionExtra');
        var notaEl = document.getElementById('contactoNota');
        var waEl = document.getElementById('contactoWhatsapp');

        var cliente = clienteActual || {};
        var nombre = cliente.nombre || ctx.clienteNombre || '';
        var partes = nombre.split(' ');
        var nombrePrincipal = partes.shift() || nombre || 'Contacto';
        var subline = partes.join(' ');
        var whatsappTexto = (cliente.telefono || cliente.whatsapp || '').toString().trim();

        if (nombreEl) nombreEl.textContent = nombrePrincipal;
        if (sublineEl) sublineEl.textContent = subline;
        if (sectorEl) sectorEl.textContent = cliente.sector || '—';

        if (dirEl) dirEl.textContent = cliente.direccion || '—';
        if (dirExtraEl){
          var extra = cliente.direccionExtra || '';
          dirExtraEl.textContent = extra;
          dirExtraEl.style.display = extra ? '' : 'none';
        }

        if (notaEl){
          var nota = cliente.nota || '';
          notaEl.textContent = nota;
          var notaRow = notaEl.parentElement;
          if (notaRow) notaRow.style.display = nota ? '' : 'none';
          var sepBelow = notaRow ? notaRow.parentElement.querySelector('[data-role="nota-sep-below"]') : null;
          if (sepBelow) sepBelow.style.display = nota ? '' : 'none';
        }

        if (waEl) waEl.textContent = whatsappTexto || '—';

        var idEl = document.getElementById('pedidoId');
        if (idEl && ctx && ctx.pedidoId){
          idEl.textContent = ctx.pedidoId;
        }

        var contactCard = document.getElementById('contactoCard');
        if (contactCard){
          contactCard.removeAttribute('data-loading');
          contactCard.classList.remove('is-loading');
          contactCard.classList.remove('loading');

          var loader = contactCard.querySelector('.contact-card-loader');
          if (loader) loader.style.display = 'none';

          var contenido = contactCard.querySelectorAll(':scope > *:not(.contact-card-loader)');
          contenido.forEach(function(el){
            el.style.removeProperty('visibility');
            el.style.removeProperty('opacity');
          });
        }
      }

      function cargarClienteDesdeServidor(){
        var idContacto = (ctx && (ctx.idContacto || (ctx.cliente && ctx.cliente.idCliente))) || '';
        if (!idContacto){
          poblarContacto();
          actualizarPrecio();
          return;
        }

        google.script.run
          .withSuccessHandler(function(resp){
            if (resp && resp.ok && resp.data && resp.data.cliente){
              clienteActual = resp.data.cliente;
              sectoresCtx = Array.isArray(resp.data.sectores) ? resp.data.sectores : sectoresCtx;
              ctx.cliente = clienteActual;
              ctx.sectores = sectoresCtx;
              window.SECO_CTX = ctx;
            }
            poblarContacto();
            actualizarPrecio();
          })
          .withFailureHandler(function(){
            poblarContacto();
            actualizarPrecio();
          })
          .obtenerClientePorId({ idContacto: idContacto });
      }

      function guardarCtxSeleccion(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');

        ctx.fechaSeleccionada = ddFecha ? (ddFecha.dataset.value || '') : '';
        ctx.horaSeleccionada = ddHora ? (ddHora.dataset.value || '') : '';
        ctx.cantidadSeleccionada = ddCantidad ? (ddCantidad.dataset.value || '') : '';
        window.SECO_CTX = ctx;
      }

      function construirPayloadRegistro(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
        var fechaTexto = '';
        var horaTexto  = '';

        if (ddFecha){
          fechaTexto = ddFecha.dataset.value || '';
          if (!fechaTexto){
            var lf = ddFecha.querySelector('.dd-label');
            if (lf && lf.textContent) fechaTexto = lf.textContent.trim();
          }
        }

        if (ddHora){
          horaTexto = ddHora.dataset.value || '';
          if (!horaTexto){
            var lh = ddHora.querySelector('.dd-label');
            if (lh && lh.textContent) horaTexto = lh.textContent.trim();
          }
        }

        var cantidad = obtenerCantidadSeleccionada();
        var unitPrice = getPrecioBaseDesdeCtx();
        var totalCalc = unitPrice * cantidad;

        var cliente = clienteActual || ctx.cliente || {};

        var payload = {
          origen: 'registrarPedido',
          cliente: cliente,
          clienteNombre: (cliente && cliente.nombre) || ctx.clienteNombre || '',
          whatsapp: (cliente.telefono || cliente.whatsapp || ctx.whatsapp || '').toString().trim(),
          direccion: (cliente.direccion || ctx.direccion || '').toString().trim(),
          sector: (cliente.sector || ctx.sector || obtenerSectorDesdePagina() || '').toString().trim(),
          nota: (cliente.nota || ctx.nota || '').toString().trim(),
          fechaTexto: fechaTexto,
          hora: horaTexto,
          cantidad: cantidad,
          precioUnitario: unitPrice,
          totalCalculado: totalCalc,
          pedidoId: (ctx.pedidoId || '').toString().trim(),
          idContacto: (ctx.idContacto || cliente.idCliente || '').toString().trim()
        };

        return payload;
      }

      function bindEditarContacto(){
        if (!contactEditBtn) return;
        contactEditBtn.addEventListener('click', function(){
          if (contactEditBtn.disabled) return;
          contactEditBtn.disabled = true;
          contactEditBtn.classList.add('is-loading');
          guardarCtxSeleccion();
          window.SECO_CTX = Object.assign({}, ctx, {
            origen: 'registrarPedido',
            pedidoId: ctx.pedidoId || '',
            idContacto: (ctx && ctx.idContacto) || (clienteActual && clienteActual.idCliente) || '',
            cliente: clienteActual,
            fechaSeleccionada: ctx.fechaSeleccionada,
            horaSeleccionada: ctx.horaSeleccionada,
            cantidadSeleccionada: ctx.cantidadSeleccionada
          });
          loadPage('editarContacto', function(){
            contactEditBtn.disabled = false;
            contactEditBtn.classList.remove('is-loading');
          });
        });
      }

      function init(){
        applyScaleFix();
        sizeHeaderImage();
        initDropdowns();
        inicializarFechaCantidadHora();
        observarCambiosSector();
        bindEditarContacto();
        cargarClienteDesdeServidor();

        if (btnVolver){
          registerVolverInicioHook(btnVolver, function(){
            guardarCtxSeleccion();
          });
        }

        if (btnRegistrar){
          btnRegistrar.addEventListener('click', function(){
            if (btnRegistrar.disabled) return;
            setButtonSpinner(btnRegistrar, true);
            guardarCtxSeleccion();
            var payload = construirPayloadRegistro();

            google.script.run
            .withSuccessHandler(function(resp){
              setButtonSpinner(btnRegistrar, false);

          if (resp && resp.ok){
            // On injecte le contexte du pedido dans la SPA
            var pedido = resp.data && resp.data.pedido ? resp.data.pedido : null;
            if (pedido){
              // pedidoRegistrado lit baseCtx.pedido || baseCtx
              window.SECO_CTX = { pedido: pedido };
            } else {
              // fallback minimal : contexte vide
              window.SECO_CTX = {};
            }

            // Puis on ouvre la page de confirmation
            loadPage('pedidoRegistrado');
          } else if (window.alert){
            var msg = (resp && resp.error) ? resp.error : 'Error al registrar el pedido.';
            alert(msg);
          }
        })
        .withFailureHandler(function(){
          setButtonSpinner(btnRegistrar, false);
          if (window.alert){
            alert('Error al registrar el pedido.');
          }
        })
        .registrarPedidoDesdeRegistrar(payload);
    });
  }
}


      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else { init(); }

      window.addEventListener('resize', function(){
        applyScaleFix();
        sizeHeaderImage();
      });
  },
  
  pedidoRegistrado: function() {
    var baseCtx = window.SECO_CTX || {};
    var pedido = baseCtx.pedido || baseCtx || {};

    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrap = document.querySelector('.wrapper');
      if (!img || !wrap) return;
      var w = Math.floor(wrap.clientWidth);
      if (w > 0){
        img.style.width = w + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    function parseCantidad(raw){
      if (typeof raw === 'number' && isFinite(raw)) return raw;
      if (!raw) return 0;
      var s = String(raw).trim();
      // ex: "2 secos", "2", "2.0"
      var m = s.match(/^(\d+)/);
      if (m){
        var n = parseInt(m[1], 10);
        if (!isNaN(n)) return n;
      }
      var n2 = Number(s.replace(',', '.'));
      return isNaN(n2) ? 0 : n2;
    }

    function parseMoney(raw){
      if (typeof raw === 'number' && isFinite(raw)) return raw;
      if (!raw) return 0;
      var s = String(raw).trim();
      // enlève symboles et garde chiffres / point / virgule
      s = s.replace(' ', ' ');
      s = s.replace(/[^0-9.,-]/g, '');
      s = s.replace(',', '.');
      var n = Number(s);
      return isNaN(n) ? 0 : n;
    }

    function formatMoneyText(n){
      n = parseMoney(n);
      return n.toFixed(2).replace('.', ',') + ' $';
    }

    function formatHoraEntrega(raw){
      if (raw instanceof Date && !isNaN(raw.getTime())){
        var hDate = raw;
        var hH = hDate.getHours();
        var hM = String(hDate.getMinutes()).padStart(2, '0');
        return hH + ':' + hM;
      }

      var rawStr = (raw === null || raw === undefined) ? '' : String(raw).trim();
      if (!rawStr) return '';

      var matchHM = rawStr.match(/(\d{1,2})\s*[:hH]\s*(\d{2})/);
      if (matchHM){
        var hh = parseInt(matchHM[1], 10);
        var mm = matchHM[2];
        if (!isNaN(hh)){
          return hh + ':' + mm;
        }
      }

      var numVal = Number(raw);
      if (isFinite(numVal)){
        var baseDate = new Date(1899, 11, 30);
        var millis = Math.round(numVal * 24 * 60 * 60 * 1000);
        var fromSerial = new Date(baseDate.getTime() + millis);
        if (!isNaN(fromSerial.getTime())){
          var sh = fromSerial.getHours();
          var sm = String(fromSerial.getMinutes()).padStart(2, '0');
          return sh + ':' + sm;
        }
      }

      var parsed = new Date(rawStr);
      if (!isNaN(parsed.getTime())){
        var dh = parsed.getHours();
        var dm = String(parsed.getMinutes()).padStart(2, '0');
        return dh + ':' + dm;
      }

      return rawStr;
    }

    // Regroupe toutes les valeurs nécessaires pour la carte et WhatsApp
    function getFieldValues(){
      var p = pedido || {};
      var c = p.cliente || baseCtx.cliente || {};

      var nombre =
        p.clienteNombre ||
        c.nombre ||
        baseCtx.clienteNombre ||
        'Cliente';

      var sector =
        p.sector ||
        c.sector ||
        baseCtx.sector ||
        '';

      var direccion =
        p.direccion ||
        c.direccion ||
        baseCtx.direccion ||
        '';

      var nota =
        p.nota ||
        c.nota ||
        baseCtx.nota ||
        '';

      var whatsappRaw =
        p.whatsapp ||
        c.whatsapp ||
        c.telefono ||
        baseCtx.whatsapp ||
        (baseCtx.cliente && (baseCtx.cliente.whatsapp || baseCtx.cliente.telefono)) ||
        '';

      var horaRaw =
        p.horaEntrega ||
        p.hora ||
        baseCtx.horaSeleccionada ||
        '';
      var hora = formatHoraEntrega(horaRaw);

      var fechaTexto =
        (baseCtx.fechaSeleccionada || p.fechaEntrega || '').toString();

      // Quantité
      var cantidad = parseCantidad(p.cantidad);
      if (!cantidad){
        cantidad = parseCantidad(baseCtx.cantidadSeleccionada);
      }

      // Total et prix unitaire
      var total = parseMoney(p.total || baseCtx.total);
      var unitPrice = parseMoney(p.precioUnitario);

      if (!total && unitPrice && cantidad){
        total = unitPrice * cantidad;
      }
      if (!unitPrice && total && cantidad){
        unitPrice = total / cantidad;
      }

      var cantidadTexto = cantidad + ' seco' + (cantidad === 1 ? '' : 's');

      return {
        pedidoId: p.pedidoId || baseCtx.pedidoId || '',
        nombre: nombre,
        sector: sector,
        direccion: direccion,
        nota: nota,
        whatsappRaw: (whatsappRaw || '').toString(),
        hora: hora,
        fechaTexto: fechaTexto,
        cantidad: cantidad,
        cantidadTexto: cantidadTexto,
        unitPrice: unitPrice,
        unitPriceTxt: formatMoneyText(unitPrice),
        total: total,
        totalTxt: formatMoneyText(total)
      };
    }

    function renderCard(){
      var f = getFieldValues();

      var pedidoIdEl     = document.getElementById('pedidoId');
      var horaEl         = document.getElementById('confirmHora');
      var sectorEl       = document.getElementById('confirmSector');
      var nombreEl       = document.getElementById('confirmNombre');
      var dirEl          = document.getElementById('confirmDireccion');
      var notaEl         = document.getElementById('confirmNota');
      var telEl          = document.getElementById('confirmWhatsapp');
      var precioEl       = document.getElementById('confirmPrecio');

      if (pedidoIdEl) pedidoIdEl.textContent = f.pedidoId || '';

      if (horaEl)   horaEl.textContent   = f.hora || '—';
      if (sectorEl) sectorEl.textContent = f.sector || '—';

      if (nombreEl) nombreEl.textContent = f.nombre || '—';

      if (dirEl) dirEl.textContent = f.direccion || '—';

      if (notaEl){
        if (f.nota){
          notaEl.textContent = 'Nota: ' + f.nota;
          notaEl.style.display = '';
        } else {
          notaEl.textContent = '';
          notaEl.style.display = 'none';
        }
      }

      if (telEl){
        var digits = (f.whatsappRaw || '').replace(/\D+/g, '');
        // On met uniquement le numéro; l’icône sera gérée en CSS
        telEl.textContent = digits ? digits : '—';
      }

      if (precioEl){
        // [quantité] x [prix unitaire] = [prix total]
        precioEl.textContent =
          f.cantidadTexto + ' x ' + f.unitPriceTxt + ' = ' + f.totalTxt;
      }
    }

    function buildWhatsappUrlFromFields(f){
      var digits = (f.whatsappRaw || '').replace(/\D+/g, '');
      if (!digits) return null;

      var lines = [];

      // début du message
      lines.push('*Tu pedido SecoMóvil*');
      lines.push('');
      lines.push(f.nombre || 'Cliente');             // [Nom]
      lines.push(f.cantidadTexto || '');             // [quantité]
      lines.push(f.fechaTexto || '');                // [date]
      lines.push(f.hora ? ('A las ' + f.hora) : ''); // A las [heure]
      lines.push(f.direccion || '');                 // [direccion]
      lines.push('Sector: ' + (f.sector || ''));     // Sector: [sector]
      if (f.nota){
        lines.push('Nota: ' + f.nota);               // Nota: [nota]
      }
      lines.push('');
      lines.push('Total: ' + f.totalTxt);            // Total: [total]
      lines.push('');
      lines.push('SecoMóvil te agradece');
      // fin du message

      // Nettoie les vides de fin
      while (lines.length && lines[lines.length - 1] === '') {
        lines.pop();
      }

      var text = encodeURIComponent(lines.join('\n'));
      return 'https://wa.me/' + digits + '?text=' + text;
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      renderCard();

      var chkEnviar = document.getElementById('chkEnviarWhatsapp');
      var btnOk = document.getElementById('btnOk') || document.querySelector('.btn-noir');

      if (btnOk){
        btnOk.addEventListener('click', function(){
          // Spinner sur le bouton noir
          window.secoSetBlackButtonLoading(btnOk, true);

          var f = getFieldValues();

          // Envoi WhatsApp seulement si la case est cochée
          if (!chkEnviar || chkEnviar.checked){
            var url = buildWhatsappUrlFromFields(f);
            if (url){
              window.open(url, '_blank');
            }
          }

          // Retour à l’accueil
          loadPage('inicio', function(){
            window.secoSetBlackButtonLoading(btnOk, false);
          });
        });
      }
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  pedidoActualizado: function() {
    pageInit.pedidoRegistrado();
  },





// =====================
//  VENTA DIRECTA (SPA)
// =====================
ventaDirecta: function() {
  var precioFormatTimer = null;

  function applyScaleFix(){
    var cssW = window.innerWidth || document.documentElement.clientWidth;
    var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
    if (cssW >= 960 && cssW <= 1024) {
      var fix = (980 / screenW) * 1.50;
      document.documentElement.style.setProperty('--fix', fix.toFixed(3));
    } else {
      document.documentElement.style.setProperty('--fix', '1');
    }
  }

  function sizeHeaderImage(){
    var img = document.getElementById('headerImg');
    var wrap = document.querySelector('.wrapper');
    if (!img || !wrap) return;
    var w = Math.floor(wrap.clientWidth);
    if (w > 0){
      img.style.width = w + 'px';
      img.style.maxWidth = '100%';
      img.removeAttribute('height');
    }
  }

  function parseMoney(raw){
    if (typeof raw === 'number' && isFinite(raw)) return raw;
    if (!raw) return 0;
    var s = String(raw).trim();
    s = s.replace(/[^0-9.,-]/g, '');
    s = s.replace(',', '.');
    var n = Number(s);
    return isNaN(n) ? 0 : n;
  }

  function formatMoney(n){
    n = parseMoney(n);
    return n.toFixed(2).replace('.', ',') + ' $';
  }

  function seedCantidadDropdown(){
    var dropdown = document.querySelector('.dropdown[data-name="cantidad"]');
    var dataEl = dropdown ? dropdown.querySelector('.dd-data') : null;
    if (!dataEl) return;

    var opciones = [];
    for (var i = 1; i <= 10; i++){
      opciones.push(i + ' seco' + (i === 1 ? '' : 's'));
    }

    var json = JSON.stringify(opciones);
    dataEl.textContent = json;
    dataEl.setAttribute('data-options', json);

    var lbl = dropdown.querySelector('.dd-label');
    var btn = dropdown.querySelector('.dd-button');
    if (lbl && opciones.length){
      lbl.textContent = opciones[0];
    }
    if (btn){
      btn.removeAttribute('data-placeholder');
    }
    dropdown.dataset.value = opciones[0] || '';
  }

  function getDropdownOptions(dd){
    var dataEl = dd ? dd.querySelector('.dd-data') : null;
    if (!dataEl) return [];
    var raw = dataEl.getAttribute('data-options') || dataEl.textContent || '[]';
    try {
      return JSON.parse(raw);
    } catch (err){
      return [];
    }
  }

  function initDropdowns(){
    var overlay = document.getElementById('ddOverlay');
    var overlayList = document.getElementById('ddOverlayList');
    var currentDropdown = null;

    function closeOverlay(){
      if (!overlay) return;
      overlay.setAttribute('data-open','false');
      overlay.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      currentDropdown = null;
    }

    function selectOption(dd, labelEl, btnEl, value){
      if (labelEl){
        labelEl.textContent = value;
      }
      if (btnEl){
        btnEl.removeAttribute('data-placeholder');
      }
      if (dd){
        dd.dataset.value = value;
      }
      closeOverlay();
      updateTotalAndButton();
    }

    function openOverlay(dd){
      if (!overlay || !overlayList || !dd) return;

      currentDropdown = dd;
      overlayList.innerHTML = '';

      var label = dd.querySelector('.dd-label');
      var btn = dd.querySelector('.dd-button');
      var options = getDropdownOptions(dd);
      var currentValue = (dd.dataset.value || (label && label.textContent) || '').trim();

      options.forEach(function(opt){
        var li = document.createElement('li');
        li.className = 'dd-overlay-option';
        li.setAttribute('role','option');
        li.setAttribute('aria-selected', currentValue === opt ? 'true' : 'false');
        li.textContent = opt;
        li.onclick = function(){ selectOption(dd, label, btn, opt); };
        overlayList.appendChild(li);
      });

      overlay.setAttribute('data-open','true');
      overlay.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }

    document.querySelectorAll('.dropdown').forEach(function(dd){
      var btn = dd.querySelector('.dd-button');
      if (!btn) return;

      if (!dd.dataset.value){
        var lbl = dd.querySelector('.dd-label');
        var baseVal = (lbl && lbl.textContent) ? lbl.textContent.trim() : '';
        if (baseVal){
          dd.dataset.value = baseVal;
        }
      }

      btn.addEventListener('click', function(){ openOverlay(dd); });
      btn.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          openOverlay(dd);
        }
      });
    });

    if (overlay){
      overlay.addEventListener('click', function(e){
        if (e.target === overlay){
          closeOverlay();
        }
      });
    }

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && overlay && overlay.getAttribute('data-open') === 'true'){
        closeOverlay();
      }
    });
  }

  function getCantidad(){
    var dd = document.querySelector('.dropdown[data-name="cantidad"]');
    if (!dd) return 0;
    var txt = dd.dataset.value || '';
    if (!txt){
      var lbl = dd.querySelector('.dd-label');
      txt = (lbl && lbl.textContent) ? lbl.textContent : '';
    }
    var m = txt.trim().match(/^(\d+)/);
    if (!m) return 0;
    var n = parseInt(m[1], 10);
    return isNaN(n) ? 0 : n;
  }

  function getPrecio(){
    var input = document.getElementById('precio');
    if (!input) return 0;
    return parseMoney(input.value);
  }

  function updateTotalAndButton(){
    var totalRow = document.getElementById('ventaTotalRow');
    var btnRegistrar = document.getElementById('btnRegistrarVenta');

    var cantidad = getCantidad();
    var precio = getPrecio();
    var valido = cantidad > 0 && precio > 0;
    var total = valido ? cantidad * precio : 0;

    if (totalRow){
      totalRow.innerHTML = 'Total a cancelar = <strong>' + formatMoney(total) + '</strong>';
    }

    if (btnRegistrar){
      if (valido){
        btnRegistrar.disabled = false;
        btnRegistrar.classList.remove('btn-desactive');
      } else {
        btnRegistrar.disabled = true;
        if (!btnRegistrar.classList.contains('btn-desactive')){
          btnRegistrar.classList.add('btn-desactive');
        }
      }
    }
  }

  function initVentaId(){
    var headerEl = document.getElementById('ventaIdHeader');
    if (!google || !google.script || !google.script.run) return;

    google.script.run
      .withSuccessHandler(function(resp){
        if (!headerEl) return;
        if (resp && resp.ok && resp.data && resp.data.idVenta){
          headerEl.textContent = resp.data.idVenta;
        } else {
          headerEl.textContent = '';
        }
      })
      .withFailureHandler(function(){
        if (headerEl){
          headerEl.textContent = '';
        }
      })
      .initVentaDirecta();
  }

  function init(){
    applyScaleFix();
    sizeHeaderImage();
    seedCantidadDropdown();
    initDropdowns();

    initVentaId();
    updateTotalAndButton();

    var inputPrecio = document.getElementById('precio');
    var btnRegistrar = document.getElementById('btnRegistrarVenta');
    var btnVolver = document.getElementById('btnVolverInicioVenta');

    if (inputPrecio){
      inputPrecio.addEventListener('input', function(){
        // MAJ instantanée du total
        updateTotalAndButton();

        // Formatage retardé (1,5 seconde d'inactivité)
        if (precioFormatTimer){
          clearTimeout(precioFormatTimer);
        }
        precioFormatTimer = setTimeout(function(){
          var v = getPrecio();
          if (v > 0){
            inputPrecio.value = formatMoney(v);
          }
        }, 1500);
      });
    }

    if (btnRegistrar){
      btnRegistrar.addEventListener('click', function(){
        if (btnRegistrar.disabled) return;

        if (window.secoSetBlackButtonLoading){
          window.secoSetBlackButtonLoading(btnRegistrar, true);
        }

        var payload = {
          fecha: null,                 // hoy por defecto (según contrato)
          cantidad: getCantidad(),
          precio: getPrecio(),
          notas: ''
        };

        google.script.run
          .withSuccessHandler(function(resp){
            if (resp && resp.ok && resp.data && resp.data.venta){
              // Contexte pour ventaRegistrada
              window.SECO_CTX = { venta: resp.data.venta };
              // On NE coupe PAS le spinner ici : la page change, le bouton disparaît.
              loadPage('ventaRegistrada');
            } else {
              if (window.secoSetBlackButtonLoading){
                window.secoSetBlackButtonLoading(btnRegistrar, false);
              }
              if (window.alert){
                var msg = (resp && resp.error) ? resp.error : 'Error al registrar la venta.';
                alert(msg);
              }
            }
          })
          .withFailureHandler(function(){
            if (window.secoSetBlackButtonLoading){
              window.secoSetBlackButtonLoading(btnRegistrar, false);
            }
            if (window.alert){
              alert('Error al registrar la venta.');
            }
          })
          .registrarVentaDirecta(payload);
      });
    }

  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  window.addEventListener('resize', function(){
    applyScaleFix();
    sizeHeaderImage();
  });
},






      

// =========================
//  VENTA REGISTRADA (SPA)
// =========================
ventaRegistrada: function() {
  var baseCtx = window.SECO_CTX || {};
  var venta = baseCtx.venta || baseCtx || {};

  function applyScaleFix(){
    var cssW = window.innerWidth || document.documentElement.clientWidth;
    var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
    if (cssW >= 960 && cssW <= 1024) {
      var fix = (980 / screenW) * 1.50;
      document.documentElement.style.setProperty('--fix', fix.toFixed(3));
    } else {
      document.documentElement.style.setProperty('--fix', '1');
    }
  }

  function sizeHeaderImage(){
    var img = document.getElementById('headerImg');
    var wrap = document.querySelector('.wrapper');
    if (!img || !wrap) return;
    var w = Math.floor(wrap.clientWidth);
    if (w > 0){
      img.style.width = w + 'px';
      img.style.maxWidth = '100%';
      img.removeAttribute('height');
    }
  }

  function parseMoney(raw){
    if (typeof raw === 'number' && isFinite(raw)) return raw;
    if (!raw) return 0;
    var s = String(raw).trim();
    s = s.replace(/[^0-9.,-]/g, '');
    s = s.replace(',', '.');
    var n = Number(s);
    return isNaN(n) ? 0 : n;
  }

  function formatMoney(n){
    n = parseMoney(n);
    return n.toFixed(2).replace('.', ',') + ' $';
  }

  function buildResumen(){
    var cantidad = Number(venta.cantidad || 0);
    if (!isFinite(cantidad) || cantidad < 0) cantidad = 0;

    var label = cantidad + ' seco' + (cantidad === 1 ? '' : 's');
    var unitTxt = formatMoney(venta.precioUnitario || 0);
    var totalTxt = formatMoney(venta.total || 0);

    return label + ' x ' + unitTxt + ' = <strong>' + totalTxt + '</strong>';
  }

  function renderCard(){
    var idEl = document.getElementById('ventaId');
    var resumenEl = document.getElementById('confirmResumen');

    if (idEl){
      idEl.textContent = venta.idVenta || '';
    }
    if (resumenEl){
      resumenEl.innerHTML = buildResumen();
    }
  }

  function init(){
    applyScaleFix();
    sizeHeaderImage();
    renderCard();

    var btnOk = document.getElementById('btnOk');
    if (btnOk){
      btnOk.addEventListener('click', function(){
        if (window.secoSetBlackButtonLoading){
          window.secoSetBlackButtonLoading(btnOk, true);
        }
        loadPage('inicio', function(){
          if (window.secoSetBlackButtonLoading){
            window.secoSetBlackButtonLoading(btnOk, false);
          }
        });
      });
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  window.addEventListener('resize', function(){
    applyScaleFix();
    sizeHeaderImage();
  });
},




  cerrarElDia: function(){
    function applyScaleFix(){
      var cssW = window.innerWidth;
      var screenW = Math.min(window.screen.width, window.screen.height);
      if (cssW >= 960 && cssW <= 1024){
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix','1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (img && wrapper){
        var avail = Math.floor(wrapper.clientWidth);
        img.style.width = avail + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    function setupConfirm(){
      var chk = document.getElementById('chkConfirm');
      var btn = document.getElementById('btnCerrar');

      function sync(){
        if (chk && chk.checked){
          btn.disabled = false;
          btn.classList.remove('btn-desactive');
          btn.classList.add('btn-noir');
        } else if (btn){
          btn.disabled = true;
          btn.classList.remove('btn-noir');
          btn.classList.add('btn-desactive');
        }
      }

      if (chk){
        chk.addEventListener('change', sync);
      }
      if (btn){
        sync();
      }
    }

    var btnCerrar = document.getElementById('btnCerrar');
    var btnVolver = document.querySelector('.btn.btn-blanc');

    if (btnCerrar){
      btnCerrar.addEventListener('click', function(){
        if (btnCerrar.disabled) return;
        window.secoSetBlackButtonLoading(btnCerrar, true);
        loadPage('diaCerrado');
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      setupConfirm();
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  diaCerrado: function(){
    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var avail = Math.floor(wrapper.clientWidth);
      img.style.width = avail + 'px';
      img.style.maxWidth = '100%';
      img.removeAttribute('height');
    }

    var btnOk = document.querySelector('.btn-noir');
    if (btnOk){
      btnOk.addEventListener('click', function(){
        window.secoSetBlackButtonLoading(btnOk, true);
        loadPage('inicio');
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  configuracionDelSistema: function(){
    function applyScaleFix(){
      var cssW = window.innerWidth;
      var screenW = Math.min(window.screen.width, window.screen.height);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.5;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix','1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var w = Math.floor(wrapper.clientWidth);
      img.style.width = w + 'px';
      img.style.maxWidth = '100%';
    }

    var overlay = document.getElementById('ddOverlay');
    var overlayList = document.getElementById('ddOverlayList');
    var chk = document.getElementById('chkConfirm');
    var btnConfigurar = document.getElementById('btnConfigurar');
    var btnVolver = document.querySelector('.btn.btn-blanc');
    var currentDropdown = null;

    function getOptionsFromDropdown(drop){
      var dataEl = drop ? drop.querySelector('.dd-data') : null;
      if (!dataEl) return [];
      var raw = dataEl.getAttribute('data-options') || '[]';
      try {
        return JSON.parse(raw);
      } catch (err) {
        return [];
      }
    }

    function closeOverlay(){
      if (!overlay) return;
      overlay.setAttribute('data-open','false');
      document.body.style.overflow='';
      currentDropdown=null;
    }

    function openOverlay(drop){
      if (!overlay || !overlayList || !drop) return;
      currentDropdown = drop;
      overlayList.innerHTML = "";

      var label = drop.querySelector('.dd-label');
      var data = getOptionsFromDropdown(drop);

      if (label){
        var ph = label.textContent.trim();
        var liPh = document.createElement('li');
        liPh.className = 'dd-overlay-option placeholder';
        liPh.textContent = ph;
        liPh.onclick = function(){ closeOverlay(); };
        overlayList.appendChild(liPh);
      }

      data.forEach(function(t){
        var li = document.createElement('li');
        li.className = 'dd-overlay-option';
        li.textContent = t;
        li.onclick = function(){
          if (label){
            label.textContent = t;
          }
          closeOverlay();
        };
        overlayList.appendChild(li);
      });

      overlay.setAttribute('data-open','true');
      document.body.style.overflow='hidden';
    }

    function initDropdowns(){
      document.querySelectorAll('.dropdown').forEach(function(dd){
        var btn = dd.querySelector('.dd-button');
        if (btn){
          btn.onclick = function(){ openOverlay(dd); };
        }
      });
      if (overlay){
        overlay.onclick = function(e){
          if(e.target===overlay) closeOverlay();
        };
      }
    }

    function setupConfirmToggle(){
      if (!chk || !btnConfigurar) return;
      function sync(){
        if(chk.checked){
          btnConfigurar.disabled=false;
          btnConfigurar.classList.remove('btn-desactive');
          btnConfigurar.classList.add('btn-noir');
        } else{
          btnConfigurar.disabled=true;
          btnConfigurar.classList.remove('btn-noir');
          btnConfigurar.classList.add('btn-desactive');
        }
      }
      chk.onchange=sync;
      sync();
    }

    if (btnConfigurar){
      btnConfigurar.addEventListener('click', function(){
        if (btnConfigurar.disabled) return;
        window.secoSetBlackButtonLoading(btnConfigurar, true);
        loadPage('sistemaConfigurado');
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      initDropdowns();
      setupConfirmToggle();
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded',init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  },

  sistemaConfigurado: function(){
    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var avail = Math.floor(wrapper.clientWidth);
      img.style.width = avail + 'px';
      img.style.maxWidth = '100%';
      img.removeAttribute('height');
    }

    var btnOk = document.querySelector('.btn-noir');
    if (btnOk){
      btnOk.addEventListener('click', function(){
        window.secoSetBlackButtonLoading(btnOk, true);
        loadPage('inicio');
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  }
    };

    function loadPage(pageName, onLoaded){
      google.script.run
        .withSuccessHandler(function(html){
          const app = document.getElementById('app');
          if (app) {
            resetVolverInicioHooks(pageName);
            app.innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'instant' });
            bindVolverInicioButtons();
            if (pageInit[pageName]) {
              pageInit[pageName]();
            }
          }
          if (typeof onLoaded === 'function') onLoaded();
        })
        .withFailureHandler(function(){
          if (typeof onLoaded === 'function') onLoaded();
        })
        .getPage(pageName);
    }

    document.addEventListener('DOMContentLoaded', function(){
      loadPage('inicio');
    });
  </script>
</body>
</html>
