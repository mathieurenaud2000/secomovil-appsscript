<!-- nuevoContacto.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, shrink-to-fit=no">
  <title>SecoMobil – Nuevo contacto</title>
  <style>
    :root{
      --fix: 1;
      --gap: 12px;
      --radius: 40px;
      --font-label: 12px;
      --font-small: 14px;
      --font-body: 15px;
      --btn-fs: 16px;
      --btn-ph: 14px;
      --btn-pw: 18px;
      --btn-minh: 48px;
      --black: #000;
      --white: #fff;
      --gray10: rgba(0,0,0,0.10);
      --gray20: rgba(0,0,0,0.20);
      --gray25: rgba(0,0,0,0.25);
    }

    html, body{
      margin:0; padding:0;
      width:100%; max-width:100%;
      overflow-x:hidden; box-sizing:border-box;
      background:#fff;
      font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }
    *, *::before, *::after{ box-sizing:inherit; }
    *:focus{ outline:none!important; box-shadow:none!important; }

    .wrapper{ padding: 0 50px; }

    .sep-black{ height:0; border-top: 5px solid var(--black); }
    .sep-gray { height:0; border-top: 2px solid var(--gray20); }

    /* ===== HEADER ===== */
    .header{ display:block; margin: calc(var(--gap) * var(--fix)) 0; }
    .header-logo{ display:block; width:100%; line-height:0; margin:0; }
    .header-img{
      display:block; width:100%; height:auto;
      object-fit:contain; object-position:left center;
      margin:0 8px 15px 0;
      padding-bottom:30px;
    }

    .header-grid{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:end;
      padding: calc(12px * var(--fix)) 0;
    }
    .header-title{
      text-transform: uppercase; font-weight: 900;
      font-size: calc(21px * var(--fix));
      line-height: calc(20px * var(--fix));
    }
    .header-title span{ display:block; }

    .header-id{
      text-align:right;
      font-size: calc(10px * var(--fix));
      color:#111;
      white-space:nowrap;
    }
    .pedido-id-loader{
      display:inline-flex;
      align-items:flex-end;
      justify-content:flex-end;
      gap: calc(3px * var(--fix));
      min-width: calc(64px * var(--fix));
      height: calc(12px * var(--fix));
    }
    .pedido-id-loader .dot{
      width: calc(5px * var(--fix));
      height: calc(5px * var(--fix));
      border-radius:50%;
      background:#111;
      opacity:0.3;
      animation: pedidoIdPulse 1s infinite ease-in-out;
    }
    .pedido-id-loader .dot:nth-child(2){ animation-delay:0.15s; }
    .pedido-id-loader .dot:nth-child(3){ animation-delay:0.30s; }

    @keyframes pedidoIdPulse{
      0%, 80%, 100%{ opacity:0.25; transform: translateY(0); }
      40%{ opacity:0.8; transform: translateY(-1px); }
    }

    /* ===== CONTENU ===== */
    .stack{
      display:flex;
      flex-direction:column;
      gap: calc(var(--gap) * var(--fix));
    }

    .label{
      font-size: calc(var(--font-label) * var(--fix));
      color:#111;
    }

    /* label collé au champ suivant */
    .label + .field,
    .label + .dropdown{
      margin-top: calc((-1 * var(--gap) / 2) * var(--fix));
    }

    /* CHAMPS TEXTE */
    .field{
      width:100%;
      background:#fff;
      color:#000;
      border:5px solid var(--black);
      border-radius: var(--radius);
      font-size: calc(var(--font-body) * var(--fix));
      line-height:1.3;
      padding: calc(10px * var(--fix)) calc(12px * var(--fix));
    }
    .field::placeholder{ color: var(--gray25); }
    textarea.field{
      min-height: calc(1.0em * var(--fix));  /* hauteur 2 lignes divisée par 2 */
      resize: vertical;
    }

    /* DROPDOWN ENCADRÉ (mêmes styles que registrarGasto) */
    .dropdown{
      position:relative; width:100%;
      font-size: calc(var(--font-body) * var(--fix));
    }
    .dropdown[data-variant="boxed"] .dd-button{
      border: 5px solid var(--black);
      border-radius: var(--radius);
      background:#fff; color:#000;
      padding: calc(10px * var(--fix)) calc(36px * var(--fix)) calc(10px * var(--fix)) calc(10px * var(--fix));
    }

    .dd-button{
      width:100%; text-align:left; position:relative; cursor:pointer;
      line-height:1.3; font-size: inherit;
    }
    .dd-button[data-placeholder="true"] .dd-label{ color: var(--gray25); }
    .dd-label{ display:block; padding-right: calc(18px * var(--fix)); }
    .dd-caret{
      position:absolute; right: calc(16px * var(--fix)); top:50%; transform: translateY(-50%);
      width:0; height:0; pointer-events:none;
      border-left: calc(6px * var(--fix)) solid transparent;
      border-right: calc(6px * var(--fix)) solid transparent;
      border-top: calc(6px * var(--fix)) solid #000;
    }

    /* OVERLAY LISTE */
    .dd-overlay{
      position:fixed; inset:0; background:#fff; display:none; z-index:1000;
      overflow:auto;
    }
    .dd-overlay[data-open="true"]{ display:block; }
    .dd-overlay-list{
      list-style:none; margin:0; padding:0;
      font-size: calc(var(--font-body) * var(--fix));
    }
    .dd-overlay-option{
      padding: calc(12px * var(--fix)) calc(10px * var(--fix));
      border-bottom:2px solid var(--gray20);
      line-height:1.25; cursor:pointer;
    }

    /* BOUTONS */
    .btn{
      display:block; width:100%;
      text-transform:uppercase; font-weight:700;
      font-size: calc(var(--btn-fs) * var(--fix));
      padding: calc(var(--btn-ph) * var(--fix)) calc(var(--btn-pw) * var(--fix));
      min-height: calc(var(--btn-minh) * var(--fix));
      border-radius: var(--radius);
      border:5px solid transparent;
      transition:0.15s ease;
    }
    .btn-noir{
      background:#000; color:#fff; border-color:#000;
      box-shadow:0 20px 40px rgba(0,0,0,0.40);
    }
    .btn-desactive{
      background: var(--gray10);
      color:#fff;
      border:0;
      box-shadow:none;
      cursor:default;
    }
    .btn-blanc{
      background:#fff; color:#000; border-color: var(--gray20);
    }

    .error-text{
      color: #b00020;
      font-size: calc(11px * var(--fix));
      margin-top: calc((-4px) * var(--fix));
    }
  </style>
</head>
<body>
  <div class="wrapper">

    <!-- HEADER -->
    <header class="header">
      <div class="header-logo">
        <img class="header-img" id="headerImg"
             src="https://lh3.googleusercontent.com/d/15N5N0TgMBTxmn2v-sKsG53mEAKaxXYtA"
             alt="Logo SecoMobil">
      </div>

      <div class="sep-black"></div>

      <div class="header-grid">
        <div class="header-title">
          <span>NUEVO</span>
          <span>CONTACTO</span>
        </div>
        <div class="header-id" id="contactoId">
          <span class="pedido-id-loader" aria-label="Cargando ID" role="status">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </span>
        </div>
      </div>

      <div class="sep-black"></div>
    </header>

    <!-- CONTENU -->
    <div class="stack">

      <!-- Nombre -->
      <div class="label">Nombre</div>
      <input class="field" type="text" id="nombre" placeholder="">

      <!-- Sector -->
      <div class="label">Sector</div>
      <div class="dropdown" data-variant="boxed">
        <button type="button" class="dd-button" id="sectorBtn" data-placeholder="true">
          <span class="dd-label">Elegir un sector</span><span class="dd-caret" aria-hidden="true"></span>
        </button>
        <script type="application/json" class="dd-data">[]</script>
      </div>

      <!-- Direccion -->
      <div class="label">Direccion</div>
      <textarea class="field" id="direccion"></textarea>

      <!-- Nota (opcional) -->
      <div class="label">
        Nota <span style="color: var(--gray25);">(opcional)</span>
      </div>
      <textarea class="field" id="nota"></textarea>

      <!-- WhatsApp -->
      <div class="label">WhatsApp</div>
      <input class="field" type="text" id="whatsapp" placeholder="">
      <div class="error-text" id="whatsappError" aria-live="polite"></div>

      <div class="sep-gray"></div>

      <!-- Boutons -->
      <button class="btn btn-desactive" id="btnGuardar" disabled>GUARDAR</button>
      <button class="btn btn-blanc" id="btnVolverInicio">VOLVER AL INICIO</button>

      <div style="height:0;"></div>
    </div>
  </div>

  <!-- OVERLAY DROPDOWN -->
  <div class="dd-overlay" id="ddOverlay">
    <ul class="dd-overlay-list" id="ddOverlayList"></ul>
  </div>

  <script>
    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrap = document.querySelector('.wrapper');
      if (!img || !wrap) return;
      var w = Math.floor(wrap.clientWidth);
      if (w > 0){
        img.style.width = w + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    /* Références des champs pour la validation */
    var overlay      = document.getElementById('ddOverlay');
    var overlayList  = document.getElementById('ddOverlayList');
    var sectorBtn    = document.getElementById('sectorBtn');
    var btnGuardar   = document.getElementById('btnGuardar');
    var btnVolverIni = document.getElementById('btnVolverInicio');

    var nombreEl   = document.getElementById('nombre');
    var dirEl      = document.getElementById('direccion');
    var notaEl     = document.getElementById('nota');
    var whatsappEl = document.getElementById('whatsapp');

    function obtenerCtxServidor(){
      return (typeof window !== 'undefined' && window.SECO_CTX) ? window.SECO_CTX : {};
    }

    function setContactoIdDesdeCtx(){
      var idEl = document.getElementById('contactoId');
      if (!idEl) return;
      var ctx = obtenerCtxServidor();
      var idContacto = (ctx && ctx.idContacto) ? ctx.idContacto : '';
      if (idContacto){
        idEl.textContent = idContacto;
      }
    }

    function esWhatsappValido(valor){
      var limpio = (valor || '').toString().trim();
      return /^\d{7,15}$/.test(limpio);
    }

    function validarWhatsappCampo(){
      var errorEl = document.getElementById('whatsappError');
      if (!errorEl) return esWhatsappValido(whatsappEl.value);

      var valor = (whatsappEl.value || '').toString().trim();
      if (!valor){
        errorEl.textContent = '';
        return false;
      }

      var valido = esWhatsappValido(valor);
      errorEl.textContent = valido ? '' : 'Número de WhatsApp inválido';
      return valido;
    }

    function champsRemplis(){
      var nomOK    = nombreEl.value.trim()   !== '';
      var dirOK    = dirEl.value.trim()      !== '';
      var waOK     = esWhatsappValido(whatsappEl.value);
      var sectorOK = !sectorBtn.hasAttribute('data-placeholder');
      // Nota est optionnel → non pris en compte
      return nomOK && dirOK && waOK && sectorOK;
    }

    function majBoutonGuardar(){
      var waValido = validarWhatsappCampo();
      if (champsRemplis() && waValido){
        btnGuardar.disabled = false;
        btnGuardar.classList.remove('btn-desactive');
        btnGuardar.classList.add('btn-noir');
      } else {
        btnGuardar.disabled = true;
        btnGuardar.classList.remove('btn-noir');
        btnGuardar.classList.add('btn-desactive');
      }
    }

    function obtenerSectoresDesdeCtx(){
      var ctx = obtenerCtxServidor();
      var sectores = Array.isArray(ctx.sectores) ? ctx.sectores : [];
      return sectores.map(function(sec){ return (sec && sec.nombre) ? sec.nombre : sec; }).filter(Boolean);
    }

    /* Dropdown simple pour "Sector" */
    function openSectorDropdown(){
      var data = obtenerSectoresDesdeCtx();
      overlayList.innerHTML = "";

      data.forEach(function(txt){
        var li = document.createElement('li');
        li.className = "dd-overlay-option";
        li.textContent = txt;
        li.addEventListener('click', function(){
          sectorBtn.querySelector('.dd-label').textContent = txt;
          sectorBtn.removeAttribute('data-placeholder');
          overlay.setAttribute('data-open','false');
          document.body.style.overflow = '';
          majBoutonGuardar();
        });
        overlayList.appendChild(li);
      });

      overlay.setAttribute('data-open','true');
      document.body.style.overflow = 'hidden';
    }

    sectorBtn.addEventListener('click', openSectorDropdown);

    overlay.addEventListener('click', function(e){
      if (e.target === overlay){
        overlay.setAttribute('data-open','false');
        document.body.style.overflow = '';
      }
    });

    /* Écouteurs sur les champs pour activer/désactiver GUARDAR */
    ['input','change'].forEach(function(ev){
      nombreEl.addEventListener(ev, majBoutonGuardar);
      dirEl.addEventListener(ev, majBoutonGuardar);
      // notaEl est optionnel → pas nécessaire dans la logique d'activation
      whatsappEl.addEventListener(ev, majBoutonGuardar);
    });

    /* Clic sur GUARDAR : créer le client puis ouvrir registrarPedido */
    btnGuardar.addEventListener('click', function(){
      if (btnGuardar.disabled) return;

      var whatsappValido = validarWhatsappCampo();
      if (!whatsappValido){
        whatsappEl.focus();
        return;
      }

      var sectorText = sectorBtn.querySelector('.dd-label')
        ? sectorBtn.querySelector('.dd-label').textContent.trim()
        : '';

      var ctxActual = obtenerCtxServidor();

      var datosCliente = {
        idContacto: (ctxActual && ctxActual.idContacto) ? ctxActual.idContacto : '',
        pedidoId:   (ctxActual && ctxActual.pedidoId) ? ctxActual.pedidoId : '',
        nombre:    nombreEl.value.trim(),
        direccion: dirEl.value.trim(),
        telefono:  whatsappEl.value.trim(),
        sector:    sectorText,
        nota:      notaEl.value.trim()
      };

      google.script.run
        .withSuccessHandler(function(resp){
          if (!resp || (!resp.ok && !resp.success) || !resp.data || !resp.data.cliente){
            var msg = (resp && resp.error) ? resp.error : 'Error al crear el cliente.';
            alert(msg);
            return;
          }

          var cliente = resp.data.cliente; // { idCliente, nombre, telefono, direccion, sector, nota }

          var ctxNuevoPedido = obtenerCtxServidor();

          var payload = {
            origen: 'nuevoContacto',
            pedidoId: (resp.data && resp.data.pedidoId) ? resp.data.pedidoId : (ctxNuevoPedido.pedidoId || ''),
            idContacto: (resp.data && resp.data.idContacto) ? resp.data.idContacto : (ctxNuevoPedido.idContacto || ''),
            clienteNombre: (resp.data && resp.data.clienteNombre) ? resp.data.clienteNombre : (cliente.nombre || ''),
            cliente: cliente
          };

          google.script.run.abrirRegistrarPedido(payload);
        })
        .registrarNuevoContacto(datosCliente, ctxActual);
    });

    /* Clic sur VOLVER AL INICIO : reset + abrirInicio() */
    btnVolverIni.addEventListener('click', function(){
      // Effacer les champs
      nombreEl.value   = '';
      dirEl.value      = '';
      notaEl.value     = '';
      whatsappEl.value = '';

      // Réinitialiser le dropdown Sector
      sectorBtn.setAttribute('data-placeholder', 'true');
      var lbl = sectorBtn.querySelector('.dd-label');
      if (lbl){
        lbl.textContent = 'Elegir un sector';
      }

      majBoutonGuardar();

      // Ouvrir la page inicio.html côté serveur
      google.script.run.abrirInicio();
    });

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      setContactoIdDesdeCtx();
      majBoutonGuardar();
    }
    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  </script>
</body>
</html>
