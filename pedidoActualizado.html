<style>
    :root{
      --fix: 1;
      --gap: 12px;
      --radius: 40px;
      --font-label: 12px;
      --font-small: 14px;
      --font-body: 15px;
      --btn-fs: 16px;
      --btn-ph: 14px;
      --btn-pw: 18px;
      --btn-minh: 48px;
      --black: #000;
      --white: #fff;
      --gray10: rgba(0,0,0,0.10);
      --gray20: rgba(0,0,0,0.20);
      --gray25: rgba(0,0,0,0.25);
    }

    html, body{
      margin:0; padding:0;
      width:100%; max-width:100%;
      overflow-x:hidden; box-sizing:border-box;
      background:#fff;
      font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }
    *, *::before, *::after{ box-sizing:inherit; }
    *:focus{ outline:none!important; box-shadow:none!important; }

    .wrapper{ padding: 0 50px; }

    /* ===== ENTÊTE ===== */
    .header{ display:block; margin: calc(var(--gap) * var(--fix)) 0 0 0; }
    .header-logo{ display:block; width:100%; line-height:0; margin:0; }
    .header-img{
      display:block; width:100%; height:auto;
      object-fit:contain; object-position:left center;
      margin:0 8px 15px 0;
      padding-bottom:30px;
    }

    .sep-black{ height:0; border-top: 5px solid var(--black); }
    .sep-gray { height:0; border-top: 2px solid var(--gray20); }

    .header-grid{
      display:grid; grid-template-columns: 1fr;
      align-items:end;
      gap: calc(8px * var(--fix));
      padding: calc(12px * var(--fix)) 0 calc(12px * var(--fix)) 0;
    }
    .header-title{
      text-transform: uppercase; font-weight: 900;
      font-size: calc(21px * var(--fix));
      line-height: calc(20px * var(--fix));
    }
    .header-title span{ display:block; }
    .header-id{
      font-size: calc(10px * var(--fix));
      font-weight:700;
      text-transform:uppercase;
      margin-top: calc(4px * var(--fix));
      display:none;
    }

    /* ===== CONTENU ===== */
    .stack{
      display:flex;
      flex-direction:column;
      gap: calc(var(--gap) * var(--fix));
    }

    .txt-body  { font-size: calc(var(--font-body) * var(--fix)); font-weight:500; color:#111; }

    /* ===== CARTE ===== */
    .confirm-card{
      border-radius: var(--radius);
      border:5px solid var(--gray20);
      background:#fff;
      padding: calc(15px * var(--fix));
      display:flex;
      flex-direction:column;
    }
    .confirm-icon{
      text-align:center;
      margin-bottom: calc(14px * var(--fix));
    }
    .confirm-icon img{
      display:inline-block;
      width: calc(80px * var(--fix));
      height:auto;
      object-fit:contain;
    }
    .confirm-info{
      display:flex;
      flex-direction:column;
      gap: calc(4px * var(--fix));
    }

    .confirm-line-time{
      font-size: calc(var(--font-label) * var(--fix));
      font-weight:500;
      color:#111;
    }
    .confirm-line-time span + span{
      margin-left: calc(10px * var(--fix));
    }

    .confirm-name{
      font-weight:700;
      text-transform:uppercase;
      font-size: calc(var(--font-small) * var(--fix));
      margin-top: calc(4px * var(--fix));
    }

    .confirm-text{
      font-size: calc(var(--font-label) * var(--fix));
      font-weight:500;
      color:#111;
      line-height:1.2;
    }

    .confirm-price{
      font-size: calc(var(--font-label) * var(--fix));
      font-weight:500;
      color:#111;
      margin-top: calc(4px * var(--fix));
    }
    .confirm-price strong{
      font-weight:700;
    }

    /* Icône WhatsApp à la place du texte "Tel." dans la carte */
    #confirmWhatsapp{
      position: relative;
      padding-left: calc(18px * var(--fix));
      font-size: calc(var(--font-label) * var(--fix));
      font-weight: 500;
      color: #111;
    }

    #confirmWhatsapp::before{
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: calc(14.4px * var(--fix));
      height: calc(14.4px * var(--fix));
      background-image: url("https://lh3.googleusercontent.com/d/1tFj_LxwoWayTiX1Yb3PJM4unRNgvkXoL");
      background-size: contain;
      background-repeat: no-repeat;
    }


    /* ===== CASE À COCHER ===== */
    .checkbox-row{
      display:flex;
      align-items:center;
      gap: calc(8px * var(--fix));
      font-size: calc(var(--font-small) * var(--fix));
      color:#111;
    }
    .checkbox-row input[type="checkbox"]{
      width: calc(20px * var(--fix));
      height: calc(20px * var(--fix));
      accent-color:#000;
    }

    /* ===== BOUTON ===== */
    .btn{
      display:block; width:100%;
      text-transform:uppercase; font-weight:700;
      font-size: calc(var(--btn-fs) * var(--fix)); line-height:1.2;
      padding: calc(var(--btn-ph) * var(--fix)) calc(var(--btn-pw) * var(--fix));
      min-height: calc(var(--btn-minh) * var(--fix));
      border-radius: var(--radius);
      border: 5px solid transparent; cursor:pointer;
      transition: filter .15s ease, background .15s ease, color .15s ease, border-color .15s ease;
    }
    .btn:active{ filter:brightness(0.95); }

    .btn-noir{
      background:#000; color:#fff; border-color:#000;
      box-shadow:0 20px 40px rgba(0,0,0,0.40);
    }
  </style>

  <div class="wrapper">

    <!-- ENTÊTE -->
    <header class="header">
      <div class="header-logo">
        <img class="header-img" id="headerImg"
             src="https://lh3.googleusercontent.com/d/15N5N0TgMBTxmn2v-sKsG53mEAKaxXYtA"
             alt="Logo SecoMobil">
      </div>

      <div class="sep-black"></div>

      <div class="header-grid">
        <div class="header-title">
          <span>PEDIDO</span>
          <span>ACTUALIZADO</span>
        </div>
        <div class="header-id" id="pedidoId"></div>
      </div>

      <!-- IMPORTANT : plus de séparateur ici -->
    </header>

    <!-- CONTENU -->
    <div class="stack">

      <div class="confirm-card">
        <div class="confirm-icon">
          <img src="https://lh3.googleusercontent.com/d/1ejYqmcRjgWxEfPf8TPAbwYYNv5ulYNAo"
               alt="Pedido actualizado">
        </div>

        <div class="confirm-info">
          <div class="confirm-line-time">
            <span id="confirmHora">--:--</span>
            <span id="confirmSector">—</span>
          </div>

          <div class="confirm-name" id="confirmNombre">—</div>

          <div class="confirm-text" id="confirmDireccion">—</div>
          <div class="confirm-text" id="confirmNota">Nota : —</div>
          <div class="confirm-text" id="confirmWhatsapp">WhatsApp: —</div>

          <div class="confirm-price">
            <span id="confirmPrecio">—</span>
          </div>
        </div>
      </div>

      <label class="checkbox-row">
        <input type="checkbox" id="chkEnviarWhatsapp" checked>
        <span>Enviar pedido actualizado</span>
      </label>

      <div class="sep-gray"></div>

      <button class="btn btn-noir" id="btnOk">OK</button>

      <div style="height:0;"></div>

    </div>
  </div>

  <script>
    (function(){
      var ctx = (typeof window !== 'undefined' && window.SECO_CTX) ? window.SECO_CTX : {};
      var pedido = (ctx && ctx.pedido) || {};
      var baseCtx = ctx || {};

      function applyScaleFix(){
        var cssW = window.innerWidth || document.documentElement.clientWidth;
        var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
        if (cssW >= 960 && cssW <= 1024) {
          var fix = (980 / screenW) * 1.50;
          document.documentElement.style.setProperty('--fix', fix.toFixed(3));
        } else {
          document.documentElement.style.setProperty('--fix', '1');
        }
      }

      function sizeHeaderImage(){
        var img = document.getElementById('headerImg');
        var wrap = document.querySelector('.wrapper');
        if (!img || !wrap) return;
        var w = Math.floor(wrap.clientWidth);
        if (w > 0){
          img.style.width = w + 'px';
          img.style.maxWidth = '100%';
          img.removeAttribute('height');
        }
      }

      function parseCantidad(raw){
        if (typeof raw === 'number' && isFinite(raw)) return raw;
        if (!raw) return 0;
        var s = String(raw).trim();
        var m = s.match(/^(\d+)/);
        if (m){
          var n = parseInt(m[1], 10);
          if (!isNaN(n)) return n;
        }
        var n2 = Number(s.replace(',', '.'));
        return isNaN(n2) ? 0 : n2;
      }

      function parseMoney(raw){
        if (typeof raw === 'number' && isFinite(raw)) return raw;
        if (!raw) return 0;
        var s = String(raw).trim();
        s = s.replace(/[^0-9.,-]/g, '');
        s = s.replace(',', '.');
        var n = Number(s);
        return isNaN(n) ? 0 : n;
      }

      function formatMoneyText(n){
        n = parseMoney(n);
        return n.toFixed(2).replace('.', ',') + ' $';
      }

      function formatHoraEntrega(raw){
        if (raw instanceof Date && !isNaN(raw.getTime())){
          var hDate = raw;
          var hH = hDate.getHours();
          var hM = String(hDate.getMinutes()).padStart(2, '0');
          return hH + ':' + hM;
        }

        var rawStr = (raw === null || raw === undefined) ? '' : String(raw).trim();
        if (!rawStr) return '';

        var matchHM = rawStr.match(/(\d{1,2})\s*[:hH]\s*(\d{2})/);
        if (matchHM){
          var hh = parseInt(matchHM[1], 10);
          var mm = matchHM[2];
          if (!isNaN(hh)){
            return hh + ':' + mm;
          }
        }

        var numVal = Number(raw);
        if (isFinite(numVal)){
          var baseDate = new Date(1899, 11, 30);
          var millis = Math.round(numVal * 24 * 60 * 60 * 1000);
          var fromSerial = new Date(baseDate.getTime() + millis);
          if (!isNaN(fromSerial.getTime())){
            var sh = fromSerial.getHours();
            var sm = String(fromSerial.getMinutes()).padStart(2, '0');
            return sh + ':' + sm;
          }
        }

        var parsed = new Date(rawStr);
        if (!isNaN(parsed.getTime())){
          var dh = parsed.getHours();
          var dm = String(parsed.getMinutes()).padStart(2, '0');
          return dh + ':' + dm;
        }

        return rawStr;
      }

      function buildSectorPrices(){
        var sectores = Array.isArray(ctx && ctx.sectores) ? ctx.sectores : [];
        var tabla = {};
        sectores.forEach(function(sec){
          var nombre = (sec && sec.nombre) ? sec.nombre.toString().trim().toLowerCase() : '';
          var precioValido = (sec && typeof sec.precio === 'number' && !isNaN(sec.precio)) ? Number(sec.precio) : null;
          if (!nombre || precioValido === null) return;
          tabla[nombre] = precioValido;
        });
        return tabla;
      }

      function obtenerSector(){
        return (
          (pedido && pedido.sector) ||
          (pedido && pedido.cliente && pedido.cliente.sector) ||
          baseCtx.sector ||
          (baseCtx.cliente && baseCtx.cliente.sector) ||
          ''
        ).toString().trim();
      }

      function calcularUnitPrice(cantidad){
        var fuentes = [
          ctx && ctx.precioBase,
          pedido && pedido.precioUnitario
        ];

        for (var i = 0; i < fuentes.length; i++){
          var cand = fuentes[i];
          if (typeof cand === 'number' && !isNaN(cand) && cand > 0){
            return Number(cand);
          }
        }

        var sectorMapa = buildSectorPrices();
        var sectorNombre = obtenerSector().toLowerCase();
        if (sectorNombre && Object.prototype.hasOwnProperty.call(sectorMapa, sectorNombre)){
          return sectorMapa[sectorNombre];
        }

        var totalPedido = parseMoney(pedido.total || baseCtx.total);
        if (totalPedido > 0 && cantidad > 0){
          if (totalPedido >= cantidad){
            return totalPedido / cantidad;
          }
          return totalPedido;
        }

        return 0;
      }

      function render(){
        applyScaleFix();
        sizeHeaderImage();

        var pedidoIdEl     = document.getElementById('pedidoId');
        var horaEl         = document.getElementById('confirmHora');
        var sectorEl       = document.getElementById('confirmSector');
        var nombreEl       = document.getElementById('confirmNombre');
        var dirEl          = document.getElementById('confirmDireccion');
        var notaEl         = document.getElementById('confirmNota');
        var telEl          = document.getElementById('confirmWhatsapp');
        var precioEl       = document.getElementById('confirmPrecio');

        var c = pedido.cliente || baseCtx.cliente || {};
        var nombre = pedido.clienteNombre || c.nombre || baseCtx.clienteNombre || 'Cliente';
        var sector = obtenerSector();
        var direccion = pedido.direccion || c.direccion || baseCtx.direccion || '';
        var nota = pedido.nota || c.nota || baseCtx.nota || '';
        var whatsappRaw = pedido.whatsapp || c.whatsapp || c.telefono || baseCtx.whatsapp || '';
        var horaRaw = pedido.horaEntrega || pedido.hora || baseCtx.horaSeleccionada || '';
        var hora = formatHoraEntrega(horaRaw);
        var fechaTexto = (baseCtx.fechaSeleccionada || pedido.fechaEntrega || '').toString();

        var cantidad = parseCantidad(pedido.cantidad || baseCtx.cantidadSeleccionada);
        var unitPrice = calcularUnitPrice(cantidad);
        var total = unitPrice && cantidad ? unitPrice * cantidad : parseMoney(pedido.total || baseCtx.total);
        if (!total && unitPrice && cantidad){
          total = unitPrice * cantidad;
        }
        if (!unitPrice && total && cantidad){
          unitPrice = total / cantidad;
        }

        var cantidadTexto = cantidad + ' seco' + (cantidad === 1 ? '' : 's');

        if (pedidoIdEl) pedidoIdEl.textContent = pedido.pedidoId || baseCtx.pedidoId || '';
        if (horaEl) horaEl.textContent = hora || '—';
        if (sectorEl) sectorEl.textContent = sector || '—';
        if (nombreEl) nombreEl.textContent = nombre || '—';
        if (dirEl) dirEl.textContent = direccion || '—';

        if (notaEl){
          if (nota){
            notaEl.textContent = 'Nota: ' + nota;
            notaEl.style.display = '';
          } else {
            notaEl.textContent = '';
            notaEl.style.display = 'none';
          }
        }

        if (telEl){
          var digits = (whatsappRaw || '').toString().replace(/\D+/g, '');
          telEl.textContent = digits ? digits : '—';
        }

        if (precioEl){
          precioEl.textContent = cantidadTexto + ' x ' + formatMoneyText(unitPrice) + ' = ' + formatMoneyText(total);
        }
      }

      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', render);
      } else {
        render();
      }

      window.addEventListener('resize', function(){
        applyScaleFix();
        sizeHeaderImage();
      });
    })();
  </script>
