<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, shrink-to-fit=no">
  <title>SecoMobil – Pedido registrado</title>
  <style>
    :root{
      --fix: 1;
      --gap: 12px;
      --radius: 40px;
      --font-label: 12px;
      --font-small: 14px;
      --font-body: 15px;
      --btn-fs: 16px;
      --btn-ph: 14px;
      --btn-pw: 18px;
      --btn-minh: 48px;
      --black: #000;
      --white: #fff;
      --gray10: rgba(0,0,0,0.10);
      --gray20: rgba(0,0,0,0.20);
      --gray25: rgba(0,0,0,0.25);
    }

    html, body{
      margin:0; padding:0;
      width:100%; max-width:100%;
      overflow-x:hidden; box-sizing:border-box;
      background:#fff;
      font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }
    *, *::before, *::after{ box-sizing:inherit; }
    *:focus{ outline:none!important; box-shadow:none!important; }

    .wrapper{ padding: 0 50px; }

    /* ===== ENTÊTE ===== */
    .header{ display:block; margin: calc(var(--gap) * var(--fix)) 0 0 0; }
    .header-logo{ display:block; width:100%; line-height:0; margin:0; }
    .header-img{
      display:block; width:100%; height:auto;
      object-fit:contain; object-position:left center;
      margin:0 8px 15px 0;
      padding-bottom:30px;
    }

    .sep-black{ height:0; border-top: 5px solid var(--black); }
    .sep-gray { height:0; border-top: 2px solid var(--gray20); }

    .header-grid{
      display:grid; grid-template-columns: 1fr;
      align-items:end;
      gap: calc(8px * var(--fix));
      padding: calc(12px * var(--fix)) 0;
    }
    .header-title{
      text-transform: uppercase; font-weight: 900;
      font-size: calc(21px * var(--fix));
      line-height: calc(20px * var(--fix));
    }
    .header-title span{ display:block; }
    .header-id{
      font-size: calc(10px * var(--fix));
      font-weight:700;
      text-transform:uppercase;
      margin-top: calc(4px * var(--fix));
    }

    /* ===== CONTENU ===== */
    .stack{
      display:flex;
      flex-direction:column;
      gap: calc(var(--gap) * var(--fix));
    }

    .txt-body  { font-size: calc(var(--font-body) * var(--fix)); font-weight:500; color:#111; }

    /* ===== CARTE ===== */
    .confirm-card{
      border-radius: var(--radius);
      border:5px solid var(--gray20);
      background:#fff;
      padding: calc(15px * var(--fix));
      display:flex;
      flex-direction:column;
    }
    .confirm-icon{
      text-align:center;
      margin-bottom: calc(14px * var(--fix));
    }
    .confirm-icon img{
      display:inline-block;
      width: calc(80px * var(--fix));
      height:auto;
      object-fit:contain;
    }
    .confirm-info{
      display:flex;
      flex-direction:column;
      gap: calc(4px * var(--fix));
    }

    .confirm-line-time{
      font-size: calc(var(--font-label) * var(--fix));
      font-weight:500;
      color:#111;
    }
    .confirm-line-time span + span{
      margin-left: calc(10px * var(--fix));
    }

    .confirm-name{
      font-weight:700;
      text-transform:uppercase;
      font-size: calc(var(--font-small) * var(--fix));
      margin-top: calc(4px * var(--fix));
    }

    .confirm-text{
      font-size: calc(var(--font-label) * var(--fix));
      font-weight:500;
      color:#111;
      line-height:1.2;
    }

    .confirm-price{
      font-size: calc(var(--font-label) * var(--fix));
      font-weight:500;
      color:#111;
      margin-top: calc(4px * var(--fix));
    }
    .confirm-price strong{
      font-weight:700;
    }

    /* ===== CASE À COCHER ===== */
    .checkbox-row{
      display:flex;
      align-items:center;
      gap: calc(8px * var(--fix));
      font-size: calc(var(--font-small) * var(--fix)); /* taille ajustée */
      color:#111;
    }
    .checkbox-row input[type="checkbox"]{
      width: calc(20px * var(--fix));
      height: calc(20px * var(--fix));
      accent-color:#000;
    }

    /* ===== BOUTON ===== */
    .btn{
      display:block; width:100%;
      text-transform:uppercase; font-weight:700;
      font-size: calc(var(--btn-fs) * var(--fix)); line-height:1.2;
      padding: calc(var(--btn-ph) * var(--fix)) calc(var(--btn-pw) * var(--fix));
      min-height: calc(var(--btn-minh) * var(--fix));
      border-radius: var(--radius);
      border: 5px solid transparent; cursor:pointer;
      transition: filter .15s ease, background .15s ease, color .15s ease, border-color .15s ease;
    }
    .btn:active{ filter:brightness(0.95); }

    .btn-noir{
      background:#000; color:#fff; border-color:#000;
      box-shadow:0 20px 40px rgba(0,0,0,0.40);
    }
  </style>
</head>
<body>
  <div class="wrapper">

    <!-- ENTÊTE -->
    <header class="header">
      <div class="header-logo">
        <img class="header-img" id="headerImg"
             src="https://lh3.googleusercontent.com/d/15N5N0TgMBTxmn2v-sKsG53mEAKaxXYtA"
             alt="Logo SecoMobil">
      </div>

      <div class="sep-black"></div>

      <div class="header-grid">
      <div class="header-title">
        <span>PEDIDO</span>
        <span>REGISTRADO</span>
      </div>
      <div class="header-id" id="pedidoId"></div>
    </div>

      <div class="sep-black"></div>
    </header>

    <!-- CONTENU -->
    <div class="stack">

      <div class="confirm-card">
        <div class="confirm-icon">
          <img src="https://lh3.googleusercontent.com/d/1ejYqmcRjgWxEfPf8TPAbwYYNv5ulYNAo"
               alt="Pedido registrado">
        </div>

        <div class="confirm-info">
          <div class="confirm-line-time">
            <span id="confirmHora">11:40</span>
            <span id="confirmSector">MIRADOR</span>
          </div>

          <div class="confirm-name" id="confirmNombre">LORENZO DESPACITO</div>

          <div class="confirm-text" id="confirmDireccion">Al frente de la tienda Juanita</div>
          <div class="confirm-text" id="confirmNota">Nota : Dejar a la puerta</div>
          <div class="confirm-text" id="confirmWhatsapp">WhatsApp: —</div>

          <div class="confirm-price">
            <span id="confirmPrecio">1 seco x 1,00 $ = <strong>1,00 $</strong></span>
          </div>
        </div>
      </div>

      <label class="checkbox-row">
        <input type="checkbox" id="chkEnviarWhatsapp" checked>
        <span>Enviar pedido registrado</span>
      </label>

      <div class="sep-gray"></div>

      <button class="btn btn-noir" id="btnOk">OK</button>

      <div style="height:0;"></div>

    </div>
  </div>

  <script>
    function getWebAppBaseUrl(){
      var base = '';
      if (typeof window !== 'undefined'){
        base = window.webAppUrl || window.SECO_WEBAPP_BASE_URL || '';
      }
      if (!base){
        var path = window.location.pathname || '';
        var origin = window.location.origin || '';
        base = origin + path;
      }
      return base;
    }

    function buildWebAppUrl(pageName){
      var base = getWebAppBaseUrl();

      var params = new URLSearchParams();
      params.set('page', pageName);

      return `${base}?${params.toString()}`;
    }

    function isSidebarContext(){
      var hasHostClose = (typeof google !== 'undefined'
        && google.script
        && google.script.host
        && typeof google.script.host.close === 'function');

      return hasHostClose && window.top !== window.self;
    }

    function openInBrowser(pageName){
      go(pageName);
    }

    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var avail = Math.floor(wrapper.clientWidth);
      if (avail > 0) {
        img.style.width = avail + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    function setButtonLoading(btn, isLoading){
      if (!btn) return;
      if (isLoading){
        if (!btn.dataset.originalColor){
          var computed = window.getComputedStyle ? getComputedStyle(btn).color : btn.style.color;
          btn.dataset.originalColor = computed || '';
        }
        btn.disabled = true;
        btn.style.color = 'rgba(255,255,255,0.5)';
      } else {
        btn.disabled = false;
        btn.style.color = btn.dataset.originalColor || '';
      }
    }

    function obtenerCtxServidor(){
      var ctx = window.SECO_CTX || {};
      window.pedidoConfirmCtx = ctx;
      return ctx;
    }

    function construirCtxWhatsapp(){
      var ctx = obtenerCtxServidor();
      return {
        pedidoId: ctx.pedidoId || '',
        clienteNombre: ctx.clienteNombre || (ctx.cliente && ctx.cliente.nombre) || '',
        cantidad: ctx.cantidad || 0,
        precioUnitario: ctx.precioUnitario,
        total: ctx.total,
        fechaEntrega: ctx.fechaEntrega || '',
        horaEntrega: ctx.horaEntrega || '',
        direccion: ctx.direccion || (ctx.cliente && ctx.cliente.direccion) || '',
        sector: ctx.sector || (ctx.cliente && ctx.cliente.sector) || '',
        whatsapp: (ctx.cliente && (ctx.cliente.telefono || ctx.cliente.whatsapp)) || ctx.whatsapp || ''
      };
    }

    function pintarConfirmacion(){
      var ctx = obtenerCtxServidor();
      var pedidoIdEl = document.getElementById('pedidoId');
      var horaEl = document.getElementById('confirmHora');
      var sectorEl = document.getElementById('confirmSector');
      var nombreEl = document.getElementById('confirmNombre');
      var dirEl = document.getElementById('confirmDireccion');
      var notaEl = document.getElementById('confirmNota');
      var waEl = document.getElementById('confirmWhatsapp');
      var precioEl = document.getElementById('confirmPrecio');

      var nombre = ctx.clienteNombre || (ctx.cliente && ctx.cliente.nombre) || '';
      var telefono = (ctx.cliente && (ctx.cliente.telefono || ctx.cliente.whatsapp)) || ctx.whatsapp || '';
      var sector = ctx.sector || (ctx.cliente && ctx.cliente.sector) || '';
      var direccion = ctx.direccion || (ctx.cliente && ctx.cliente.direccion) || '';
      var nota = ctx.nota || (ctx.cliente && ctx.cliente.nota) || '';

      var cantidad = Number(ctx.cantidad || 1);
      if (!isFinite(cantidad) || cantidad < 1) cantidad = 1;
      var unit = (ctx.precioUnitario !== undefined) ? Number(ctx.precioUnitario) : 1;
      if (!isFinite(unit) || unit <= 0) unit = 1;
      var total = ctx.total !== undefined ? Number(ctx.total) : unit * cantidad;
      if (!isFinite(total)) total = unit * cantidad;

      if (pedidoIdEl && ctx.pedidoId){ pedidoIdEl.textContent = ctx.pedidoId; }
      if (horaEl){ horaEl.textContent = ctx.horaEntrega || ''; }
      if (sectorEl){ sectorEl.textContent = sector || '—'; }
      if (nombreEl){ nombreEl.textContent = nombre || 'Contacto'; }
      if (dirEl){ dirEl.textContent = direccion || '—'; }
      if (notaEl){ notaEl.textContent = nota ? ('Nota: ' + nota) : 'Nota: —'; }
      if (waEl){ waEl.textContent = telefono ? ('WhatsApp: ' + telefono) : 'WhatsApp: —'; }
      if (precioEl){
        var unitTxt = unit.toFixed(2).replace('.', ',') + ' $';
        var totalTxt = total.toFixed(2).replace('.', ',') + ' $';
        var texto = cantidad + (cantidad === 1 ? ' seco' : ' secos') + ' x ' + unitTxt + ' = <strong>' + totalTxt + '</strong>';
        precioEl.innerHTML = texto;
      }
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      pintarConfirmacion();

      var btnOk = document.getElementById('btnOk');
      var chkEnviar = document.getElementById('chkEnviarWhatsapp');
      if (btnOk){
        btnOk.addEventListener('click', function(){
          setButtonLoading(btnOk, true);
          var enviar = chkEnviar ? chkEnviar.checked : false;
          if (enviar){
            var payload = construirCtxWhatsapp();
            google.script.run
              .withSuccessHandler(function(resp){
                if (!resp || !resp.ok) {
                  setButtonLoading(btnOk, false);
                  var msgErr = (resp && resp.error) ? resp.error : 'No se pudo enviar el mensaje de WhatsApp.';
                  alert(msgErr);
                  return;
                }
                go('inicio');
              })
              .withFailureHandler(function(err){
                setButtonLoading(btnOk, false);
                var msg = (err && err.message) ? err.message : 'No se pudo enviar el mensaje de WhatsApp.';
                alert(msg);
              })
              .enviarWhatsappPedidoRegistrado(payload);
          } else {
            go('inicio');
          }
        });
      }
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  </script>
</body>
</html>
