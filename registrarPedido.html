<style>
    :root{
      --fix: 1;
      --gap: 12px;
      --radius: 40px;
      --font-label: 12px;
      --font-small: 14px;
      --font-body: 15px;
      --btn-fs: 16px;
      --btn-ph: 14px;
      --btn-pw: 18px;
      --btn-minh: 48px;
      --black: #000;
      --white: #fff;
      --gray10: rgba(0,0,0,0.10);
      --gray20: rgba(0,0,0,0.20);
      --gray25: rgba(0,0,0,0.25);
    }

    html, body {
      margin:0; padding:0; width:100%; max-width:100%;
      overflow-x:hidden; box-sizing:border-box;
      background:#fff;
      font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }
    *, *::before, *::after { box-sizing:inherit; }
    *:focus { outline:none!important; box-shadow:none!important; }

    .wrapper { padding: 0 50px; }

    /* ===== ENTÊTE ===== */
    .header { display:block; margin: calc(var(--gap) * var(--fix)) 0; }
    .header-logo { display:block; width:100%; line-height:0; margin:0; }
    .header-img{
      display:block; width:100%; height:auto;
      object-fit:contain; object-position:left center;
      margin:0 8px 15px 0;
      padding-bottom:30px;
    }

    .sep-black { height:0; border-top: 5px solid var(--black); }
    .sep-gray  { height:0; border-top: 2px solid var(--gray20); }

    .header-grid{
      display:grid; grid-template-columns: 1fr auto;
      align-items:end; gap: calc(8px * var(--fix));
      padding: calc(12px * var(--fix)) 0;
    }
    .header-title{
      text-transform: uppercase; font-weight: 900;
      font-size: calc(21px * var(--fix));
      line-height: calc(20px * var(--fix));
    }
    .header-title span{ display:block; }
    .header-id{
      text-align:right; align-self:end;
      font-size: calc(8px * var(--fix)); color:#111; white-space:nowrap;
    }

    /* ===== CONTENU ===== */
    .stack { display:flex; flex-direction:column; gap: calc(var(--gap) * var(--fix)); }

    /* label -> élément : espacement uniforme */
    .label + .field,
    .label + textarea.field,
    .label + .dropdown { margin-top: calc(3px * var(--fix)); }

    /* Boutons */
    .btn {
      display:block; width:100%;
      text-transform:uppercase; font-weight:700;
      font-size: calc(var(--btn-fs) * var(--fix)); line-height:1.2;
      padding: calc(var(--btn-ph) * var(--fix)) calc(var(--btn-pw) * var(--fix));
      min-height: calc(var(--btn-minh) * var(--fix));
      border-radius: var(--radius);
      border: 5px solid transparent; cursor:pointer;
      transition: filter .15s ease;
    }
    .btn:active { filter:brightness(0.95); }
    .btn-noir { background:#000; color:#fff; border-color:#000; box-shadow:0 20px 40px rgba(0,0,0,0.40); }
    .btn-blanc { background:#fff; color:#000; border-color:#000; }
    .btn-blanc:active { color: rgba(0,0,0,0.5); }
    .btn-desactive { background: var(--gray10); color:#fff; border:0; box-shadow:none; cursor:default; }
    .btn-gris { background:#fff; color:#000; border-color: var(--gray20); }
    .btn-gris:active { color: rgba(0,0,0,0.5); }

    /* Textes */
    .txt-body  { font-size: calc(var(--font-body) * var(--fix)); font-weight:500; color:#111; }
    .txt-small { font-size: calc(var(--font-small) * var(--fix)); font-weight:400; color:#222; }
    .label     { font-size: calc(var(--font-label) * var(--fix)); font-weight:400; color: var(--gray25); }

    /* Champs génériques */
    .field{
      width:100%; background:#fff; color:#000;
      border: 5px solid var(--black); border-radius: var(--radius);
      font-size: calc(var(--font-body) * var(--fix));
      line-height:1.3;
      padding: calc(10px * var(--fix)) calc(12px * var(--fix));
    }
    .field::placeholder { color: var(--gray25); }
    textarea.field { min-height: calc(0.96em * var(--fix)); resize: vertical; }

    /* ===== DROPDOWN (COMPOSANT) ===== */
    .dropdown{
      position: relative; width:100%;
      font-size: calc(var(--font-body) * var(--fix));
    }
    .dropdown[data-variant="boxed"] .dd-button{
      border: 5px solid var(--black);
      border-radius: var(--radius);
      background:#fff; color:#000;
      padding: calc(10px * var(--fix)) calc(36px * var(--fix)) calc(10px * var(--fix)) calc(10px * var(--fix));
    }
    .dropdown[data-variant="plain"] .dd-button{
      border: 0; border-radius: 0;
      background:#fff; color:#000;
      padding: 0 calc(36px * var(--fix)) 0 0;
      height: calc(44px * var(--fix));
      display:flex; align-items:center;
      margin-top:0; margin-bottom:0;
    }
    .sep-black + .dropdown[data-variant="plain"],
    .sep-gray  + .dropdown[data-variant="plain"] { margin-top: calc(-12px * var(--fix)); }
    .dropdown[data-variant="plain"] + .sep-black,
    .dropdown[data-variant="plain"] + .sep-gray  { margin-top: calc(-12px * var(--fix)); }

    .dd-button{
      width:100%; text-align:left; position:relative; cursor:pointer;
      line-height:1.3; font-size: inherit;
    }
    .dd-button[data-placeholder="true"] .dd-label{ color: var(--gray25); }
    .dd-label{ display:block; padding-right: calc(18px * var(--fix)); }
    .dd-caret{
      position:absolute; right: calc(16px * var(--fix)); top:50%; transform: translateY(-50%);
      width: 0; height: 0; pointer-events:none;
      border-left: calc(6px * var(--fix)) solid transparent;
      border-right: calc(6px * var(--fix)) solid transparent;
      border-top: calc(6px * var(--fix)) solid #000;
    }

    /* ===== OVERLAY (plein écran) ===== */
    .dd-overlay{
      position: fixed; inset: 0; background:#fff; display:none; z-index: 1000;
      overflow:auto;
    }
    .dd-overlay[data-open="true"]{ display:block; }
    .dd-overlay-inner{ max-width:100%; padding-top: 0; }

    .dd-overlay-list{
      list-style:none; margin:0; padding:0;
      font-size: calc(var(--font-body) * var(--fix));
    }
    .dd-overlay-option{
      padding: calc(12px * var(--fix)) calc(10px * var(--fix));
      border-bottom: 2px solid var(--gray20);
      line-height:1.25; cursor:pointer;
    }
    .dd-overlay-option:last-child{ border-bottom: 0; }
    .dd-overlay-option[aria-selected="true"]{ background: var(--gray10); }
    .dd-overlay-option:active{ background: var(--gray20); }
    .dd-overlay-option.placeholder{ color: var(--gray25); }

    /* ===== Variante GRID 3 colonnes (HORA) ===== */
    .dd-overlay-list.grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      column-gap: 0;
      row-gap: 0;
      padding: 0;
      margin: 0;
    }
    .dd-grid-option{
      list-style:none;
      display:flex; align-items:center; justify-content:center;
      min-height: calc(44px * var(--fix));
      padding: calc(12px * var(--fix)) calc(10px * var(--fix));
      border-bottom: 2px solid var(--gray20);
      line-height:1.25; cursor:pointer; text-align:center;
    }
    .dd-grid-option.is-selected{
      font-weight: 900;
    }
    .dd-grid-option.placeholder{
      grid-column: 1 / -1;
      color: var(--gray25);
      border-bottom: 2px solid var(--gray20);
    }
    .dd-grid-option[data-col="2"],
    .dd-grid-option[data-col="3"]{
      border-left: 2px solid var(--gray20);
    }
    .dd-grid-sep-black{
      grid-column: 1 / -1;
      height: 0;
      border-top: 5px solid var(--black);
    }

    /* ===== SECTIONS ===== */
    .section-title{
      text-transform:uppercase;
      font-weight:900;
      font-size: calc(14px * var(--fix));
    }

    .section-block{
      display:flex;
      flex-direction:column;
      gap: calc(6px * var(--fix));
    }

    .contact-card{
      display:flex;
      flex-direction:column;
      gap: calc(6px * var(--fix));
      padding: calc(6px * var(--fix)) 0;
    }

    .contact-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: calc(8px * var(--fix));
    }

    .contact-edit{
      border:0;
      background:none;
      padding:0;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      cursor:pointer;
      position:relative;
    }
    .contact-edit-icon-img{
      display:block;
      width: calc(13px * var(--fix));
      height:auto;
      object-fit:contain;
    }
    .contact-edit-spinner{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
    }
    .contact-edit-spinner .spinner{
      width: calc(13px * var(--fix));
      height: calc(13px * var(--fix));
      border-radius:50%;
      border: calc(2px * var(--fix)) solid rgba(0,0,0,0.2);
      border-top-color:#000;
      animation: spin 1s linear infinite;
    }
    .contact-edit.is-loading .contact-edit-icon-img{ visibility:hidden; }
    .contact-edit.is-loading .contact-edit-spinner{ display:flex; }

    .price-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: calc(8px * var(--fix)) 0;
    }
    .price-label,
    .price-value{
      text-transform:uppercase;
      font-weight:900;
      font-size: calc(14px * var(--fix));
    }
    .price-value{
      text-align:right;
    }

    /* CASE À COCHER (la classe reste définie mais plus utilisée dans le markup) */
    .checkbox-row{
      display:flex;
      align-items:center;
      gap: calc(8px * var(--fix));
      font-size: calc(var(--font-small) * var(--fix));
      color:#111;
    }
    .checkbox-row input[type="checkbox"]{
      width: calc(20px * var(--fix));
      height: calc(20px * var(--fix));
      accent-color:#000;
    }
    @keyframes spin{
      from{ transform:rotate(0deg); }
      to{ transform:rotate(360deg); }
    }
  </style>

  <div class="wrapper">

    <!-- ===== ENTÊTE ===== -->
    <header class="header" id="pageHeader">
      <div class="header-logo">
        <img class="header-img" id="headerImg"
             src="https://lh3.googleusercontent.com/d/15N5N0TgMBTxmn2v-sKsG53mEAKaxXYtA"
             alt="Logo SecoMobil">
      </div>

      <div class="sep-black"></div>

      <div class="header-grid">
        <div class="header-title">
          <span>REGISTRAR</span>
          <span>PEDIDO</span>
        </div>
        <div class="header-id" id="pedidoId">P-00001</div>
      </div>

      <div class="sep-black"></div>
    </header>

    <!-- ===== CONTENU ===== -->
    <div class="stack">

      <!-- SECTION CONTACTO -->
      <div class="section-title">CONTACTO</div>
      <div class="sep-black"></div>

      <div class="section-block contact-card">
        <div class="contact-top">
          <div>
            <div class="label">Nombre</div>
            <div class="txt-body">
              <div id="contactoNombre">Nombre</div>
              <div id="contactoSubline">Apellido</div>
            </div>
          </div>
          <button type="button" class="contact-edit" id="btnEditarContacto">
            <img class="contact-edit-icon-img"
                 src="https://lh3.googleusercontent.com/d/1IJOPYYBICvweVK9rn2mQqckhfyQOHvrJ"
                 alt="Editar contacto">
            <div class="contact-edit-spinner" aria-hidden="true">
              <div class="spinner" aria-label="Cargando"></div>
            </div>
          </button>
        </div>

        <div class="sep-gray" data-role="nota-sep-below"></div>

        <div>
          <div class="label">Sector</div>
          <div class="txt-body" id="contactoSector">Centro Misahualli</div>
        </div>

        <div class="sep-gray"></div>

        <div>
          <div class="label">Direccion</div>
          <div class="txt-body">
            <div id="contactoDireccion">Al frente de la tienda</div>
            <div id="contactoDireccionExtra">Juanita</div>
          </div>
        </div>

        <div class="sep-gray"></div>

        <div>
          <div class="label">Nota</div>
          <div class="txt-body" id="contactoNota">Dejar a la puerta</div>
        </div>

        <div class="sep-gray"></div>

        <div>
          <div class="label">WhatsApp</div>
          <div class="txt-body" id="contactoWhatsapp">593987903447</div>
        </div>
      </div>

      <!-- SÉPARATEUR NOIR AVANT PEDIDO -->
      <div class="sep-black"></div>

      <!-- SECTION PEDIDO -->
      <div class="section-title">PEDIDO</div>
      <div class="sep-black"></div>

      <!-- Fecha -->
      <div class="dropdown" data-variant="plain" data-list-variant="fullscreen" data-name="fecha">
        <button type="button" class="dd-button" data-placeholder="true">
          <span class="dd-label">Fecha</span><span class="dd-caret" aria-hidden="true"></span>
        </button>
        <script type="application/json" class="dd-data">[]</script>
      </div>

      <div class="sep-gray"></div>

      <!-- Hora (pré-remplie plus tard par JS) -->
      <div class="dropdown" data-variant="plain" data-list-variant="grid3" data-name="hora">
        <button type="button" class="dd-button" data-placeholder="true">
          <span class="dd-label">Hora de entrega</span><span class="dd-caret" aria-hidden="true"></span>
        </button>
        <script type="application/json" class="dd-data">[]</script>
      </div>

      <div class="sep-gray"></div>

      <!-- Cantidad -->
      <div class="dropdown" data-variant="plain" data-list-variant="fullscreen" data-name="cantidad">
        <button type="button" class="dd-button" data-placeholder="true">
          <span class="dd-label">Cantidad</span><span class="dd-caret" aria-hidden="true"></span>
        </button>
        <script type="application/json" class="dd-data">[]</script>
      </div>

      <div class="sep-black"></div>

      <!-- PRIX -->
      <div class="price-row">
        <div class="price-label">PRECIO</div>
        <div class="price-value" id="precioValor"></div>
      </div>

      <!-- SÉPARATEUR NOIR SOUS LE PRIX -->
      <div class="sep-black"></div>

      <!-- BOUTONS -->
      <button class="btn btn-desactive" id="btnRegistrar" disabled>REGISTRAR</button>
      <button class="btn btn-blanc" id="btnVolver">VOLVER AL INICIO</button>

      <!-- ESPACEMENT SOUS LE BOUTON -->
      <div style="height:0;"></div>

    </div>
  </div>

  <!-- ===== OVERLAY GLOBAL ===== -->
  <div class="dd-overlay" id="ddOverlay" aria-hidden="true">
    <div class="dd-overlay-inner" id="ddOverlayInner">
      <ul class="dd-overlay-list" id="ddOverlayList" role="listbox" aria-label="Options"></ul>
    </div>
  </div>

  <script>
    (function(){
      var ctx = (typeof window !== 'undefined' && window.SECO_CTX) ? window.SECO_CTX : {};
      var clienteActual = ctx.cliente || null;
      var sectoresCtx = Array.isArray(ctx.sectores) ? ctx.sectores : [];
      var overlay, overlayList, currentDropdown = null;
      var contactEditBtn = document.getElementById('btnEditarContacto');

      function applyScaleFix(){
        var fix = 1;
        if (window.innerWidth <= 360){
          fix = Math.max(0.75, window.innerWidth / 360);
        } else if (window.innerWidth <= 420){
          fix = Math.max(0.85, window.innerWidth / 420);
        }
        document.documentElement.style.setProperty('--fix', String(fix));
      }

      function sizeHeaderImage(){
        var img = document.getElementById('headerImg');
        var wrapper = document.querySelector('.wrapper');
        if (!img || !wrapper) return;
        var avail = Math.floor(wrapper.clientWidth);
        if (avail > 0) {
          img.style.width = avail + 'px';
          img.style.maxWidth = '100%';
          img.removeAttribute('height');
        }
      }

      function obtenerElementoSector(){
        var labels = document.querySelectorAll('.contact-card .label');
        for (var i = 0; i < labels.length; i++) {
          var lbl = labels[i];
          if ((lbl.textContent || '').toString().trim().toLowerCase() !== 'sector') continue;

          var contenedor = lbl.parentElement;
          if (contenedor) {
            var txtBody = contenedor.querySelector('.txt-body');
            if (txtBody && txtBody.textContent) {
              return txtBody;
            }
          }

          var siguiente = lbl.nextElementSibling;
          if (siguiente && siguiente.classList.contains('txt-body') && siguiente.textContent) {
            return siguiente;
          }
        }
        return null;
      }

      function obtenerSectorDesdePagina(){
        var el = obtenerElementoSector();
        return el && el.textContent ? el.textContent.trim() : '';
      }

      function construirSectorPrices(){
        var sectores = Array.isArray(sectoresCtx) ? sectoresCtx : [];
        var tabla = {};

        sectores.forEach(function(sec){
          var nombre = (sec && sec.nombre) ? sec.nombre.toString().trim() : '';
          var precioValido = (sec && typeof sec.precio === 'number' && !isNaN(sec.precio))
            ? Number(sec.precio)
            : null;

          if (!nombre || precioValido === null) return;
          tabla[nombre.toLowerCase()] = precioValido;
        });

        return tabla;
      }

      function getPrecioBaseDesdeCtx(){
        if (ctx && typeof ctx.precioBase === 'number' && !isNaN(ctx.precioBase)){
          return Number(ctx.precioBase);
        }

        var sectorTexto = (obtenerSectorDesdePagina() || '').toString().trim().toLowerCase();
        var sectorPrices = construirSectorPrices();

        if (sectorTexto && Object.prototype.hasOwnProperty.call(sectorPrices, sectorTexto)) {
          return sectorPrices[sectorTexto];
        }

        return 0;
      }

      function obtenerCantidadSeleccionada(){
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
        if (!ddCantidad) return 0;
        var raw = ddCantidad.dataset.value || '';
        var m = raw.match(/^(\d+)/);
        if (m){
          var n = parseInt(m[1], 10);
          if (!isNaN(n) && n > 0) return n;
        }
        return 0;
      }

      function dropdownTieneValor(dropdown){
        if (!dropdown) return false;
        var button = dropdown.querySelector('.dd-button');
        var isPlaceholder = button && button.getAttribute('data-placeholder') === 'true';
        var val = dropdown.dataset.value || '';
        return !isPlaceholder && val !== '';
      }

      function sincronizarBotonRegistrar(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
        var btn        = document.getElementById('btnRegistrar');

        var ok = dropdownTieneValor(ddFecha) && dropdownTieneValor(ddHora) && dropdownTieneValor(ddCantidad);
        if (btn){
          btn.disabled = !ok;
          btn.classList.toggle('btn-noir', ok);
          btn.classList.toggle('btn-desactive', !ok);
        }
      }

      function actualizarPrecio(){
        var precioBase = getPrecioBaseDesdeCtx();
        var cantidad = dropdownTieneValor(document.querySelector('.dropdown[data-name="cantidad"]'))
          ? obtenerCantidadSeleccionada()
          : 0;
        var total = precioBase * cantidad;

        var precioEl = document.getElementById('precioValor');
        if (precioEl){
          var txt = (cantidad && precioBase ? total : 0).toFixed(2).replace('.', ',') + ' $';
          precioEl.textContent = txt;
          var isPlaceholder = !cantidad || !precioBase;
          precioEl.style.color = isPlaceholder ? 'rgba(0,0,0,0.25)' : '#000';
        }

        sincronizarBotonRegistrar();
      }

      function observarCambiosSector(){
        var sectorEl = obtenerElementoSector();
        if (!sectorEl || typeof MutationObserver !== 'function') return;

        var obs = new MutationObserver(function(){
          actualizarPrecio();
        });

        obs.observe(sectorEl, { childList: true, characterData: true, subtree: true });
      }

      function formatFechaEtiqueta(raw){
        if (!raw) return "";

        var meses = ["Ene.","Feb.","Mar.","Abr.","May.","Jun.","Jul.","Ago.","Sep.","Oct.","Nov.","Dic."];
        var dias = ["Domingo","Lunes","Martes","Miercoles","Jueves","Viernes","Sabado"];

        var d = null;
        var s = String(raw).trim();

        var m1 = s.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        if (m1){
          var dd = parseInt(m1[1], 10);
          var mm = parseInt(m1[2], 10) - 1;
          var yyyy = parseInt(m1[3], 10);
          d = new Date(yyyy, mm, dd);
        } else {
          var dIso = new Date(s);
          if (!isNaN(dIso.getTime())){
            d = dIso;
          }
        }

        if (!d || isNaN(d.getTime())) return raw;

        var dow  = dias[d.getDay()];
        var day  = d.getDate();
        var mes  = meses[d.getMonth()];

        return dow + ", " + day + " de " + mes;
      }

      function buildTimes(){
        const out=[];
        for(let h=6;h<=18;h++){
          for(let m=0;m<60;m+=5){
            if(h===18 && m>55) break;
            out.push(String(h).padStart(2,"0")+":"+String(m).padStart(2,"0"));
          }
        }
        return out;
      }

      function normalizarHora(h) {
        if (!h) return '';
        const raw = String(h).trim();
        const m = raw.match(/(\d{1,2}):(\d{2})/);
        if (m) {
          const hh = m[1].padStart(2, "0");
          const mm = m[2];
          return hh + ":" + mm;
        }
        return '';
      }

      function buildDatesStartingTomorrow(count){
        const res = [];
        const hoy = new Date();
        for (let i = 1; i <= count; i++){
          const d = new Date(hoy);
          d.setDate(hoy.getDate() + i);
          const dd  = String(d.getDate()).padStart(2,"0");
          const mm  = String(d.getMonth()+1).padStart(2,"0");
          const yyyy = d.getFullYear();
          const etiqueta = formatFechaEtiqueta(yyyy + "-" + mm + "-" + dd);
          res.push(etiqueta);
        }
        return res;
      }

      function openOverlayFor(dropdown){
        currentDropdown = dropdown;
        overlayList.className = 'dd-overlay-list';
        overlayList.innerHTML = "";

        var button = dropdown.querySelector('.dd-button');
        var label  = dropdown.querySelector('.dd-label');

        var variant = dropdown.dataset.listVariant || 'fullscreen';

        if (variant === 'grid3'){
          overlayList.classList.add('grid3');

          var phText = dropdown.dataset.ph || label.textContent.trim() || 'Heure';
          var ph = document.createElement('li');
          ph.className = 'dd-grid-option placeholder';
          ph.textContent = phText;
          ph.addEventListener('click', function(){
            label.textContent = phText;
            button.setAttribute('data-placeholder','true');
            dropdown.dataset.value = '';
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            actualizarPrecio();
          });
          overlayList.appendChild(ph);

          var times = buildTimes();
          var selectedHora = normalizarHora(dropdown.dataset.value || label.textContent || '');
          var perRow = 3, groupRows = 4, groupSize = perRow * groupRows;
          var col = 1;

          times.forEach(function(txt, idx){
            var li = document.createElement('li');
            li.className = 'dd-grid-option';
            li.textContent = txt;
            li.setAttribute('role','option');
            if (normalizarHora(txt) === selectedHora) {
              li.classList.add('is-selected');
            }

            li.dataset.col = String(col);

            li.addEventListener('click', function(){
              label.textContent = txt;
              button.removeAttribute('data-placeholder');
              dropdown.dataset.value = txt;
              closeOverlay();
              setTimeout(()=>button.focus({preventScroll:true}),0);
              actualizarPrecio();
            });
            overlayList.appendChild(li);

            col = (col % 3) + 1;

            var pos = idx + 1;
            if (pos % groupSize === 0 && pos < times.length){
              var sep = document.createElement('li');
              sep.className = 'dd-grid-sep-black';
              overlayList.appendChild(sep);
            }
          });

        } else {
          var dataEl = dropdown.querySelector('.dd-data');
          var items = [];
          if (dataEl) {
            try { items = JSON.parse(dataEl.textContent.trim()); } catch(e){ items = []; }
          }

          var placeholderText = dropdown.dataset.ph || label.textContent.trim() || 'Lorem ipsum';
          var liPh = document.createElement('li');
          liPh.className = 'dd-overlay-option placeholder';
          liPh.setAttribute('role','option');
          liPh.textContent = placeholderText;
          liPh.addEventListener('click', function(){
            label.textContent = placeholderText;
            button.setAttribute('data-placeholder','true');
            dropdown.dataset.value = '';
            closeOverlay();
            setTimeout(()=>button.focus({preventScroll:true}),0);
            actualizarPrecio();
          });
          overlayList.appendChild(liPh);

          items.forEach(function(txt){
            var li = document.createElement('li');
            li.className = 'dd-overlay-option';
            li.setAttribute('role','option');
            li.textContent = txt;
            li.addEventListener('click', function(){
              label.textContent = txt;
              button.removeAttribute('data-placeholder');
              dropdown.dataset.value = txt;
              closeOverlay();
              setTimeout(()=>button.focus({preventScroll:true}),0);
              actualizarPrecio();
            });
            overlayList.appendChild(li);
          });
        }

        document.getElementById('ddOverlay').setAttribute('data-open','true');
        document.body.style.overflow = 'hidden';
      }

      function closeOverlay(){
        document.getElementById('ddOverlay').setAttribute('data-open','false');
        document.body.style.overflow = '';
        currentDropdown = null;
      }

      function setupDropdown(dropdown){
        var button = dropdown.querySelector('.dd-button');
        var label  = dropdown.querySelector('.dd-label');

        var phText = label.textContent.trim() || 'Seleccionar';
        dropdown.dataset.ph = phText;
        if (!dropdown.dataset.value){
          dropdown.dataset.value = '';
        }

        button.addEventListener('click', function(){
          openOverlayFor(dropdown);
        });
        button.addEventListener('keydown', function(e){
          if (e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            openOverlayFor(dropdown);
          }
        });
      }

      function initDropdowns(){
        document.querySelectorAll('.dropdown').forEach(setupDropdown);
        overlayList = document.getElementById('ddOverlayList');

        document.addEventListener('keydown', function(e){
          if (e.key === 'Escape' && document.getElementById('ddOverlay').getAttribute('data-open') === 'true'){
            closeOverlay();
          }
        });

        document.getElementById('ddOverlay').addEventListener('click', function(e){
          if (e.target === e.currentTarget) closeOverlay();
        });
      }

      function setDropdownValue(dropdown, labelText, valueText, isPlaceholder){
        if (!dropdown) return;
        var btn = dropdown.querySelector('.dd-button');
        var lab = dropdown.querySelector('.dd-label');
        if (lab && labelText !== undefined) lab.textContent = labelText;
        if (btn){
          if (isPlaceholder){
            btn.setAttribute('data-placeholder','true');
          } else {
            btn.removeAttribute('data-placeholder');
          }
        }
        dropdown.dataset.value = valueText || '';
      }

      function inicializarFechaCantidadHora(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');

        if (ddFecha){
          var dataElF = ddFecha.querySelector('.dd-data');
          var fechas = buildDatesStartingTomorrow(7);
          if (dataElF){
            dataElF.textContent = JSON.stringify(fechas);
          }
          var preferida = ctx.fechaSeleccionada || (fechas.length ? fechas[0] : '');
          if (preferida){
            setDropdownValue(ddFecha, preferida, preferida, false);
          }
        }

        if (ddCantidad){
          var dataElC = ddCantidad.querySelector('.dd-data');
          if (dataElC){
            var items = [];
            for (var i = 1; i <= 10; i++){
              items.push(i + (i === 1 ? ' seco' : ' secos'));
            }
            dataElC.textContent = JSON.stringify(items);

            var seleccion = ctx.cantidadSeleccionada || items[0] || '';
            if (seleccion){
              setDropdownValue(ddCantidad, seleccion, seleccion, false);
            }
          }
        }

        if (ddHora){
          var seleccionHora = normalizarHora(ctx.horaSeleccionada);
          var phHora = ddHora.dataset.ph || 'Hora de entrega';
          setDropdownValue(ddHora, seleccionHora || phHora, seleccionHora, !seleccionHora);
          if (!seleccionHora && ddHora.querySelector('.dd-button')){
            ddHora.querySelector('.dd-button').setAttribute('data-placeholder','true');
          }
        }

        actualizarPrecio();
      }

      function poblarContacto(){
        var nombreEl = document.getElementById('contactoNombre');
        var sublineEl = document.getElementById('contactoSubline');
        var sectorEl = document.getElementById('contactoSector');
        var dirEl = document.getElementById('contactoDireccion');
        var dirExtraEl = document.getElementById('contactoDireccionExtra');
        var notaEl = document.getElementById('contactoNota');
        var waEl = document.getElementById('contactoWhatsapp');

        var cliente = clienteActual || {};
        var nombre = cliente.nombre || ctx.clienteNombre || '';
        var partes = nombre.split(' ');
        var nombrePrincipal = partes.shift() || nombre || 'Contacto';
        var subline = (cliente.telefono || cliente.whatsapp || '').toString().trim();

        if (nombreEl) nombreEl.textContent = nombrePrincipal;
        if (sublineEl) sublineEl.textContent = subline || 'Contacto sin WhatsApp';
        if (sectorEl) sectorEl.textContent = cliente.sector || '—';

        if (dirEl) dirEl.textContent = cliente.direccion || '—';
        if (dirExtraEl){
          var extra = cliente.direccionExtra || '';
          dirExtraEl.textContent = extra;
          dirExtraEl.style.display = extra ? '' : 'none';
        }

        if (notaEl){
          var nota = cliente.nota || '';
          notaEl.textContent = nota;
          var notaRow = notaEl.parentElement;
          if (notaRow) notaRow.style.display = nota ? '' : 'none';
          var sepBelow = notaRow ? notaRow.parentElement.querySelector('[data-role="nota-sep-below"]') : null;
          if (sepBelow) sepBelow.style.display = nota ? '' : 'none';
        }

        if (waEl) waEl.textContent = subline || '—';

        var idEl = document.getElementById('pedidoId');
        if (idEl && ctx && ctx.pedidoId){
          idEl.textContent = ctx.pedidoId;
        }
      }

      function cargarClienteDesdeServidor(){
        var idContacto = (ctx && (ctx.idContacto || (ctx.cliente && ctx.cliente.idCliente))) || '';
        if (!idContacto){
          poblarContacto();
          actualizarPrecio();
          return;
        }

        google.script.run
          .withSuccessHandler(function(resp){
            if (resp && resp.ok && resp.data && resp.data.cliente){
              clienteActual = resp.data.cliente;
              sectoresCtx = Array.isArray(resp.data.sectores) ? resp.data.sectores : sectoresCtx;
              ctx.cliente = clienteActual;
              ctx.sectores = sectoresCtx;
              window.SECO_CTX = ctx;
            }
            poblarContacto();
            actualizarPrecio();
          })
          .withFailureHandler(function(){
            poblarContacto();
            actualizarPrecio();
          })
          .obtenerClientePorId({ idContacto: idContacto });
      }

      function guardarCtxSeleccion(){
        var ddFecha    = document.querySelector('.dropdown[data-name="fecha"]');
        var ddHora     = document.querySelector('.dropdown[data-name="hora"]');
        var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');

        ctx.fechaSeleccionada = ddFecha ? (ddFecha.dataset.value || '') : '';
        ctx.horaSeleccionada = ddHora ? (ddHora.dataset.value || '') : '';
        ctx.cantidadSeleccionada = ddCantidad ? (ddCantidad.dataset.value || '') : '';
        window.SECO_CTX = ctx;
      }

      function bindEditarContacto(){
        if (!contactEditBtn) return;
        contactEditBtn.addEventListener('click', function(){
          if (contactEditBtn.disabled) return;
          contactEditBtn.disabled = true;
          contactEditBtn.classList.add('is-loading');
          guardarCtxSeleccion();
          window.SECO_CTX = Object.assign({}, ctx, {
            origen: 'registrarPedido',
            pedidoId: ctx.pedidoId || '',
            idContacto: (ctx && ctx.idContacto) || (clienteActual && clienteActual.idCliente) || '',
            cliente: clienteActual,
            fechaSeleccionada: ctx.fechaSeleccionada,
            horaSeleccionada: ctx.horaSeleccionada,
            cantidadSeleccionada: ctx.cantidadSeleccionada
          });
          loadPage('editarContacto', function(){
            contactEditBtn.disabled = false;
            contactEditBtn.classList.remove('is-loading');
          });
        });
      }

      function init(){
        applyScaleFix();
        sizeHeaderImage();
        initDropdowns();
        inicializarFechaCantidadHora();
        observarCambiosSector();
        bindEditarContacto();
        cargarClienteDesdeServidor();
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else { init(); }

      window.addEventListener('resize', function(){
        applyScaleFix();
        sizeHeaderImage();
      });
    })();
  </script>
