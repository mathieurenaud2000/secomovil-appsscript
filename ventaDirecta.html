<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, shrink-to-fit=no">
  <title>SecoMobil – Venta directa</title>
  <style>
    :root{
      --fix: 1;
      --gap: 12px;
      --radius: 40px;
      --font-label: 12px;
      --font-small: 14px;
      --font-body: 15px;
      --btn-fs: 16px;
      --btn-ph: 14px;
      --btn-pw: 18px;
      --btn-minh: 48px;
      --black: #000;
      --white: #fff;
      --gray10: rgba(0,0,0,0.10);
      --gray20: rgba(0,0,0,0.20);
      --gray25: rgba(0,0,0,0.25);
    }

    html, body {
      margin:0; padding:0; width:100%; max-width:100%;
      overflow-x:hidden; box-sizing:border-box;
      background:#fff;
      font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
    }
    *, *::before, *::after { box-sizing:inherit; }
    *:focus { outline:none!important; box-shadow:none!important; }

    .wrapper { padding: 0 50px; }

    /* ===== ENTÊTE ===== */
    .header { display:block; margin: calc(var(--gap) * var(--fix)) 0; }
    .header-logo { display:block; width:100%; line-height:0; margin:0; }
    .header-img{
      display:block; width:100%; height:auto;
      object-fit:contain; object-position:left center;
      margin:0 8px 15px 0;
      padding-bottom:30px;
    }

    .sep-black { height:0; border-top: 5px solid var(--black); }
    .sep-gray  { height:0; border-top: 2px solid var(--gray20); }

    .header-grid{
      display:grid; grid-template-columns: 1fr auto;
      align-items:end; gap: calc(8px * var(--fix));
      padding: calc(12px * var(--fix)) 0;
    }
    .header-title{
      text-transform: uppercase; font-weight: 900;
      font-size: calc(21px * var(--fix));
      line-height: calc(20px * var(--fix));
    }
    .header-title span{ display:block; }
    .header-id{
      text-align:right; align-self:end;
      font-size: calc(8px * var(--fix)); color:#111; white-space:nowrap;
    }
    .venta-id-loader{
      display:inline-flex; align-items:flex-end; justify-content:flex-end;
      gap: calc(3px * var(--fix));
      min-width: calc(64px * var(--fix));
      height: calc(12px * var(--fix));
    }
    .venta-id-loader .dot{
      width: calc(5px * var(--fix)); height: calc(5px * var(--fix));
      border-radius:50%; background:#111; opacity:0.3;
      animation: ventaIdPulse 1s infinite ease-in-out;
    }
    .venta-id-loader .dot:nth-child(2){ animation-delay:0.15s; }
    .venta-id-loader .dot:nth-child(3){ animation-delay:0.30s; }
    @keyframes ventaIdPulse{
      0%, 80%, 100%{ opacity:0.25; transform: translateY(0); }
      40%{ opacity:0.8; transform: translateY(-1px); }
    }

    /* ===== CONTENU ===== */
    .stack { display:flex; flex-direction:column; gap: calc(var(--gap) * var(--fix)); }

    .txt-body  { font-size: calc(var(--font-body) * var(--fix)); font-weight:500; color:#111; }
    .txt-small { font-size: calc(var(--font-small) * var(--fix)); font-weight:400; color:#222; }
    .label     { font-size: calc(var(--font-label) * var(--fix)); font-weight:400; color:#222; }

    /* label -> élément : gap/2 (approuvé) */
    .label + .field,
    .label + .dropdown { margin-top: calc((-1 * var(--gap) / 2) * var(--fix)); }

    /* Champs */
    .field{
      width:100%; background:#fff; color:#000;
      border: 5px solid var(--black); border-radius: var(--radius);
      font-size: calc(var(--font-body) * var(--fix));
      line-height:1.3;
      padding: calc(10px * var(--fix)) calc(12px * var(--fix));
    }
    .field::placeholder { color: var(--gray25); }

    /* Boutons */
    .btn {
      display:block; width:100%;
      text-transform:uppercase; font-weight:700;
      font-size: calc(var(--btn-fs) * var(--fix)); line-height:1.2;
      padding: calc(var(--btn-ph) * var(--fix)) calc(var(--btn-pw) * var(--fix));
      min-height: calc(var(--btn-minh) * var(--fix));
      border-radius: var(--radius);
      border: 5px solid transparent; cursor:pointer;
      transition: filter .15s ease;
    }
    .btn:active { filter:brightness(0.95); }
    .btn-noir { background:#000; color:#fff; border-color:#000; box-shadow:0 20px 40px rgba(0,0,0,0.40); }
    .btn-blanc { background:#fff; color:#000; border-color:#000; }
    .btn-blanc:active { color: rgba(0,0,0,0.5); }
    .btn-desactive { background: var(--gray10); color:#fff; border:0; box-shadow:none; cursor:default; }

    /* ===== DROPDOWN (COMPOSANT) ===== */
    .dropdown{
      position: relative; width:100%;
      font-size: calc(var(--font-body) * var(--fix));
    }
    .dropdown[data-variant="boxed"] .dd-button{
      border: 5px solid var(--black);
      border-radius: var(--radius);
      background:#fff; color:#000;
      padding: calc(10px * var(--fix)) calc(36px * var(--fix)) calc(10px * var(--fix)) calc(10px * var(--fix));
    }
    .dropdown[data-variant="plain"] .dd-button{
      border: 0; border-radius: 0;
      background:#fff; color:#000;
      padding: 0 calc(36px * var(--fix)) 0 0;
      height: calc(44px * var(--fix));
      display:flex; align-items:center;
      margin-top:0; margin-bottom:0;
    }
    .sep-black + .dropdown[data-variant="plain"],
    .sep-gray  + .dropdown[data-variant="plain"] { margin-top: calc(-12px * var(--fix)); }
    .dropdown[data-variant="plain"] + .sep-black,
    .dropdown[data-variant="plain"] + .sep-gray  { margin-top: calc(-12px * var(--fix)); }

    .dd-button{
      width:100%; text-align:left; position:relative; cursor:pointer;
      line-height:1.3; font-size: inherit;
    }
    .dd-button[data-placeholder="true"] .dd-label{ color: var(--gray25); }
    .dd-label{ display:block; padding-right: calc(18px * var(--fix)); }
    .dd-caret{
      position:absolute; right: calc(16px * var(--fix)); top:50%; transform: translateY(-50%);
      width: 0; height: 0; pointer-events:none;
      border-left: calc(6px * var(--fix)) solid transparent;
      border-right: calc(6px * var(--fix)) solid transparent;
      border-top: calc(6px * var(--fix)) solid #000;
    }

    /* ===== OVERLAY (plein écran) ===== */
    .dd-overlay{
      position: fixed; inset: 0; background:#fff; display:none; z-index: 1000;
      overflow:auto;
    }
    .dd-overlay[data-open="true"]{ display:block; }
    .dd-overlay-inner{ max-width:100%; padding-top: 0; }

    .dd-overlay-list{
      list-style:none; margin:0; padding:0;
      font-size: calc(var(--font-body) * var(--fix));
    }
    .dd-overlay-option{
      padding: calc(12px * var(--fix)) calc(10px * var(--fix));
      border-bottom: 2px solid var(--gray20);
      line-height:1.25; cursor:pointer;
    }
    .dd-overlay-option:last-child{ border-bottom: 0; }
    .dd-overlay-option[aria-selected="true"]{ background: var(--gray10); }
    .dd-overlay-option:active{ background: var(--gray20); }
    .dd-overlay-option.placeholder{ color: var(--gray25); }

    /* ===== TOTAL ===== */
    .total-row{
      text-align:right;
      font-size: calc(var(--font-small) * var(--fix));
      color:#111;
    }
    .total-row strong{ font-weight:700; }
  </style>
</head>
<body>
  <div class="wrapper">

    <!-- ===== ENTÊTE ===== -->
    <header class="header" id="pageHeader">
      <div class="header-logo">
        <img class="header-img" id="headerImg"
             src="https://lh3.googleusercontent.com/d/15N5N0TgMBTxmn2v-sKsG53mEAKaxXYtA"
             alt="Logo SecoMobil">
      </div>

      <div class="sep-black"></div>

      <div class="header-grid">
        <div class="header-title">
          <span>VENTA</span>
          <span>DIRECTA</span>
        </div>
        <div class="header-id" id="ventaIdHeader">
          <span class="venta-id-loader" aria-label="Cargando ID" role="status">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </span>
        </div>
      </div>

      <div class="sep-black"></div>
    </header>

    <!-- ===== CONTENU ===== -->
    <div class="stack">

      <!-- Titre de section -->
      <div class="txt-body">Registrar una venta</div>

      <!-- Prix -->
      <div class="label">Precio ($)</div>
      <input class="field" id="precio" type="text" inputmode="decimal" autocomplete="off">

      <!-- Quantité -->
      <div class="dropdown" data-variant="boxed" data-list-variant="fullscreen" data-name="cantidad">
        <button type="button" class="dd-button">
          <span class="dd-label">1 seco</span><span class="dd-caret" aria-hidden="true"></span>
        </button>
        <script type="application/json" class="dd-data">
          ["1 seco","2 secos","3 secos","4 secos","5 secos","6 secos","7 secos","8 secos","9 secos","10 secos"]
        </script>
      </div>

      <!-- Total -->
      <div class="total-row">
        <span>Total a cancelar = </span><span><strong id="totalMonto">0,00 $</strong></span>
      </div>

      <div class="sep-gray"></div>

      <!-- Boutons -->
      <button class="btn btn-desactive" id="btnRegistrar" type="button" disabled>REGISTRAR</button>
      <button class="btn btn-blanc" id="btnVolver">VOLVER AL INICIO</button>

      <div style="height:0;"></div>

    </div>
  </div>

  <!-- ===== OVERLAY GLOBAL ===== -->
  <div class="dd-overlay" id="ddOverlay" aria-hidden="true">
    <div class="dd-overlay-inner" id="ddOverlayInner">
      <ul class="dd-overlay-list" id="ddOverlayList" role="listbox" aria-label="Options"></ul>
    </div>
  </div>

  <script>
    /* ===== Correctif d'échelle ===== */
    function applyScaleFix(){
      var cssW = window.innerWidth || document.documentElement.clientWidth;
      var screenW = Math.min(window.screen.width || 375, window.screen.height || 812);
      if (cssW >= 960 && cssW <= 1024) {
        var fix = (980 / screenW) * 1.50;
        document.documentElement.style.setProperty('--fix', fix.toFixed(3));
      } else {
        document.documentElement.style.setProperty('--fix', '1');
      }
    }

    // Garantizar el factor de escala correcto antes de cualquier interacción
    applyScaleFix();

    function sizeHeaderImage(){
      var img = document.getElementById('headerImg');
      var wrapper = document.querySelector('.wrapper');
      if (!img || !wrapper) return;
      var avail = Math.floor(wrapper.clientWidth);
      if (avail > 0) {
        img.style.width = avail + 'px';
        img.style.maxWidth = '100%';
        img.removeAttribute('height');
      }
    }

    function getWebAppBaseUrl(){
      var base = '';
      if (typeof window !== 'undefined'){
        base = window.webAppUrl || window.SECO_WEBAPP_BASE_URL || '';
      }
      if (!base){
        var path = window.location.pathname || '';
        var origin = window.location.origin || '';
        base = origin + path;
      }
      return base;
    }

    function buildWebAppUrl(pageName){
      var base = getWebAppBaseUrl();

      var params = new URLSearchParams();
      params.set('page', pageName);

      return `${base}?${params.toString()}`;
    }

    function isSidebarContext(){
      var hasHostClose = (typeof google !== 'undefined'
        && google.script
        && google.script.host
        && typeof google.script.host.close === 'function');

      return hasHostClose && window.top !== window.self;
    }

    function openInBrowser(pageName){
      go(pageName);
    }

    function setButtonLoading(btn, isLoading){
      if (!btn) return;
      if (isLoading){
        if (!btn.dataset.originalHtml){
          btn.dataset.originalHtml = btn.innerHTML;
        }
        btn.disabled = true;
        btn.innerHTML = '...';
      } else {
        btn.disabled = false;
        if (btn.dataset.originalHtml){
          btn.innerHTML = btn.dataset.originalHtml;
        }
      }
    }

    var ctxCache = null;
    function obtenerCtxServidor(){
      if (ctxCache) return ctxCache;
      if (typeof window !== 'undefined' && window.SECO_CTX) {
        ctxCache = window.SECO_CTX;
        return ctxCache;
      }
      return null;
    }

    function cuandoCtxListo(callback, intento){
      var ctx = obtenerCtxServidor();
      if (ctx){
        callback(ctx);
        return;
      }
      var intentoActual = intento || 0;
      if (intentoActual >= 50) return;
      setTimeout(function(){
        cuandoCtxListo(callback, intentoActual + 1);
      }, 80);
    }

    function renderVentaId(){
      var el = document.getElementById('ventaIdHeader');
      if (!el) return;
      var ctx = obtenerCtxServidor();
      var idVenta = (ctx && ctx.idVenta) ? ctx.idVenta : '';
      if (idVenta){
        el.textContent = idVenta;
      }
    }

    function parsePrecio(){
      var input = document.getElementById('precio');
      var raw = (input && input.value ? input.value.trim() : '');
      raw = raw.replace(',', '.');
      var precio = parseFloat(raw);
      if (!isFinite(precio) || precio <= 0){
        return NaN;
      }
      return precio;
    }

    /* ===== CALCUL TOTAL + BOUTON ===== */
    function updateTotalYBoton(){
      var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
      var totalEl = document.getElementById('totalMonto');
      var btn = document.getElementById('btnRegistrar');

      var precio = parsePrecio();

      var cantidad = 1;
      if (ddCantidad){
        var val = ddCantidad.dataset.value || '';
        var m = val.match(/^(\d+)/);
        if (m){
          cantidad = parseInt(m[1], 10);
        }
      }
      if (!isFinite(cantidad) || cantidad < 1) cantidad = 1;

      var total = 0;
      if (isFinite(precio)){
        total = precio * cantidad;
      }

      if (totalEl){
        var txt = (isFinite(total) ? total : 0).toFixed(2).replace('.', ',') + ' $';
        totalEl.textContent = txt;
      }

      var ok = isFinite(precio);
      if (btn){
        btn.disabled = !ok;
        btn.classList.toggle('btn-noir', ok);
        btn.classList.toggle('btn-desactive', !ok);
      }
    }

    var formatTimeout = null;
    function programarFormateoPrecio(){
      if (formatTimeout){
        clearTimeout(formatTimeout);
      }
      formatTimeout = setTimeout(formatearPrecio, 2000);
    }

    function formatearPrecio(){
      formatTimeout = null;
      var input = document.getElementById('precio');
      if (!input) return;
      var precio = parsePrecio();
      if (!isFinite(precio) || precio <= 0) return;
      var txt = precio.toFixed(2).replace('.', ',') + ' $';
      input.value = txt;
      updateTotalYBoton();
    }

    /* ===== DROPDOWN ===== */
    var overlayList, currentDropdown = null;

    function openOverlayFor(dropdown){
      currentDropdown = dropdown;
      overlayList.className = 'dd-overlay-list';
      overlayList.innerHTML = "";

      var button = dropdown.querySelector('.dd-button');
      var label  = dropdown.querySelector('.dd-label');

      var dataEl = dropdown.querySelector('.dd-data');
      var items = [];
      if (dataEl){
        try { items = JSON.parse(dataEl.textContent.trim() || "[]"); } catch(e){ items = []; }
      }

      var placeholderText = dropdown.dataset.ph || label.textContent.trim() || 'Seleccionar';
      var liPh = document.createElement('li');
      liPh.className = 'dd-overlay-option placeholder';
      liPh.setAttribute('role','option');
      liPh.textContent = placeholderText;
      liPh.addEventListener('click', function(){
        label.textContent = placeholderText;
        button.setAttribute('data-placeholder','true');
        dropdown.dataset.value = '';
        closeOverlay();
        setTimeout(()=>button.focus({preventScroll:true}),0);
        updateTotalYBoton();
      });
      overlayList.appendChild(liPh);

      items.forEach(function(txt){
        var li = document.createElement('li');
        li.className = 'dd-overlay-option';
        li.setAttribute('role','option');
        li.textContent = txt;
        li.addEventListener('click', function(){
          label.textContent = txt;
          button.removeAttribute('data-placeholder');
          dropdown.dataset.value = txt;
          closeOverlay();
          setTimeout(()=>button.focus({preventScroll:true}),0);
          updateTotalYBoton();
        });
        overlayList.appendChild(li);
      });

      document.getElementById('ddOverlay').setAttribute('data-open','true');
      document.body.style.overflow = 'hidden';
    }

    function closeOverlay(){
      document.getElementById('ddOverlay').setAttribute('data-open','false');
      document.body.style.overflow = '';
      currentDropdown = null;
    }

    function setupDropdown(dropdown){
      var button = dropdown.querySelector('.dd-button');
      var label  = dropdown.querySelector('.dd-label');

      var phText = label.textContent.trim() || 'Seleccionar';
      dropdown.dataset.ph = phText;

      if (button.hasAttribute('data-placeholder')){
        dropdown.dataset.value = '';
      } else {
        dropdown.dataset.value = label.textContent.trim();
      }

      button.addEventListener('click', function(){
        openOverlayFor(dropdown);
      });
      button.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' '){
          e.preventDefault();
          openOverlayFor(dropdown);
        }
      });
    }

    function initDropdowns(){
      document.querySelectorAll('.dropdown').forEach(setupDropdown);
      overlayList = document.getElementById('ddOverlayList');

      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape' && document.getElementById('ddOverlay').getAttribute('data-open') === 'true'){
          closeOverlay();
        }
      });

      document.getElementById('ddOverlay').addEventListener('click', function(e){
        if (e.target === e.currentTarget) closeOverlay();
      });
    }

    function init(){
      applyScaleFix();
      sizeHeaderImage();
      initDropdowns();

      var input = document.getElementById('precio');
      if (input){
        input.addEventListener('input', function(){
          updateTotalYBoton();
          programarFormateoPrecio();
        });
        input.addEventListener('blur', formatearPrecio);
      }

      var btnRegistrar = document.getElementById('btnRegistrar');
      if (btnRegistrar){
        btnRegistrar.addEventListener('click', function(evt){
          if (evt && typeof evt.preventDefault === 'function') evt.preventDefault();
          if (btnRegistrar.disabled) return;
          var precio = parsePrecio();
          var ddCantidad = document.querySelector('.dropdown[data-name="cantidad"]');
          var cantidad = 1;
          if (ddCantidad){
            var val = ddCantidad.dataset.value || '';
            var m = val.match(/^(\d+)/);
            if (m){
              cantidad = parseInt(m[1], 10);
            }
          }
          if (!isFinite(cantidad) || cantidad < 1) cantidad = 1;

          setButtonLoading(btnRegistrar, true);
          google.script.run
            .withSuccessHandler(function(resp){
              setButtonLoading(btnRegistrar, false);
              if (!resp || !resp.ok){
                alert((resp && resp.error) || 'No se pudo registrar la venta.');
                return;
              }
            })
            .withFailureHandler(function(err){
              setButtonLoading(btnRegistrar, false);
              alert('No se pudo registrar la venta directa.');
            })
            .registrarVentaDirectaDesdeUI({
              cantidad: cantidad,
              precio: precio
            });
        });
      }

      var btnVolver = document.getElementById('btnVolver');
      if (btnVolver){
        btnVolver.addEventListener('click', function(){
          go('inicio');
        });
      }

      cuandoCtxListo(function(){
        renderVentaId();
      });

      updateTotalYBoton();
    }

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

    window.addEventListener('resize', function(){
      applyScaleFix();
      sizeHeaderImage();
    });
  </script>
</body>
</html>
